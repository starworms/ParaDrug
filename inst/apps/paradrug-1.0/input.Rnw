
\documentclass[11pt, oneside]{article}   	
\usepackage[english]{babel}
\usepackage[utf8]{inputenc}
\usepackage{fancyhdr}
\usepackage{graphicx}
\usepackage{xcolor}
\pagestyle{fancy}
\fancyhf{}
%\lhead{Report}
\rfoot{Page \thepage}
%\rhead{\includegraphics [width=2cm]{logo.pdf}}
\begin{document}
<<echo=FALSE>>=
Dis <- ifelse(input$NTD == 1, 'Schistosomiasis', 'Soil-transmitted helminthiasis')
Drug <- ifelse(input$NTD == 1 & input$Sdrug == 1, 'praziquantel (40 mg/kg)', ifelse(input$NTD == 2 & input$STHdrug == 1,'albendazole (400 mg)', ifelse(input$NTD == 2 & input$STHdrug == 2, 'mebendazole (500 mg)', 'an alternative drug')))
Country <- ifelse(input$Country =='', 'a not further specified country', input$Country)
Name <- ifelse(input$Name =='', 'Unknown', input$Name)
Region <- ifelse(input$Region =='', 'district/province not further specified', input$Region)
@


\begin{titlepage}
    \begin{center}
    \LARGE 
        \textbf{The efficacy of \Sexpr{Drug} against \Sexpr{Dis} in \Sexpr{Country} (\Sexpr{Region}):} \par    
         \vspace{1cm}
        {\LARGE A ParaDrug 1.0 drug efficacy report \par}
        \vspace{1cm}
        {\large by \Sexpr{Name}\par}
        \vspace{6cm}
        {\large ParaDrug 1.0 was developped by Bruno Levecke (Ghent University). The development of ParaDrug 1.0 was financed by the Bill and Melinda Gates Foundation \par} 
        {\large www.starworms.org\par}
        \includegraphics[width=0.55\textwidth]{combo2check.jpg}\par
    \end{center}
\end{titlepage}
\tableofcontents
\section{Background}
Schistosomiasis ($Schistosoma$ $haematobium$, $S$. $mansoni$, $S.$ $japonicum$) and $S.$ $mekongi$) and soil-transmitted helmintiasis (STH), including roundworms ($Ascaris$ $lumbricoides$), whipworms ($Trichuris$ $trichiura$), hookworms ($Ancylostoma$ $duodenale$ and $Necator$ $americanus$) are among the most prevalent neglected tropical diseases. To fight against these worms, large-scale deworming programs are implemented in which anthelmintic drugs are administered. These pledges of drug donations are at place, but this world wide upscale of deworming programs also creates the need for thoroughly designed monitoring systems that allow detection of any changes in anthelmintic drug efficacy that may arise through the evolution of anthelmintic drug resistance in these worms. This is in particular when there is a paucity of anthelmintic drugs licensed for the treatment of worm infections in humans. Therefore, the WHO has recently developped guidelines on how to assess drug efficacy of anthelmnthic drugs used against schistosomiasis and soil-transmitted helminthiasis.
This document reports the results of a trial designed to assess the efficacy of \Sexpr{Country} against \Sexpr{Dis} in \Sexpr{Country} (\Sexpr{Region}). 
The raw data were up-loaded by \Sexpr{Name} at ParaDesign, which subsequently genenerated this customized drug efficacy report. ParaDesign was developped by Ghent University. The development of ParaDesign was financially supported by the Bill and Melinda Gates Foundation.
      
\section{Results}
\subsection{Number of subjects}
<<echo=FALSE>>=
     inFile <- input$file1
      if (is.null(inFile))
      {number <- paste0('Data was not provided.')
        } else {if (input$NTD=='1')
            {data <- read.xlsx(inFile$datapath,1)
              data$n <- 1
              n <- length(data[,1])
              # S haematobium
              data$sh <- ifelse(input$Shbas=='Not recorded',rep(-2,n), ifelse(data[,input$Shbas]>0,1,0))
              data$shF <- ifelse(input$Shfol=='Not recorded',rep(-2,n), ifelse(data[,input$Shfol]>=0,1,0))
              data$shC <- ifelse(data$sh == 1 & data$shF == 1,1,0)
              
              # S mansoni
              data$sm <- ifelse(input$Smbas=='Not recorded',rep(-2,n), ifelse(data[,input$Smbas]>0,1,0))
              data$smF <- ifelse(input$Smfol=='Not recorded',rep(-2,n), ifelse(data[,input$Smfol]>=0,1,0))
              data$smC <- ifelse(data$sm == 1 & data$smF == 1,1,0)
              
              # S japonicum
              data$sj <- ifelse(input$Sjbas=='Not recorded',rep(-2,n), ifelse(data[,input$Sjbas]>0,1,0))
              data$sjF <- ifelse(input$Sjfol=='Not recorded',rep(-2,n), ifelse(data[,input$Sjfol]>=0,1,0))
              data$sjC <- ifelse(data$sj == 1 & data$sjF == 1,1,0)
              
              data$inf <- mean(ifelse(data$sh > -2 | data$sm > -2 | data$sj > -2, 1, 0))
              
              if(mean(data$inf)==0) {number <- paste0('Data was not provided.')
                } else {
                if(mean(data$sh)>-2 & mean(data$sm)>-2 & mean(data$shF)>-2 & mean(data$smF)>-2)
                   {
                  data$shB <-  data[,input$Shbas]  
                  data$smB <-  data[,input$Smbas] 
                  data$shF <-  data[,input$Shfol]  
                  data$smF <-  data[,input$Smfol] 
                  data$shp <- ifelse(data$shB>0,1,0) 
                  data$smp <- ifelse(data$smB>0,1,0)
                  data$shf <- ifelse(data$shF>=0,1,0) 
                  data$smf <- ifelse(data$smF>=0,1,0) 
                  data$shc <- data$shp + data$shf
                  data$smc <- data$smp + data$smf
                  data$com <- data$shc + data$smc
                  mix <- dim(subset(data, smB>0 & shB>0))[1]
                  com <- dim(subset(data, shc==2 | smc ==2))[1]
                  nsm <- dim(subset(data, smB>0))[1]
                  nsm2 <- dim(subset(data, smB>0 & smF>=0))[1]
                  nsh <- dim(subset(data,shB>0))[1]
                  nsh2 <- dim(subset(data, shB>0 & shF>=0))[1]
                  number <- paste0('In total, ', n, ' subjects enrolled this drug efficacy trial. 
S. haematobium infections were observed in ', nsh, ' subjects (', round(100*nsh/n,1), ' percent), 
S. mansoni in ', nsm, ' cases (', round(100*nsm/n,1),' percent). Mixed Schistosoma infections 
                          were observed in ', mix, ' subjects (', round(100*mix/n,1), ' percent). 
                        In total ,', com, ' infected subjects provided a sample at both baseline and follow-up, 
                        including ', nsh2, ' cases of S. haematobium, and ', nsm2, ' cases of S. mansoni.')
                   }
                else{
                  if(mean(data$sh)>-2 & mean(data$shF)>-2)
                  {
                    data$shB <-  data[,input$Shbas]  
                    data$shF <-  data[,input$Shfol]  
                    data$shp <- ifelse(data$shB>0,1,0) 
                    data$shf <- ifelse(data$shF>=0,1,0) 
                    data$shc <- data$shp + data$shf
                    nsh <- dim(subset(data,shB>0))[1]
                    nsh2 <- dim(subset(data, shB>0 & shF>=0))[1]
                    number <- paste0('In total ,', n, ' subjects enrolled this drug efficacy trial. S. haematobium infections were observed in ', nsh, ' subjects (', round(100*nsh/n,1), ' percent). In total, ', nsh2, ' infected subjects provided a sample at both baseline and follow-up.')
                    }
                    else{
                    if(mean(data$sm)>-2 & mean(data$smF)>-2){
                      data$smB <-  data[,input$Smbas] 
                      data$smF <-  data[,input$Smfol] 
                      data$smp <- ifelse(data$smB>0,1,0)
                      data$smf <- ifelse(data$smF>=0,1,0) 
                      data$smc <- data$smp + data$smf
                      nsm <- dim(subset(data, smB>0))[1]
                      nsm2 <- dim(subset(data, smB>0 & smF>=0))[1]
                      number <- paste0('In total ,', n, ' subjects enrolled this drug efficacy trial. S. mansoni infections were observed in ', nsm, ' subjects (', round(100*nsm/n,1), ' percent). In total, ', nsm2, ' infected subjects provided a sample at both baseline and follow-up.')
                      
                      }
                    else{
                      if(mean(data$sj)>-2 & mean(data$sjF>-2)){
                        data$sjB <-  data[,input$Sjbas] 
                        data$sjF <-  data[,input$Sjfol] 
                        data$sjp <- ifelse(data$sjB>0,1,0)
                        data$sjf <- ifelse(data$sjF>=0,1,0) 
                        data$sjc <- data$sjp + data$sjf
                        nsj <- dim(subset(data, sjB>0))[1]
                        nsj2 <- dim(subset(data, sjB>0 & sjF>=0))[1]
                        number <- paste0('In total, ', n, ' subjects enrolled this drug efficacy trial. S. japonicum infections were observed in ', nsj, ' subjects (', round(100*nsj/n,1), ' percent). In total, ', nsj2, ' infected subjects provided a sample at both baseline and follow-up.')
                        
                        
                        }
                      else{number <- paste0('Data was not provided.')}  
                        }   
                      }
                    } 
                   }
              }
           else {
# Soil-transmitted helminthiasis
             if (input$NTD=='2')
             {
             data <- read.xlsx(inFile$datapath,1)
             n <- length(data[,1])
             # roundworms
             data$Rb <- ifelse(input$Rbas=='Not recorded',rep(-2,n), ifelse(data[,input$Rbas]>0,1,0))
             data$Rf <- ifelse(input$Rfol=='Not recorded',rep(-2,n), ifelse(data[,input$Rfol]>=0,1,0))
             data$Rc <- ifelse(data$Rb == 1 & data$Rf == 1,1,0)
            
             # whipworms
             data$Tb <- ifelse(input$Tbas=='Not recorded',rep(-2,n), ifelse(data[,input$Tbas]>0,1,0))
             data$Tf <- ifelse(input$Tfol=='Not recorded',rep(-2,n), ifelse(data[,input$Tfol]>=0,1,0))
             data$Tc <- ifelse(data$Tb == 1 & data$Tf == 1,1,0)
             
             # hookworms
             data$Hb <- ifelse(input$Hbas=='Not recorded',rep(-2,n), ifelse(data[,input$Hbas]>0,1,0))
             data$Hf <- ifelse(input$Hfol=='Not recorded',rep(-2,n), ifelse(data[,input$Hfol]>=0,1,0))
             data$Hc <- ifelse(data$Hb == 1 & data$Hf == 1,1,0)
             
             data$inf <- ifelse(data$Rb > -2 | data$Tb > -2 | data$Hb > -2, 1, 0)
             
             if(mean(data$inf)==0) {number <- paste0('Data was not provided.')}
             else {
               if(mean(data$Rb)>-2 & mean(data$Tb)>-2 & mean(data$Hb)>-2 & mean(data$Rf)>-2 & mean(data$Tf)>-2 & mean(data$Hf)>-2)
               {
                 data$RB <-  data[,input$Rbas]  
                 data$TB <-  data[,input$Tbas] 
                 data$HB <-  data[,input$Hbas] 
                 
                 data$RF <-  data[,input$Rfol]  
                 data$TF <-  data[,input$Tfol]
                 data$HF <-  data[,input$Hfol]
                 
                 data$Rp <- ifelse(data$RB>0,1,0) 
                 data$Tp <- ifelse(data$TB>0,1,0)
                 data$Hp <- ifelse(data$HB>0,1,0)
                 
                 data$Rf <- ifelse(data$RF>=0,1,0) 
                 data$Tf <- ifelse(data$TF>=0,1,0) 
                 data$Hf <- ifelse(data$HF>=0,1,0) 
                 
                 data$Rc <- data$Rp + data$Rf
                 data$Tc <- data$Tp + data$Tf
                 data$Hc <- data$Hp + data$Hf
                 data$mix <- data$Rp + data$Tp + data$Hp
                 mix <- dim(subset(data,mix>1))[1]
                 com <- dim(subset(data, Rc==2 | Tc ==2 | Hc ==2))[1]
                 nR <- dim(subset(data, RB>0))[1]
                 nR2 <- dim(subset(data, RB>0 & RF>=0))[1]
                 nT <- dim(subset(data, TB>0))[1]
                 nT2 <- dim(subset(data, TB>0 & TF>=0))[1]
                 nH <- dim(subset(data, HB>0))[1]
                 nH2 <- dim(subset(data, HB>0 & HF>=0))[1]
                 
                 number <- paste0('In total, ', n, ' subjects enrolled this drug efficacy trial. Roundworm infections were observed in ', nR, ' subjects (', round(100*nR/n,1), ' percent), whipworm infections in ', nT, ' cases (', round(100*nT/n,1),' percent) and hookworms in ', nH, ' (',round (100*nH/n,1),' percent). Mixed STH infections were observed in ', mix, ' subjects (', round(100*mix/n,1), ' percent). In total, ', com, ' infected subjects provided a sample at both baseline and follow-up, including ', nR2, ' cases of roundworms, ', nT2, ' cases of whipworms, and ',nH2, ' cases of hookworms.')
               }
               else{ 
                 if(mean(data$Rb)>-2 & mean(data$Tb)>-2 & mean(data$Rf)>-2 & mean(data$Tf)>-2)
                 {
                   data$RB <-  data[,input$Rbas]  
                   data$TB <-  data[,input$Tbas] 
                   
                   data$RF <-  data[,input$Rfol]  
                   data$TF <-  data[,input$Tfol]
                   
                   data$Rp <- ifelse(data$RB>0,1,0) 
                   data$Tp <- ifelse(data$TB>0,1,0)
                   
                   data$Rf <- ifelse(data$RF>=0,1,0) 
                   data$Tf <- ifelse(data$TF>=0,1,0) 
                   
                   data$Rc <- data$Rp + data$Rf
                   data$Tc <- data$Tp + data$Tf

                   data$mix <- data$Rp + data$Tp
                   mix <- dim(subset(data, mix>1))[1]
                   com <- dim(subset(data, Rc==2 | Tc ==2))[1]
                   nR <- dim(subset(data, RB>0))[1]
                   nR2 <- dim(subset(data, RB>0 & RF>=0))[1]
                   nT <- dim(subset(data, TB>0))[1]
                   nT2 <- dim(subset(data, TB>0 & TF>=0))[1]
                   
                   number <- paste0('In total, ', n, ' subjects enrolled this drug efficacy trial. Roundworm infections were observed in ', nR, ' subjects (', round(100*nR/n,1), ' percent), whipworm infections in ', nT, ' cases (', round(100*nT/n,1),' percent). Mixed STH infections were observed in ', mix, 'subjects (', round(100*mix/n,1), ' percent). In total, ', com, ' infected subjects provided a sample at both baseline and follow-up, including ', nR2, ' cases of roundworms, and ', nT2, ' cases of whipworms.')
                  }
                 else{
                   if(mean(data$Rb)>-2 & mean(data$Hb)>-2 & mean(data$Rf)>-2 & mean(data$Hf)>-2)
                     {
                     data$RB <-  data[,input$Rbas]  
                     data$HB <-  data[,input$Hbas] 
                     
                     data$RF <-  data[,input$Rfol]  
                     data$HF <-  data[,input$Hfol]
                     
                     data$Rp <- ifelse(data$RB>0,1,0) 
                     data$Hp <- ifelse(data$HB>0,1,0)
                     
                     data$Rf <- ifelse(data$RF>=0,1,0) 
                     data$Hf <- ifelse(data$HF>=0,1,0) 
                     
                     data$Rc <- data$Rp + data$Rf
                     data$Hc <- data$Hp + data$Hf
                     
                     data$mix <- data$Rp + data$Hp
                     mix <- dim(subset(data, mix>1))[1]
                     com <- dim(subset(data, Rc==2 | Hc ==2))[1]
                     nR <- dim(subset(data, RB>0))[1]
                     nR2 <- dim(subset(data, RB>0 & RF>=0))[1]
                     nH <- dim(subset(data, HB>0))[1]
                     nH2 <- dim(subset(data, HB>0 & HF>=0))[1]
                     
                     number <- paste0('In total, ', n, ' subjects enrolled this drug efficacy trial. Roundworms infections were observed in ', nR, ' subjects (', round(100*nR/n,1), ' percent), hookworm infections in ', nH, ' cases (', round(100*nH/n,1),' percent). Mixed STH infections were observed in ', mix, ' subjects (', round(100*mix/n,1), ' percent). In total, ', com, ' infected subjects provided a sample at both baseline and follow-up, including ', nR2, ' cases of roundworms, and ', nH2, ' cases of hookworms.')
                   }
                   else{
                     if(mean(data$Tb)>-2 & mean(data$Hb)>-2 & mean(data$Tf)>-2 & mean(data$Hf)>-2){
                       data$TB <-  data[,input$Tbas]  
                       data$HB <-  data[,input$Hbas] 
                       
                       data$TF <-  data[,input$Tfol]  
                       data$HF <-  data[,input$Hfol]
                       
                       data$Tp <- ifelse(data$TB>0,1,0) 
                       data$Hp <- ifelse(data$HB>0,1,0)
                       
                       data$Tf <- ifelse(data$TF>=0,1,0) 
                       data$Hf <- ifelse(data$HF>=0,1,0) 
                       
                       data$Tc <- data$Tp + data$Tf
                       data$Hc <- data$Hp + data$Hf
                       
                       data$mix <- data$Tp + data$Hp
                       mix <- dim(subset(data,mix>1))[1]
                       com <- dim(subset(data, Tc ==2 | Hc ==2))[1]
                       nT <- dim(subset(data, TB>0))[1]
                       nT2 <- dim(subset(data, TB>0 & TF>=0))[1]
                       nH <- dim(subset(data, HB>0))[1]
                       nH2 <- dim(subset(data, HB>0 & HF>=0))[1]
                       
                       number <- paste0('In total, ', n, ' subjects enrolled this drug efficacy trial. Whipworm infections were observed in ', nT, ' subjects (', round(100*nT/n,1), ' percent), hookworm infections in ', nH, ' cases (', round(100*nH/n,1),' percent). Mixed STH infections were observed in ', mix, ' subjects (', round(100*mix/n,1), ' percent). In total, ', com, ' infected subjects provided a sample at both baseline and follow-up, including ', nT2, ' cases of whipworms, and ', nH2, ' cases of hookworms.')
                     }
                     else{
                       if(mean(data$Rb)>-2 & mean(data$Rf)>-2){
                         data$RB <-  data[,input$Rbas]  
                         data$RF <-  data[,input$Rfol]  
                         nR <- dim(subset(data, RB>0))[1]
                         nR2 <- dim(subset(data, RB>0 & RF>=0))[1]
                          number <- paste0('In total, ', n, ' subjects enrolled this drug efficacy trial. Roundworms infections were observed in ', nR, ' subjects (', round(100*nR/n,1), ' percent). In total, ', nR2, ' infected subjects provided a sample at both baseline and follow-up.')
                         }
                          else{
                            if(mean(data$Tb)>-2 & mean(data$Tf)>-2){
                              data$TB <-  data[,input$Tbas]  
                              data$TF <-  data[,input$Tfol]  
                              nT <- dim(subset(data, TB>0))[1]
                              nT2 <- dim(subset(data, TB>0 & TF>=0))[1]
                              number <- paste0('In total, ', n, ' subjects enrolled this drug efficacy trial. Whipworms infections were observed in ', nT, ' subjects (', round(100*nT/n,1), ' percent). In total, ', nT2, ' infected subjects provided a sample at both baseline and follow-up.')
                            }
                            
                            else{
                              if(mean(data$Hb)>-2 & mean(data$Hf)>-2){
                                data$HB <-  data[,input$Hbas]  
                                data$HF <-  data[,input$Hfol]  
                                data$Hp <- ifelse(data$HB>0,1,0) 
                                data$Hf <- ifelse(data$HF>=0,1,0) 
                                data$Hc <- data$Hp + data$Hf
                                nH <- dim(subset(data, HB>0))[1]
                                nH2 <- dim(subset(data, HB>0 & HF>=0))[1]
                                number <- paste0('In total ,', n, ' subjects enrolled this drug efficacy trial. Hookworms infections were observed in ', nH, ' subjects (', round(100*nH/n,1), ' percent). In total, ', nH2, ' infected subjects provided a sample at both baseline and follow-up.')
                              }
                              else{paste('Please match egg counting data.')}
                              }
                          }
                         }  
                       }   
                    }
                  } 
                }
             }
                }
          } 
  
@
\Sexpr{number}

\subsection{Intensity of infections}
<<echo=FALSE>>=
    inFile <- input$file1
    if (is.null(inFile))
    {intense <- paste0('Data was not provided.')
      } else {if (input$NTD=='1')
    {data <- read.xlsx(inFile$datapath,1)
    n <- length(data[,1])
    # S haematobium
    data$sh <- ifelse(input$Shbas=='Not recorded',rep(-2,n), ifelse(data[,input$Shbas]>0,1,0))
    data$shF <- ifelse(input$Shfol=='Not recorded',rep(-2,n), ifelse(data[,input$Shfol]>=0,1,0))
    
    # S mansoni
    data$sm <- ifelse(input$Smbas=='Not recorded',rep(-2,n), ifelse(data[,input$Smbas]>0,1,0))
    data$smF <- ifelse(input$Smfol=='Not recorded',rep(-2,n), ifelse(data[,input$Smfol]>=0,1,0))

    
    # S japonicum
    data$sj <- ifelse(input$Sjbas=='Not recorded',rep(-2,n), ifelse(data[,input$Sjbas]>0,1,0))
    data$sjF <- ifelse(input$Sjfol=='Not recorded',rep(-2,n), ifelse(data[,input$Sjfol]>=0,1,0))

    data$inf <- mean(ifelse(data$sh > -2 | data$sm > -2 | data$sj > -2, 1, 0))
    
    if(mean(data$inf)==0) {intense <- paste0('Data was not provided.')}
    else {
      if(mean(data$sh)>-2 & mean(data$sm)>-2 & mean(data$smF)>-2 & mean(data$shF> - 2))
      {
      data$shB <-  data[,input$Shbas]  
      data$smB <-  data[,input$Smbas] 
      data$shF <-  data[,input$Shfol]  
      data$smF <-  data[,input$Smfol] 
      sh <- subset(data, shB >0 &  shF >=0)
      sm <- subset(data, smB >0 &  smF >=0)
      NshH <- sum(ifelse(sh$shB>=50,1,0))
      NshL <- sum(ifelse(sh$shB>=1 & sh$shB<50,1,0))
      
      NsmH <- sum(ifelse(sm$smB>=400,1,0))
      NsmM <- sum(ifelse(sm$smB>=100 & sm$smB<400,1,0))
      NsmL <- sum(ifelse(sm$smB>=1 & sm$smB<100,1,0))
      q25sh <- round(quantile(sh$shB, probs=c(0.25)),1)
      q75sh <- round(quantile(sh$shB, probs=c(0.75)),1)
      
      q25sm <- round(quantile(sm$smB, probs=c(0.25)),1)
      q75sm <- round(quantile(sm$smB, probs=c(0.75)),1)
     
      Msm <- round(mean(sm$smB),1)
      Msh <- round(mean(sh$shB),1)
      
      nsm <- length(sm$smB)
      nsh <- length(sh$shB)
intense <- paste0('The distribution of the baseline egg counts across the subjects who completed the trial is illustrated in the figures below. The mean (25th quantile; 75th quantile) S. haematobium egg counts equalled ',Msh,' (',q25sh,';',q75sh,') eggs per 10 ml of urine. The mean S. mansoni egg counts equalled ',Msm,' (',q25sm,';',q75sm,') eggs per gram of stool. Low and heavy S. haematobium intensity infections were observed in ', NshL,' (',round(100*NshL/nsh,1),' percent), and ', NshH, ' (',round(100*NshH/nsh,1),' percent) cases, respectively. For S. mansoni, the number of low, moderate and heavy intensity infections were ', NsmL,' (',round(100*NsmL/nsm,1),' percent), ', NsmM,' (',round(100*NsmM/nsm,1),' percent) and ', NsmH, ' (',round(100*NsmH/nsm,1),' percent), respectively.')
      }
      else{ 
        if(mean(data$sh)>-2 & mean(data$shF >-2)){
          data$shB <-  data[,input$Shbas] 
          data$shF <-  data[,input$Shfol] 
          sh <- subset(data, shB >0 &  shF >=0)
          NshH <- sum(ifelse(sh$shB>=50,1,0))
          NshL <- sum(ifelse(sh$shB>=1 & sh$shB<50,1,0))
          q25sh <- round(quantile(sh$shB, probs=c(0.25)),1)
          q75sh <- round(quantile(sh$shB, probs=c(0.75)),1)
          Msh <- round(mean(sh$shB),1)
          nsh <- length(sh$shB)

          intense <- paste0('The distribution of the baseline egg counts across the subjects who completed the trial is illustrated in the figure below. The mean (25th quantile; 75th quantile) S. haematobium egg counts equalled ',Msh,' (',q25sh,';',q75sh,') eggs per 10 ml of urine. Low and heavy  intensity infections of S. haematobium were observed in ', NshL,' (',round(100*NshL/nsh,1),' percent), and ', NshH, ' (',round(100*NshH/nsh,1),' percent) cases, respectively.')
        }
        else{
          if(mean(data$sm)>-2 & mean(data$smF)> -2){
            data$smB <-  data[,input$Smbas] 
            data$smF <-  data[,input$Smfol] 
            sm <- subset(data, smB >0 &  smF >=0)
            NsmH <- sum(ifelse(sm$smB>=400,1,0))
            NsmM <- sum(ifelse(sm$smB>=100 & sm$smB<400,1,0))
            NsmL <- sum(ifelse(sm$smB>=1 & sm$smB<100,1,0))
            q25sm <- round(quantile(sm$smB, probs=c(0.25)),1)
            q75sm <- round(quantile(sm$smB, probs=c(0.75)),1)
            Msm <- round(mean(sm$smB),1)
            nsm <- length(sm$smB)
            intense <- paste0('The distribution of the baseline egg counts across the subjects who completed the trial is illustrated in the figure below. The mean (25th quantile; 75th quantile) S. mansoni egg counts equalled ',Msm,' (',q25sm,';',q75sm,') eggs per gram of stool. Low, moderate and heavy intensity infections of S. mansoni were observed in ',NsmL,' (',round(100*NsmL/nsm,1),' percent),', NsmM,' (',round(100*NsmM/nsm,1),' percent) and ', NsmH, ' (',round(100*NsmH/nsm,1),' percent) cases, respectively.')
          }
          else{
            if(mean(data$sj)>-2 & mean(data$sjF) >- 2){
              data$sjB <-  data[,input$Sjbas] 
              data$sjF <-  data[,input$Sjfol] 
              sj <- subset(data, sjB >0 &  sjF >=0)
              NsjH <- sum(ifelse(sj$sjB>=400,1,0))
              NsjM <- sum(ifelse(sj$sjB>=100 & sj$sjB<400,1,0))
              NsjL <- sum(ifelse(sj$sjB>=1 & sj$sjB<100,1,0))
              q25sj <- round(quantile(sj$sjB, probs=c(0.25)),1)
              q75sj <- round(quantile(sj$sjB, probs=c(0.75)),1)
              Msj <- round(mean(sj$sjB),1)
              nsj <- length(sj$sjB)
              intense <- paste0('The distribution of the baseline egg counts across the subjects who completed the trial is illustrated in the figure below. The mean (25th quantile; 75th quantile) S. japonicum egg counts equalled ',Msj,' (',q25sj,';',q75sj,') eggs per gram of stool. Low, moderate and heavy intensity infections of S. japonicum were observed in ',NsjL,' (',round(100*NsjL/nsj,1),' percent), ', NsjM,' (',round(100*NsjM/nsj,1),' percent) and ', NsjH, ' (',round(100*NsjH/nsj,1),' percent) cases, respectively.')
            }
            else{intense <- paste0('Data was not provided.')}  
          }   
        }
      } 
      }
    }
      else {
        # Number of cases of soil-transmitted helminthiasis
        if (input$NTD=='2')
        {
        data <- read.xlsx(inFile$datapath,1)
        n <- length(data[,1])
        # roundworms
        data$Rb <- ifelse(input$Rbas=='Not recorded',rep(-2,n), ifelse(data[,input$Rbas]>0,1,0))
        data$Rf <- ifelse(input$Rfol=='Not recorded',rep(-2,n), ifelse(data[,input$Rfol]>=0,1,0))

        # whipworms
        data$Tb <- ifelse(input$Tbas=='Not recorded',rep(-2,n), ifelse(data[,input$Tbas]>0,1,0))
        data$Tf <- ifelse(input$Tfol=='Not recorded',rep(-2,n), ifelse(data[,input$Tfol]>=0,1,0))
        
        # hookworms
        data$Hb <- ifelse(input$Hbas=='Not recorded',rep(-2,n), ifelse(data[,input$Hbas]>0,1,0))
        data$Hf <- ifelse(input$Hfol=='Not recorded',rep(-2,n), ifelse(data[,input$Hfol]>=0,1,0))
        
        data$inf <- ifelse(data$Rb > -2 | data$Tb > -2 | data$Hb > -2, 1, 0)
        
        if(mean(data$inf)==0) {intense <- paste0('Data was not provided.')}
        else {
          
          if(mean(data$Rb)>-2 & mean(data$Tb)>-2 & mean(data$Hb)>-2 & mean(data$Rf)>-2 & mean(data$Tf)>-2 & mean(data$Hf)>-2)
          {
            data$RB <-  data[,input$Rbas]  
            data$TB <-  data[,input$Tbas]
            data$HB <-  data[,input$Hbas] 
            data$RF <-  data[,input$Rfol]  
            data$TF <-  data[,input$Tfol] 
            data$HF <-  data[,input$Hfol] 
            R <- subset(data, RB> 0 & RF >= 0)
            Tr <- subset(data, TB> 0 & TF >= 0)
            H <- subset(data, HB> 0 & HF >= 0)
            
            NRH <- sum(ifelse(R$RB>=10000,1,0))
            NRM <- sum(ifelse(R$RB>=1000 & R$RB<10000,1,0))
            NRL <- sum(ifelse(R$RB>=1 & R$RB<1000,1,0))
            
            NTH <- sum(ifelse(Tr$TB>=5000,1,0))
            NTM <- sum(ifelse(Tr$TB>=1000 & Tr$TB<5000,1,0))
            NTL <- sum(ifelse(Tr$TB>=1 & Tr$TB<1000,1,0)) 
            
            NHH <- sum(ifelse(H$HB>=4000,1,0))
            NHM <- sum(ifelse(H$HB>=2000 & H$HB<4000,1,0))
            NHL <- sum(ifelse(H$HB>=1 & H$HB<2000,1,0)) 
            
            q25R <- round(quantile(R$RB, probs=c(0.25)),1)
            q75R <- round(quantile(R$RB, probs=c(0.75)),1) 
            q25T <- round(quantile(Tr$TB, probs=c(0.25)),1)
            q75T <- round(quantile(Tr$TB, probs=c(0.75)),1) 
            q25H <- round(quantile(H$HB, probs=c(0.25)),1)
            q75H <- round(quantile(H$HB, probs=c(0.75)),1)
            
            MR <- round(mean(R$RB),1)
            MT <- round(mean(Tr$TB),1)
            MH <- round(mean(H$HB),1)
            
            nR <- length(R$RB)
            nT <- length(Tr$RB)
            nH <- length(H$HB)
            
            intense <- paste0('The distribution of the baseline egg counts across the subjects who completed the trial are illustrated in the figures below. The mean (25th quantile; 75th quantile) roundworm egg counts equalled ',MR,' (',q25R,';',q75R,') eggs per gram of stool. The mean whipworm egg counts equalled ',MT,' (',q25T,';',q75T,') eggs per gram of stool. The mean hookworm egg counts equalled ',MH,' (',q25H,';',q75H,') eggs per gram of stool. Low, moderate and heavy intensity roundworm infections were observed in ', NRL,' (',round(100*NRL/nR,1),'percent), ', NRM,' (',round(100*NRM/nR,1),' percent) and ', NRH, ' (',round(100*NRH/nR,1),' percent) cases, respectively. For whipworms, these numbers were ', NTL,' (',round(100*NTL/nT,1),' percent), ', NTM,' (',round(100*NTM/nT,1),' percent) and ', NTH, ' (',round(100*NTH/nT,1),' percent), respectively. For hookwworms, these numbers were ', NHL,' (',round(100*NHL/nH,1),' percent), ', NHM,' (',round(100*NHM/nH,1),' percent) and ', NHH, ' (',round(100*NHH/n,1),' percent), respectively.')
          }
          
          
          else{ 
            if(mean(data$Rb)>-2 & mean(data$Tb)>-2 & mean(data$Rf)>-2 & mean(data$Tf)>-2)
            {
              data$RB <-  data[,input$Rbas]  
              data$TB <-  data[,input$Tbas]
              data$RF <-  data[,input$Rfol]  
              data$TF <-  data[,input$Tfol] 
              R <- subset(data, RB>0 & RF >= 0)
              Tr <- subset(data, TB> 0 & TF >= 0)
              
              NRH <- sum(ifelse(R$RB>=10000,1,0))
              NRM <- sum(ifelse(R$RB>=1000 & R$RB<10000,1,0))
              NRL <- sum(ifelse(R$RB>=1 & R$RB<1000,1,0))
              
              NTH <- sum(ifelse(Tr$TB>=5000,1,0))
              NTM <- sum(ifelse(Tr$TB>=1000 & Tr$TB<5000,1,0))
              NTL <- sum(ifelse(Tr$TB>=1 & Tr$TB<1000,1,0)) 
          
              q25R <- round(quantile(R$RB, probs=c(0.25)),1)
              q75R <- round(quantile(R$RB, probs=c(0.75)),1) 
              q25T <- round(quantile(Tr$TB, probs=c(0.25)),1)
              q75T <- round(quantile(Tr$TB, probs=c(0.75)),1) 
      
              MR <- round(mean(R$RB),1)
              MT <- round(mean(Tr$TB),1)

              
              nR <- length(R$RB)
              nT <- length(Tr$TB)

              
              intense <- paste0('The distribution of the baseline egg counts across the subjects who completed the trial is illustrated in the figures below. The mean (25th quantile; 75th quantile) roundworm egg counts equalled ',MR,' (',q25R,';',q75R,') eggs per gram of stool. The mean whipworm egg counts equalled ',MT,' (',q25T,';',q75T,') eggs per gram of stool. Low, moderate and heavy intensity roundworm infections were observed in ', NRL,' (',round(100*NRL/nR,1),' percent), ', NRM,' (',round(100*NRM/nR,1),' percent) and ', NRH, ' (',round(100*NRH/nR,1),' percent) cases, respectively. For whipworms, these numbers were ', NTL,' (',round(100*NTL/nT,1),' percent), ', NTM,' (',round(100*NTM/nT,1),' percent) and ', NTH, ' (',round(100*NTH/nT,1),' percent), respectively.')
            }
            
            else{
              if(mean(data$Rb)>-2 & mean(data$Hb)>-2 & mean(data$Rf)>-2 & mean(data$Hf)>-2)
              {
                data$RB <-  data[,input$Rbas]  
                data$HB <-  data[,input$Hbas] 
                data$RF <-  data[,input$Rfol]  
                data$HF <-  data[,input$Hfol] 
                R <- subset(data, RB>0 & RF >= 0)
                H <- subset(data, HB>0 & HF >= 0)
                
                NRH <- sum(ifelse(R$RB>=10000,1,0))
                NRM <- sum(ifelse(R$RB>=1000 & R$RB<10000,1,0))
                NRL <- sum(ifelse(R$RB>=1 & R$RB<1000,1,0))
            
                NHH <- sum(ifelse(H$HB>=4000,1,0))
                NHM <- sum(ifelse(H$HB>=2000 & H$HB<4000,1,0))
                NHL <- sum(ifelse(H$HB>=1 & H$HB<2000,1,0)) 
                
                q25R <- round(quantile(R$RB, probs=c(0.25)),1)
                q75R <- round(quantile(R$RB, probs=c(0.75)),1) 
                q25H <- round(quantile(H$HB, probs=c(0.25)),1)
                q75H <- round(quantile(H$HB, probs=c(0.75)),1)
                
                MR <- round(mean(R$RB),1)
                MH <- round(mean(H$HB),1)
                
                nR <- length(R$RB)
                nH <- length(H$HB)
                
                intense <- paste0('The distribution of the baseline egg counts across the subjects who completed the trial are illustrated in the figures below. The mean (25th quantile; 75th quantile) roundworm egg counts equalled ',MR,' (',q25R,';',q75R,') eggs per gram of stool. The mean hookworm egg counts equalled ',MH,' (',q25H,';',q75H,') eggs per gram of stool. Low, moderate and heavy intensity roundworm infections were observed in ', NRL,' (',round(100*NRL/nR,1),' percent), ', NRM,' (',round(100*NRM/nR,1),' percent) and ', NRH, ' (',round(100*NRH/nR,1),' percent) cases, respectively. For hookwworms, these numbers were ', NHL,' (',round(100*NHL/nH,1),' percent), ', NHM,' (',round(100*NHM/nH,1),' percent) and ', NHH, ' (',round(100*NHH/n,1),' percent), respectively.')
              }
              
              
              else{
                if(mean(data$Tb)>-2 & mean(data$Hb)>-2 & mean(data$Tf)>-2 & mean(data$Hf)>-2)
                {
                   data$TB <-  data[,input$Tbas]
                  data$HB <-  data[,input$Hbas] 
                   data$TF <-  data[,input$Tfol] 
                  data$HF <-  data[,input$Hfol] 
                  Tr <- subset(data, TB> 0 & TF >= 0)
                  H <- subset(data, HB>0 & HF >= 0)
                  
                  NTH <- sum(ifelse(Tr$TB>=5000,1,0))
                  NTM <- sum(ifelse(Tr$TB>=1000 & Tr$TB<5000,1,0))
                  NTL <- sum(ifelse(Tr$TB>=1 & Tr$TB<1000,1,0)) 
                  
                  NHH <- sum(ifelse(H$HB>=4000,1,0))
                  NHM <- sum(ifelse(H$HB>=2000 & H$HB<4000,1,0))
                  NHL <- sum(ifelse(H$HB>=1 & H$HB<2000,1,0)) 
                  
                  q25T <- round(quantile(Tr$TB, probs=c(0.25)),1)
                  q75T <- round(quantile(Tr$TB, probs=c(0.75)),1) 
                  q25H <- round(quantile(H$HB, probs=c(0.25)),1)
                  q75H <- round(quantile(H$HB, probs=c(0.75)),1)
                  
                  MT <- round(mean(Tr$TB),1)
                  MH <- round(mean(H$HB),1)
                  
                  nT <- length(Tr$TB)
                  nH <- length(H$HB)
                  
                  intense <- paste0('The distribution of the baseline egg counts across the subjects who completed the trial are illustrated in the figures below. The mean (25th quantile; 75th quantile) whipworm egg counts equalled ',MT,' (',q25T,';',q75T,') eggs per gram of stool. The mean hookworm egg counts equalled',MH,'(',q25H,';',q75H,') eggs per gram of stool. Low, moderate and heavy intensity whipworm infections were observed in', NTL,'(',round(100*NTL/nT,1),' percent), ', NTM,' (',round(100*NTM/nT,1),' percent) and ', NTH, ' (',round(100*NTH/nT,1),' percent) cases, respectively. For hookwworms, these numbers were ', NHL,' (',round(100*NHL/nH,1),' percent), ', NHM,' (',round(100*NHM/nH,1),' percent) and ', NHH, ' (',round(100*NHH/nH,1),'percent), respectively.')
                  }
                else{
                  if(mean(data$Rb)>-2 & mean(data$Rf)>-2)
                  {
                    data$RB <-  data[,input$Rbas]  
                    data$RF <-  data[,input$Rfol]  
                    R <- subset(data, RB>0 & RF >= 0)
                    NRH <- sum(ifelse(R$RB>=10000,1,0))
                    NRM <- sum(ifelse(R$RB>=1000 & R$RB<10000,1,0))
                    NRL <- sum(ifelse(R$RB>=1 & R$RB<1000,1,0))
                    q25R <- round(quantile(R$RB, probs=c(0.25)),1)
                    q75R <- round(quantile(R$RB, probs=c(0.75)),1) 
                    MR <- round(mean(R$RB),1)
                    nR <- length(R$RB)
                    intense <- paste0('The distribution of the baseline egg counts across the subjects who completed the trial are illustrated in the figure below. The mean (25th quantile; 75th quantile) roundworm egg counts equalled ',MR,' (',q25R,';',q75R,') eggs per gram of stool.Low, moderate and heavy intensity infections were observed in ', NRL,' (',round(100*NRL/nR,1),' percent), ', NRM,' (',round(100*NRM/nR,1),' percent) and ', NRH, ' (',round(100*NRH/nR,1),' percent) cases, respectively.')
                  }
                  
                  else{
                    if(mean(data$Tb)>-2 & mean(data$Tf)>-2)
                    {
                      data$TB <-  data[,input$Tbas]
                      data$TF <-  data[,input$Tfol] 
                      Tr <- subset(data, TB> 0 & TF >= 0)
                      NTH <- sum(ifelse(Tr$TB>=5000,1,0))
                      NTM <- sum(ifelse(Tr$TB>=1000 & Tr$TB<5000,1,0))
                      NTL <- sum(ifelse(Tr$TB>=1 & Tr$TB<1000,1,0)) 
                      q25T <- round(quantile(Tr$TB, probs=c(0.25)),1)
                      q75T <- round(quantile(Tr$TB, probs=c(0.75)),1) 
                      MT <- round(mean(Tr$TB),1)
                      nT <- length(Tr$RB)
                      intense <- paste0('The distribution of the baseline egg counts across the subjects who completed the trial are illustrated in the figure below. The mean (25th quantile; 75th quantile) whipworm egg counts equalled ',MT,' (',q25T,';',q75T,') eggs per gram of stool. Low, moderate and heavy intensity infections were observed in ', NTL,' (',round(100*NTL/nT,1),' percent), ', NTM,' (',round(100*NTM/nT,1),' perent) and ', NTH, ' (',round(100*NTH/nT,1),' percent) cases, respectively.')
                    }
                    
                    else{
                      if(mean(data$Hb)>-2 & mean(data$Hf)>-2)
                      {
                        data$HB <-  data[,input$Hbas] 
                        data$HF <-  data[,input$Hfol] 
                        H <- subset(data, HB> 0 & HF >= 0)
                        NHH <- sum(ifelse(H$HB>=4000,1,0))
                        NHM <- sum(ifelse(H$HB>=2000 & H$HB<4000,1,0))
                        NHL <- sum(ifelse(H$HB>=1 & H$HB<2000,1,0)) 
                        
                        q25H <- round(quantile(H$HB, probs=c(0.25)),1)
                        q75H <- round(quantile(H$HB, probs=c(0.75)),1)
                        
                        MH <- round(mean(H$HB),1)
                        nH <- length(H$HB)
                        
                        intense <- paste0('The distribution of the baseline egg counts across the subjects who completed the trial are illustrated in the figure below. The mean (25th quantile; 75th quantile) hookworm egg counts equalled ',MH,' (',q25H,';',q75H,') eggs per gram of stool. Low, moderate and heavy intensty infections were observed in ', NHL,' (',round(100*NHL/nH,1),' percent) ,', NHM,' (',round(100*NHM/nH,1),' percent) and ', NHH, ' (',round(100*NHH/nH,1),' percent) cases, respectively.')
                      }
                      
                      else{paste('Data was not provided')}
                    }
                  }
                }  
              }   
            }
          } 
          }
        }
    }
  }  

@
\Sexpr{intense}

<<echo=FALSE>>=
  inFile <- input$file1
    if (is.null(inFile))
    {invisible(paste0(''))
    } else
      # number of cases infected with Schistosomiasis
    {if (input$NTD=='1')
      {data <- read.xlsx(inFile$datapath,1) 
      n <- length(data[,1])
      data$sh <- ifelse(input$Shbas=='Not recorded',rep(-2,n), ifelse(data[,input$Shbas]>0,1,0))
      data$shF <- ifelse(input$Shfol=='Not recorded',rep(-2,n), ifelse(data[,input$Shfol]>=0,1,0))
       
      # S mansoni
      data$sm <- ifelse(input$Smbas=='Not recorded',rep(-2,n), ifelse(data[,input$Smbas]>0,1,0))
      data$smF <- ifelse(input$Smfol=='Not recorded',rep(-2,n), ifelse(data[,input$Smfol]>=0,1,0))
      
      # S japonicum
      data$sj <- ifelse(input$Sjbas=='Not recorded',rep(-2,n), ifelse(data[,input$Sjbas]>0,1,0))
      data$sjF <- ifelse(input$Sjfol=='Not recorded',rep(-2,n), ifelse(data[,input$Sjfol]>=0,1,0))
      data$inf <- mean(ifelse(data$sh > -2 | data$sm > -2 | data$sj > -2, 1, 0))
    
        if(mean(data$inf)==0) {}
      else 
        {if(mean(data$sh)>-2 & mean(data$sm)>-2 & mean(data$smF)>-2 & mean(data$shF)>- 2){
          data$shB <-  data[,input$Shbas]  
          data$smB <-  data[,input$Smbas] 
          data$shF <-  data[,input$Shfol]  
          data$smF <-  data[,input$Smfol] 
          sh <- subset(data, shB >0 &  shF >=0)
          sm <- subset(data, smB >0 &  smF >=0)
          par(mfrow=c(1,2))
          hist(sh$shB, col = 'grey', main='S. haematobium', freq=T, xlab='Urine egg counts (eggs per 10 ml)')
          hist(sm$smB, col = 'grey', main='S. mansoni', freq=T, xlab='Faecal egg counts (eggs per gram of stool)')}
          else
            {if(mean(data$sh)>-2 & mean(data$shF> - 2)){
              data$shB <-  data[,input$Shbas]  
              data$shF <-  data[,input$Shfol]  
              sh <- subset(data, shB >0 &  shF >=0)
              hist(sh$shB, col = 'grey', main='S. haematobium', freq=T, xlab='Urine egg counts (eggs per 10 ml)')}
              else 
              {if(mean(data$sm)>-2 & mean(data$smF)>-2) {
                data$smB <-  data[,input$Smbas] 
                data$smF <-  data[,input$Smfol] 
                sm <- subset(data, smB >0 &  smF >=0)
                hist(sm$smB, col = 'grey', main='S. mansoni', freq=T, xlab='Faecal egg counts (eggs per 10 ml)')}
              else
                {if(mean(data$sj)>-2 & mean(data$sjF)>-2) {
                  data$sjB <-  data[,input$Sjbas]  
                  data$sjF <-  data[,input$Sjfol]  
                  sj <- subset(data, sjB >0 &  sjF >=0)
                hist(sj$sjB, col = 'grey', main='S. japonicum', freq=T, xlab='Faecal egg counts (eggs per 10 ml)')}
                else  {  }
                }
              }
            }
        }
    }
    else  {if (input$NTD=='2'){
      data <- read.xlsx(inFile$datapath,1)
      n <- length(data[,1])
      # roundworms
      data$Rb <- ifelse(input$Rbas=='Not recorded',rep(-2,n), ifelse(data[,input$Rbas]>0,1,0))
      data$Rf <- ifelse(input$Rfol=='Not recorded',rep(-2,n), ifelse(data[,input$Rfol]>=0,1,0))
      
      # whipworms
      data$Tb <- ifelse(input$Tbas=='Not recorded',rep(-2,n), ifelse(data[,input$Tbas]>0,1,0))
      data$Tf <- ifelse(input$Tfol=='Not recorded',rep(-2,n), ifelse(data[,input$Tfol]>=0,1,0))
 
      # hookworms
      data$Hb <- ifelse(input$Hbas=='Not recorded',rep(-2,n), ifelse(data[,input$Hbas]>0,1,0))
      data$Hf <- ifelse(input$Hfol=='Not recorded',rep(-2,n), ifelse(data[,input$Hfol]>=0,1,0))
      
      data$inf <- ifelse(data$Rb > -2 | data$Tb > -2 | data$Hb > -2, 1, 0)}
      if(mean(data$Rb)>-2 & mean(data$Tb)>-2 & mean(data$Hb)>-2 & mean(data$Rf)>-2 & mean(data$Tf)>-2 & mean(data$Hf)>-2)
      {
        data$RB <-  data[,input$Rbas]  
        data$TB <-  data[,input$Tbas]
        data$HB <-  data[,input$Hbas] 
        data$RF <-  data[,input$Rfol]  
        data$TF <-  data[,input$Tfol] 
        data$HF <-  data[,input$Hfol] 
        R <- subset(data, RB> 0 & RF >= 0)
        Tr <- subset(data, TB> 0 & TF >= 0)
        H <- subset(data, HB> 0 & HF >= 0)
        
        par(mfrow=c(1,3))
        hist(R$RB, col = 'grey', main='Roundworm', freq=T, xlab='Faecal egg counts (eggs per gram of stool)')
        hist(Tr$TB, col = 'grey', main='Whipworm', freq=T, xlab='Faecal egg counts (eggs per gram of stool)')
        hist(H$HB, col = 'grey', main='Hookworm', freq=T, xlab='Faecal egg counts (eggs per gram of stool)')
        }
      else{ 
        if(mean(data$Rb)>-2 & mean(data$Tb)>-2 & mean(data$Rf)>-2 & mean(data$Tf)>-2)
        {
          data$RB <-  data[,input$Rbas]  
          data$TB <-  data[,input$Tbas]
          data$RF <-  data[,input$Rfol]  
          data$TF <-  data[,input$Tfol] 
          R <- subset(data, RB> 0 & RF >= 0)
          Tr <- subset(data, TB> 0 & TF >= 0)
          
          par(mfrow=c(1,2))
          hist(R$RB, col = 'grey', main='Roundworm', freq=T, xlab='Faecal egg counts (eggs per gram of stool)')
          hist(Tr$TB, col = 'grey', main='Whipworm', freq=T, xlab='Faecal egg counts (eggs per gram of stool)')
        }
        else{  
          if(mean(data$Rb)>-2 & mean(data$Hb)>-2 & mean(data$Rf)>-2 & mean(data$Hf)>-2)
          {
            data$RB <-  data[,input$Rbas]  
            data$HB <-  data[,input$Hbas] 
            data$RF <-  data[,input$Rfol]  
            data$HF <-  data[,input$Hfol] 
            R <- subset(data, RB> 0 & RF >= 0)
            H <- subset(data, HB> 0 & HF >= 0)
            
            par(mfrow=c(1,2))
            hist(R$RB, col = 'grey', main='Roundworm', freq=T, xlab='Faecal egg counts (eggs per gram of stool)')
            hist(H$HB, col = 'grey', main='Hookworm', freq=T, xlab='Faecal egg counts (eggs per gram of stool)')
          }
          else{  
            if(mean(data$Hb)>-2 & mean(data$Tb)>-2 & mean(data$Hf)>-2 & mean(data$Tf)>-2)
            {
              data$TB <-  data[,input$Tbas]
              data$HB <-  data[,input$Hbas] 
              data$TF <-  data[,input$Tfol] 
              data$HF <-  data[,input$Hfol] 
              Tr <- subset(data, TB> 0 & TF >= 0)
              H <- subset(data, HB> 0 & HF >= 0)
              
              par(mfrow=c(1,2))
              hist(Tr$TB, col = 'grey', main='Whipworm', freq=T, xlab='Faecal egg counts (eggs per gram of stool)')
              hist(H$HB, col = 'grey', main='Hookworm', freq=T, xlab='Faecal egg counts (eggs per gram of stool)')
            }
            else{  
              if(mean(data$Rb)>-2 & mean(data$Rf)>-2)
              {
                data$RB <-  data[,input$Rbas]  
                data$RF <-  data[,input$Rfol]  
                R <- subset(data, RB> 0 & RF >= 0)
                 
                par(mfrow=c(1,1))
                hist(R$RB, col = 'grey', main='Roundworm', freq=T, xlab='Faecal egg counts (eggs per gram of stool)')
              }
              else{  
                if(mean(data$Tb)>-2 & mean(data$Tf)>-2)
                {
                  data$TB <-  data[,input$Tbas]
                  data$TF <-  data[,input$Tfol] 
                  Tr <- subset(data, TB> 0 & TF >= 0)
                  par(mfrow=c(1,1))
                  hist(Tr$TB, col = 'grey', main='Whipworm', freq=T, xlab='Faecal egg counts (eggs per gram of stool)')
                }
                else{  
                  if(mean(data$Hb)>-2 & mean(data$Hf)>-2)
                  {
                    data$HB <-  data[,input$Hbas] 
                    data$HF <-  data[,input$Hfol] 
                    H <- subset(data, HB> 0 & HF >= 0)
                    
                    par(mfrow=c(1,1))
                    hist(H$HB, col = 'grey', main='Hookworm', freq=T, xlab='Faecal egg counts (eggs per gram of stool)')
                  }
                  else{}
                }
              }
              
              
            }
            
            
            }
          
          }
        }   
      
      }   
      
    }
@

\subsection{Follow-up period}
<<echo=FALSE>>=
## Follow-up period
    inFile <- input$file1
    if (is.null(inFile))
    {follow <- paste0('Data was not provided.')
      } else
      # number of cases infected with Schistosomiasis
    {if (input$NTD=='1')
    {data <- read.xlsx(inFile$datapath,1)
    n <- length(data[,1])
    fol <- ifelse(input$followup=='Not recorded',rep(-2,n), data[,input$followup])
    # S haematobium
    data$sh <- ifelse(input$Shbas=='Not recorded',rep(-2,n), ifelse(data[,input$Shbas]>0,1,0))
    data$shF <- ifelse(input$Shfol=='Not recorded',rep(-2,n), ifelse(data[,input$Shfol]>=0,1,0))
    
    # S mansoni
    data$sm <- ifelse(input$Smbas=='Not recorded',rep(-2,n), ifelse(data[,input$Smbas]>0,1,0))
    data$smF <- ifelse(input$Smfol=='Not recorded',rep(-2,n), ifelse(data[,input$Smfol]>=0,1,0))
    
    # S japonicum
    data$sj <- ifelse(input$Sjbas=='Not recorded',rep(-2,n), ifelse(data[,input$Sjbas]>0,1,0))
    data$sjF <- ifelse(input$Sjfol=='Not recorded',rep(-2,n), ifelse(data[,input$Sjfol]>=0,1,0))
    data$sjC <- ifelse(data$sj == 1 & data$sjF == 1,1,0)
    data$inf <- mean(ifelse(data$sh > -2 | data$sm > -2 | data$sj > -2, 1, 0))
    
    # follow-up
    data$F <- ifelse(input$followup=='Not recorded',rep(-2,n), data[,input$followup])
    
    if(mean(data$inf)==0) {follow <- paste0('Please provide egg count data.')}
     if(mean(data$F==-2)) {follow <- paste0('Data was not provided.')}
    else {
      if(mean(data$sh)>-2 & mean(data$sm)>-2 & mean(data$smF)>-2 & mean(data$shF> - 2) & mean(data$F) >-2)
      {
        data$fol <-  data[,input$followup] 
        data$shB <-  data[,input$Shbas]  
        data$smB <-  data[,input$Smbas] 
        data$shF <-  data[,input$Shfol]  
        data$smF <-  data[,input$Smfol] 
        data$shp <- ifelse(data$shB>0,1,0) 
        data$smp <- ifelse(data$smB>0,1,0)
        data$shf <- ifelse(data$shF>=0,1,0) 
        data$smf <- ifelse(data$smF>=0,1,0) 
        data$shc <- data$shp + data$shf
        data$smc <- data$smp + data$smf
        data$com <- data$shc + data$smc
        data2 <- subset(data, data$shc == 2 | data$smc == 2)
        min <- round(quantile(data2$fol, probs=c(0)),1)
        max <- round(quantile(data2$fol, probs=c(1)),1)
        med <- round(quantile(data2$fol, probs=c(0.50)),1)
        nc <- length(data2$fol)
        ncont <- sum(ifelse(data2$fol>=7 & data2$fol<=21,1,0))
        follow <- paste0('The follow-up period ranged from ',min,' to ', max, ' days, with a median of ',med,'. In ',ncont,' out of ',nc,' (',round(100*(ncont/nc),1),' percent) complete cases the follow-up period ranged from 7 to 21 days.')
      }
      else{ 
        if(mean(data$sh)>-2 & mean(data$shF) >-2 & mean(data$F) >-2){
          data$fol <-  data[,input$followup] 
          data$shB <-  data[,input$Shbas]  
          data$shF <-  data[,input$Shfol]  
          data$shp <- ifelse(data$shB>0,1,0) 
          data$shf <- ifelse(data$shF>=0,1,0) 
          data$shc <- data$shp + data$shf
          data2 <- subset(data, data$shc == 2)
          min <- round(min(data2$fol),1)
          max <- round(max(data2$fol),1)
          med <- round(quantile(data2$fol, probs=c(0.50)),1)
          nc <- length(data2$fol)
         if(mean(data$sm)>-2 & mean(data$smF)> -2 & mean(data$F) >-2){
            data$fol <-  data[,input$followup]  
           data$smB <-  data[,input$Smbas] 
            data$smF <-  data[,input$Smfol] 
            data$smp <- ifelse(data$smB>0,1,0)
            data$smf <- ifelse(data$smF>=0,1,0) 
            data$smc <- data$smp + data$smf
            data2 <- subset(data, data$smc == 2)
            min <- round(min(data2$fol),1)
            max <- round(max(data2$fol),1)
            med <- round(quantile(data2$fol, probs=c(0.50)),1)
            nc <- length(data2$fol)
            ncont <- sum(ifelse(data2$fol>=7 & data2$fol<=21,1,0))
            follow <- paste0('The follow-up period ranged from ',min,' to ', max, ' days, with a median of ',med,'. In ',ncont,' out of ',nc,' (',round(100*(ncont/nc),1),' percent) complete cases the follow-up period ranged from 7 to 21 days.')
          }
          else{
            if(mean(data$sj)>-2 & mean(data$sjF) >- 2 & mean(data$F) >-2){
               data$fol <-  data[,input$followup] 
              data$sjB <-  data[,input$Sjbas]  
              data$sjF <-  data[,input$Sjfol] 
              data$sjp <- ifelse(data$sjB>0,1,0)
              data$sjf <- ifelse(data$sjF>=0,1,0) 
              data$sjc <- data$sjp + data$sjf
              data2 <- subset(data, data$sjc == 2)
              min <- round(min(data2$fol),1)
              max <- round(max(data2$fol),1)
              med <- round(quantile(data2$fol, probs=c(0.50)),1)
              nc <- length(data2$fol)
              ncont <- sum(ifelse(data2$fol>=7 & data2$fol<=21,1,0))
              follow <- paste0('The follow-up period ranged from ',min,' to ', max, ' days, with a median of ',med,'. In ',ncont,' out of ',nc,' (',round(100*(ncont/nc),1), ' percent) complete cases the follow-up period ranged from 7 to 21 days.')
                 }
            else{follow <- paste0('Data was not provided.')}  
            }   
          }
          } 
        }
    }
      else {
        # Number of cases of soil-transmitted helminthiasis
        if (input$NTD=='2')
        {
          if (input$NTD=='2'){
            data <- read.xlsx(inFile$datapath,1)
            n <- length(data[,1])
            # roundworms
            data$Rb <- ifelse(input$Rbas=='Not recorded',rep(-2,n), ifelse(data[,input$Rbas]>0,1,0))
            data$Rf <- ifelse(input$Rfol=='Not recorded',rep(-2,n), ifelse(data[,input$Rfol]>=0,1,0))
            
            # whipworms
            data$Tb <- ifelse(input$Tbas=='Not recorded',rep(-2,n), ifelse(data[,input$Tbas]>0,1,0))
            data$Tf <- ifelse(input$Tfol=='Not recorded',rep(-2,n), ifelse(data[,input$Tfol]>=0,1,0))
 
            # hookworms
            data$Hb <- ifelse(input$Hbas=='Not recorded',rep(-2,n), ifelse(data[,input$Hbas]>0,1,0))
            data$Hf <- ifelse(input$Hfol=='Not recorded',rep(-2,n), ifelse(data[,input$Hfol]>=0,1,0))
 
            data$inf <- ifelse(data$Rb > -2 | data$Tb > -2 | data$Hb > -2, 1, 0)
            # follow-up
            data$F <- ifelse(input$followup=='Not recorded',rep(-2,n), data[,input$followup])
            }
          if(mean(data$inf)==0) {follow <- paste0('Data was not provided.')}
          if(mean(data$F==-2)) {follow <- paste0('Data was not provided.')}
          else {
          if(mean(data$Rb)>-2 & mean(data$Tb)>-2 & mean(data$Hb)>-2 & mean(data$Rf)>-2 & mean(data$Tf)>-2 & mean(data$Hf)>-2 & mean(data$F) >-2)
          {
             data$fol <-  data[,input$followup] 
            data$RB <-  data[,input$Rbas]  
            data$TB <-  data[,input$Tbas] 
            data$HB <-  data[,input$Hbas] 
            
            data$RF <-  data[,input$Rfol]  
            data$TF <-  data[,input$Tfol]
            data$HF <-  data[,input$Hfol]
            
            data$Rp <- ifelse(data$RB>0,1,0) 
            data$Tp <- ifelse(data$TB>0,1,0)
            data$Hp <- ifelse(data$HB>0,1,0)
            
            data$Rf <- ifelse(data$RF>=0,1,0) 
            data$Tf <- ifelse(data$TF>=0,1,0) 
            data$Hf <- ifelse(data$HF>=0,1,0) 
            
            data$Rc <- data$Rp + data$Rf
            data$Tc <- data$Tp + data$Tf
            data$Hc <- data$Hp + data$Hf
        
            data2 <- subset(data, Rc==2 | Tc ==2 | Hc ==2)
            min <- round(quantile(data2$fol, probs=c(0)),1)
            max <- round(quantile(data2$fol, probs=c(1)),1)
            med <- round(quantile(data2$fol, probs=c(0.50)),1)
            nc <- length(data2$fol)
            ncont <- sum(ifelse(data2$fol>=7 & data2$fol<=21,1,0))
            follow <- paste0('The follow-up period ranged from',min,' to ', max, 'days, with a median of ',med,'. In ',ncont,' out of ',nc,' (',round(100*(ncont/nc),1),' percent) complete cases the follow-up period ranged from 7 to 21 days.')
            }
          else{ 
            if(mean(data$Rb)>-2 & mean(data$Tb)>-2 & mean(data$Rf)>-2 & mean(data$Tf)>-2 & mean(data$F) >-2)
            {
               data$fol <-  data[,input$followup] 
              data$RB <-  data[,input$Rbas]  
              data$TB <-  data[,input$Tbas] 
               data$RF <-  data[,input$Rfol]  
              data$TF <-  data[,input$Tfol]
              data$Rp <- ifelse(data$RB>0,1,0) 
              data$Tp <- ifelse(data$TB>0,1,0)
              data$Rf <- ifelse(data$RF>=0,1,0) 
              data$Tf <- ifelse(data$TF>=0,1,0) 
              data$Rc <- data$Rp + data$Rf
              data$Tc <- data$Tp + data$Tf
              
              data2 <- subset(data, Rc==2 | Tc ==2)
              min <- round(quantile(data2$fol, probs=c(0)),1)
              max <- round(quantile(data2$fol, probs=c(1)),1)
              med <- round(quantile(data2$fol, probs=c(0.50)),1)
              nc <- length(data2$fol)
              ncont <- sum(ifelse(data2$fol>=7 & data2$fol<=21,1,0))
              follow <- paste0('The follow-up period ranged from ',min,' to ', max, ' days, with a median of ',med,'. In ',ncont,' out of ',nc,' (',round(100*(ncont/nc),1),' percent) complete cases the follow-up period ranged from 7 to 21 days.')
            }
            
            else{
              if(mean(data$Rb)>-2 & mean(data$Hb)>-2 & mean(data$Rf)>-2 & mean(data$Hf)>-2 & mean(data$F) >-2)
              {
                 data$fol <-  data[,input$followup] 
                data$RB <-  data[,input$Rbas]  
                data$HB <-  data[,input$Hbas] 
                
                data$RF <-  data[,input$Rfol]  
                data$HF <-  data[,input$Hfol]
                
                data$Rp <- ifelse(data$RB>0,1,0) 
                data$Hp <- ifelse(data$HB>0,1,0)
                
                data$Rf <- ifelse(data$RF>=0,1,0) 
                data$Hf <- ifelse(data$HF>=0,1,0) 
                
                data$Rc <- data$Rp + data$Rf
                data$Hc <- data$Hp + data$Hf
                
                data2 <- subset(data, Rc==2 | Hc ==2)
                min <- round(quantile(data2$fol, probs=c(0)),1)
                max <- round(quantile(data2$fol, probs=c(1)),1)
                med <- round(quantile(data2$fol, probs=c(0.50)),1)
                nc <- length(data2$fol)
                ncont <- sum(ifelse(data2$fol>=7 & data2$fol<=21,1,0))
                follow <- paste0('The follow-up period ranged from ',min,' to ', max, ' days, with a median of ',med,'. In ',ncont,' out of ',nc,' (',round(100*(ncont/nc),1),' percent) complete cases the follow-up period ranged from 7 to 21 days.')
              }
              else{
                if(mean(data$Tb)>-2 & mean(data$Hb)>-2 & mean(data$Tf)>-2 & mean(data$Hf)>-2 & mean(data$F) >-2)
                {
                   data$fol <-  data[,input$followup] 
                  data$TB <-  data[,input$Tbas] 
                  data$HB <-  data[,input$Hbas] 
                  
                  data$TF <-  data[,input$Tfol]
                  data$HF <-  data[,input$Hfol]
                  
                  data$Tp <- ifelse(data$TB>0,1,0)
                  data$Hp <- ifelse(data$HB>0,1,0)
                  
                  data$Tf <- ifelse(data$TF>=0,1,0) 
                  data$Hf <- ifelse(data$HF>=0,1,0) 
                  
                  data$Tc <- data$Tp + data$Tf
                  data$Hc <- data$Hp + data$Hf
                  
                  data2 <- subset(data, Tc ==2 | Hc ==2)
                  min <- round(quantile(data2$fol, probs=c(0)),1)
                  max <- round(quantile(data2$fol, probs=c(1)),1)
                  med <- round(quantile(data2$fol, probs=c(0.50)),1)
                  nc <- length(data2$fol)
                  ncont <- sum(ifelse(data2$fol>=7 & data2$fol<=21,1,0))
                  follow <- paste0('The follow-up period ranged from ',min,' to ', max, ' days, with a median of ',med,'. In ',ncont,' out of ',nc,'(',round(100*(ncont/nc),1),' percent) complete cases the follow-up period ranged from 7 to 21 days.')
                }
                else{
                  if(mean(data$Rb)>-2 & mean(data$Rf)>-2 & mean(data$F) >-2)
                  {
                     data$fol <-  data[,input$followup] 
                    data$RB <-  data[,input$Rbas]  
                    data$RF <-  data[,input$Rfol]  
                    data$Rp <- ifelse(data$RB>0,1,0) 
                    data$Rf <- ifelse(data$RF>=0,1,0) 
                    data$Rc <- data$Rp + data$Rf
                    data2 <- subset(data, Rc==2)
                    min <- round(quantile(data2$fol, probs=c(0)),1)
                    max <- round(quantile(data2$fol, probs=c(1)),1)
                    med <- round(quantile(data2$fol, probs=c(0.50)),1)
                    nc <- length(data2$fol)
                    ncont <- sum(ifelse(data2$fol>=7 & data2$fol<=21,1,0))
                    follow <- paste0('The follow-up period ranged from ',min,' to ', max, ' days, with a median of ',med,'. In ',ncont,' out of ',nc,'(',round(100*(ncont/nc),1),' percent) complete cases the follow-up period ranged from 7 to 21 days.')
                  }
                  else{
                    if(mean(data$Tb)>-2 & mean(data$Tf)>-2 & mean(data$F) >-2)
                    {
                       data$fol <-  data[,input$followup] 
                      data$TB <-  data[,input$Tbas] 
                      data$TF <-  data[,input$Tfol]
                      data$Tp <- ifelse(data$TB>0,1,0)
                      data$Tf <- ifelse(data$TF>=0,1,0) 
                      data$Tc <- data$Tp + data$Tf
                      data2 <- subset(data,Tc ==2)
                      min <- round(quantile(data2$fol, probs=c(0)),1)
                      max <- round(quantile(data2$fol, probs=c(1)),1)
                      med <- round(quantile(data2$fol, probs=c(0.50)),1)
                      nc <- length(data2$fol)
                      ncont <- sum(ifelse(data2$fol>=7 & data2$fol<=21,1,0))
                      follow <- paste0('The follow-up period ranged from ',min,' to ', max, ' days, with a median of ',med,'. In ',ncont,' out of ',nc,'(',round(100*(ncont/nc),1),' percent) complete cases the follow-up period ranged from 7 to 21 days.')
                    }
                    else{
                      if(mean(data$Hb)>-2 & mean(data$Hf)>-2 & mean(data$F) >-2)
                      {
                         data$fol <-  data[,input$followup] 
                        data$HB <-  data[,input$Hbas] 
                        data$HF <-  data[,input$Hfol]
                        data$Hp <- ifelse(data$HB>0,1,0)
                        data$Hf <- ifelse(data$HF>=0,1,0) 
                        data$Hc <- data$Hp + data$Hf
                        
                        data2 <- subset(data, Hc ==2)
                        min <- round(quantile(data2$fol, probs=c(0)),1)
                        max <- round(quantile(data2$fol, probs=c(1)),1)
                        med <- round(quantile(data2$fol, probs=c(0.50)),1)
                        nc <- length(data2$fol)
                        ncont <- sum(ifelse(data2$fol>=7 & data2$fol<=21,1,0))
                        follow <- paste0('The follow-up period ranged from ',min,' to ', max, ' days, with a median of ',med,'. In ',ncont,' out of ',nc,'(',round(100*(ncont/nc),1),' percent) complete cases the follow-up period ranged from 7 to 21 days.')
                      }
                      
                      else{follow <- paste0('Data was not provided.')}
                    }
                  }
                }  
              }   
            }
          } 
          }
        }
    }
    } 
@
\Sexpr{follow}

\subsection{Egg reduction rate}
<<echo=FALSE>>=
   inFile <- input$file1
    if (is.null(inFile))
    {err <- paste0('Please upload data.')
      } else
      # Schistosomiasis
    {if (input$NTD=='1')
    {data <- read.xlsx(inFile$datapath,1)
    data$n <- 1
    n <- length(data[,1])
    # S haematobium
    data$sh <- ifelse(input$Shbas=='Not recorded',rep(-2,n), ifelse(data[,input$Shbas]>0,1,0))
    data$shF <- ifelse(input$Shfol=='Not recorded',rep(-2,n), ifelse(data[,input$Shfol]>=0,1,0))
 
       # S mansoni
    data$sm <- ifelse(input$Smbas=='Not recorded',rep(-2,n), ifelse(data[,input$Smbas]>0,1,0))
    data$smF <- ifelse(input$Smfol=='Not recorded',rep(-2,n), ifelse(data[,input$Smfol]>=0,1,0))
    
    # S japonicum
    data$sj <- ifelse(input$Sjbas=='Not recorded',rep(-2,n), ifelse(data[,input$Sjbas]>0,1,0))
    data$sjF <- ifelse(input$Sjfol=='Not recorded',rep(-2,n), ifelse(data[,input$Sjfol]>=0,1,0))
    data$inf <- mean(ifelse(data$sh > -2 | data$sm > -2 | data$sj > -2, 1, 0))
    
    if(mean(data$inf)==0) {paste('Data was not provided.')}
    else {
      if(mean(data$sh)>-2 & mean(data$sm)>-2 & mean(data$shF)>-2 & mean(data$smF)>-2)
      {
        data$shB <-  data[,input$Shbas]  
        data$smB <-  data[,input$Smbas] 
        data$shF <-  data[,input$Shfol]  
        data$smF <-  data[,input$Smfol] 
        sh <- subset(data, shB >0 &  shF >=0)
        sm <- subset(data, smB >0 &  smF >=0)
        ERRSH <- (1- mean(sh$shF)/mean(sh$shB))
        term1SH <- (mean(sh$shF)/mean(sh$shB))**2; term2SH <- ifelse(mean(sh$shF)==0,0,var(sh$shF)/mean(sh$shF)**2); term3SH <- var(sh$shB)/mean(sh$shB)**2
        term4SH <- ifelse(mean(sh$shF)==0,0,-2*cor(sh$shB,sh$shF)*sqrt(var(sh$shF))*sqrt(var(sh$shB))/(mean(sh$shB)*mean(sh$shF)))
        VARSH <-  term1SH*(term2SH+term3SH+term4SH); varSH <- VARSH / length(sh$shB)
        aSH <- ((1-ERRSH)**2)/varSH; bSH <- varSH/(1-ERRSH)
        ULSH <- 1-qgamma(0.025,shape = aSH, scale = bSH)
        LLSH <- 1-qgamma(0.975,shape = aSH, scale = bSH)
      
        ERRSM <- (1- mean(sm$smF)/mean(sm$smB))
        term1SM <- (mean(sm$smF)/mean(sm$smB))**2; term2SM <- ifelse(mean(sm$smF)==0,0,var(sm$smF)/mean(sm$smF)**2); term3SM <- var(sm$smB)/mean(sm$smB)**2
        term4SM <- ifelse(mean(sm$smF)==0,0,-2*cor(sm$smB,sm$smF)*sqrt(var(sm$smF))*sqrt(var(sm$smB))/(mean(sm$smB)*mean(sm$smF)))
        VARSM <-  term1SM*(term2SM+term3SM+term4SM); varSM <- VARSM / length(sm$smB)
        aSM <- ((1-ERRSM)**2)/varSM; bSM <- varSM/(1-ERRSM)
        ULSM <- 1-qgamma(0.025,shape = aSM, scale = bSM)
        LLSM <- 1-qgamma(0.975,shape = aSM, scale = bSM)
        
        if(input$Sdrug == 1)  {
        err <- paste0('The egg reduction rate (95 percent confidence intervals) of the intervention against S. haematoubium equalled ',round(100*ERRSH,1),' percent (',round(100*LLSH,1), '; ',round(100*ULSH,1), '). For S. mansoni, the egg reduction rate equalled ',round(100*ERRSM,1),' percent (',round(100*LLSM,1),'; ', round(100*ULSM,1),'). The figures below classify the egg reduction rate estimates according to the WHO thresholds (WHO, 2013). Any value in the green zone indicates that the efficacy of the drug is satisfactory, any value in the grey zone indicates that the drug is doubtful and any value in the red zone indicates that the drug is reduced.')
        }else {
          err <- paste0('The egg reduction rate (95 percent confidence intervals) of the intervention against S. haematoubium equalled ',round(100*ERRSH,1),' percent (',round(100*LLSH,1), '; ',round(100*ULSH,1),'). For S. mansoni, the egg reduction rate equalled ',round(100*ERRSM,1),' percent (',round(100*LLSM,1),'; ', round(100*ULSM,1),'). The figures below illustrate the uncertainty around the egg reduction rate estimates.')
          
        }
      } else {
        if(mean(data$sh)>-2 & mean(data$shF)>-2){
          data$shB <-  data[,input$Shbas]  
          data$shF <-  data[,input$Shfol]  
          sh <- subset(data, shB >0 &  shF >=0)
          ERRSH <- (1- mean(sh$shF)/mean(sh$shB))
          term1SH <- (mean(sh$shF)/mean(sh$shB))**2; term2SH <- ifelse(mean(sh$shF)==0,0,var(sh$shF)/mean(sh$shF)**2); term3SH <- var(sh$shB)/mean(sh$shB)**2
          term4SH <- ifelse(mean(sh$shF)==0,0,-2*cor(sh$shB,sh$shF)*sqrt(var(sh$shF))*sqrt(var(sh$shB))/(mean(sh$shB)*mean(sh$shF)))
          VARSH <-  term1SH*(term2SH+term3SH+term4SH); varSH <- VARSH / length(sh$shB)
          aSH <- ((1-ERRSH)**2)/varSH; bSH <- varSH/(1-ERRSH)
          ULSH <- 1-qgamma(0.025,shape = aSH, scale = bSH)
          LLSH <- 1-qgamma(0.975,shape = aSH, scale = bSH)
          
          if(input$Sdrug == 1){
          err <- paste0('The egg reduction rate (95 percent confidence intervals) of the intervention against S. haematoubium equalled ',round(100*ERRSH,1),' percent (',round(100*LLSH,1), '; ',round(100*ULSH,1),'). The figure below classifies the egg reduction rate estimates according to the WHO thresholds (WHO, 2013). Any value in the green zone indicates that the efficacy of the drug is satisfactory, any value in the grey zone indicates that the drug is doubtful and any value in the red zone indicates that the drug is reduced')
          } else {
            err <- paste0('The egg reduction rate (95 percent confidence intervals) of the intervention against S. haematoubium equalled ',round(100*ERRSH,1),' percent (',round(100*LLSH,1), '; ',round(100*ULSH,1),'). The figure below illustrates the uncertainty around the egg reduction rate estimates.')
          }
          
            } else {
          if(mean(data$sm)>-2 & mean(data$smF)>-2){
            data$smB <-  data[,input$Smbas] 
            data$smF <-  data[,input$Smfol] 
            sm <- subset(data, smB >0 &  smF >=0)
      
            ERRSM <- (1- mean(sm$smF)/mean(sm$smB))
            term1SM <- (mean(sm$smF)/mean(sm$smB))**2; term2SM <- ifelse(mean(sm$smF)==0,0,var(sm$smF)/mean(sm$smF)**2); term3SM <- var(sm$smB)/mean(sm$smB)**2
            term4SM <- ifelse(mean(sm$smF)==0,0,-2*cor(sm$smB,sm$smF)*sqrt(var(sm$smF))*sqrt(var(sm$smB))/(mean(sm$smB)*mean(sm$smF)))
            VARSM <-  term1SM*(term2SM+term3SM+term4SM); varSM <- VARSM / length(sm$smB)
            aSM <- ((1-ERRSM)**2)/varSM; bSM <- varSM/(1-ERRSM)
            ULSM <- 1-qgamma(0.025,shape = aSM, scale = bSM)
            LLSM <- 1-qgamma(0.975,shape = aSM, scale = bSM)
            
            if(input$Sdrug == 1){ 
            err <- paste0('The egg reduction rate (95 percent confidence intervals) of the intervention against S. mansoni equalled ',round(100*ERRSM,1),' percent (',round(100*LLSM,1), '; ',round(100*ULSM,1),'). The figure below classifies the egg reduction rate estimates according to the WHO thresholds (WHO, 2013). Any value in the green zone indicates that the efficacy of the drug is satisfactory, any value in the grey zone indicates that the drug is doubtful and any value in the red zone indicates that the drug is reduced')
            } else {
              err <- paste0('The egg reduction rate (95 percent confidence intervals) of the intervention against S. mansoni equalled ',round(100*ERRSM,1), ' percent (',round(100*LLSM,1),'; ', round(100*ULSM,1),'). The figure below illustrates the uncertainty around the egg reduction rate estimates.')
              
            }
            
            } else {
            if(mean(data$sj)>-2 & mean(data$sjF>-2)){
              data$sjB <-  data[,input$Sjbas] 
              data$sjF <-  data[,input$Sjfol] 
              sj <- subset(data, sjB >0 &  sjF >=0)
              ERRSJ <- (1- mean(sj$sjF)/mean(sj$sjB))
              term1SJ <- (mean(sj$sjF)/mean(sj$sjB))**2; term2SJ <- ifelse(mean(sj$sjF)==0,0,var(sj$sjF)/mean(sj$sjF)**2); term3SJ <- var(sj$sjB)/mean(sj$sjB)**2              
              term4SJ <- ifelse(mean(sj$sjF)==0,0,-2*cor(sj$sjB,sj$sjF)*sqrt(var(sj$sjF))*sqrt(var(sj$sjB))/(mean(sj$sjB)*mean(sj$sjF)))
              VARSJ <-  term1SJ*(term2SJ+term3SJ+term4SJ); varSJ <- VARSJ / length(sj$sjB)
              aSJ <- ((1-ERRSJ)**2)/varSJ; bSJ <- varSJ/(1-ERRSJ)
              ULSJ <- 1-qgamma(0.025,shape = aSJ, scale = bSJ)
              LLSJ <- 1-qgamma(0.975,shape = aSJ, scale = bSJ)
              if(input$Sdrug == 1){
                err <- paste0('The egg reduction rate (95 percent confidence intervals) of the intervention against S. japonicum equalled ',round(100*ERRSJ,1),' percent (',round(100*LLSJ,1), '; ',round(100*ULSJ,1),'). The figure below classifies the egg reduction rate estimates according to the WHO thresholds (WHO, 2013). Any value in the green zone indicates that the efficacy of the drug is satisfactory, any value in the grey zone indicates that the drug is doubtful and any value in the red zone indicates that the drug is reduced')
            } else {
              err <- paste0('The egg reduction rate (95 percent confidence intervals) of the intervention against S. japonicum equalled ',round(100*ERRSJ,1),' percent (',round(100*LLSJ,1), '; ',round(100*ULSJ,1),'). The figure below illustrates the uncertainty around the egg reduction rate estimates.')
               }
              
              } else{err <- paste0('Data was not provided.')}  
          }   
        }
      } 
      }
    }
      else {
        # Soil-transmitted helminthiasis
        if (input$NTD=='2')
        {
          data <- read.xlsx(inFile$datapath,1)
          n <- length(data[,1])
          # roundworms
          data$Rb <- ifelse(input$Rbas=='Not recorded',rep(-2,n), ifelse(data[,input$Rbas]>0,1,0))
          data$Rf <- ifelse(input$Rfol=='Not recorded',rep(-2,n), ifelse(data[,input$Rfol]>=0,1,0))
          
          # whipworms
          data$Tb <- ifelse(input$Tbas=='Not recorded',rep(-2,n), ifelse(data[,input$Tbas]>0,1,0))
          data$Tf <- ifelse(input$Tfol=='Not recorded',rep(-2,n), ifelse(data[,input$Tfol]>=0,1,0))
          
          # hookworms
          data$Hb <- ifelse(input$Hbas=='Not recorded',rep(-2,n), ifelse(data[,input$Hbas]>0,1,0))
          data$Hf <- ifelse(input$Hfol=='Not recorded',rep(-2,n), ifelse(data[,input$Hfol]>=0,1,0))
          
          data$inf <- ifelse(data$Rb > -2 | data$Tb > -2 | data$Hb > -2, 1, 0)
          
        if(mean(data$inf)==0) {err <- paste('Data was not provided.')}
        else {
          if(mean(data$Rb)>-2 & mean(data$Tb)>-2 & mean(data$Hb)>-2 & mean(data$Rf)>-2 & mean(data$Tf)>-2 & mean(data$Hf)>-2)
          {
            data$RB <-  data[,input$Rbas]  
            data$TB <-  data[,input$Tbas]
            data$HB <-  data[,input$Hbas] 
            data$RF <-  data[,input$Rfol]  
            data$TF <-  data[,input$Tfol] 
            data$HF <-  data[,input$Hfol] 
            R <- subset(data, RB> 0 & RF >= 0)
            Tr <- subset(data, TB> 0 & TF >= 0)
            H <- subset(data, HB> 0 & HF >= 0)
            
            ERRR <- (1- mean(R$RF)/mean(R$RB))
            term1R <- (mean(R$RF)/mean(R$RB))**2; term2R <- ifelse(mean(R$RF)==0,0,var(R$RF)/mean(R$RF)**2); term3R <- var(R$RB)/mean(R$RB)**2
            term4R <- ifelse(mean(R$RF)==0,0,-2*cor(R$RB,R$RF)*sqrt(var(R$RF))*sqrt(var(R$RB))/(mean(R$RB)*mean(R$RF)))
            VARR <-  term1R*(term2R+term3R+term4R); varR <- VARR / length(R$RB)
            aR <- ((1-ERRR)**2)/varR; bR <- varR/(1-ERRR)
            ULR <- 1-qgamma(0.025,shape = aR, scale = bR)
            LLR <- 1-qgamma(0.975,shape = aR, scale = bR)
     
            ERRT <- (1- mean(Tr$TF)/mean(Tr$TB))
            term1T <- (mean(Tr$TF)/mean(Tr$TB))**2; term2T <- ifelse(mean(Tr$TF)==0,0,var(Tr$TF)/mean(Tr$TF)**2); term3T <- var(Tr$TB)/mean(Tr$TB)**2
            term4T <- ifelse(mean(Tr$TF)==0,0,-2*cor(Tr$TB,Tr$TF)*sqrt(var(Tr$TF))*sqrt(var(Tr$TB))/(mean(Tr$TB)*mean(Tr$TF)))
            VART <-  term1T*(term2T+term3T+term4T); varT <- VART / length(Tr$TB)
            aT <- ((1-ERRT)**2)/varT; bT <- varT/(1-ERRT)
            ULT <- 1-qgamma(0.025,shape = aT, scale = bT)
            LLT <- 1-qgamma(0.975,shape = aT, scale = bT)
            
            ERRH <- (1- mean(H$HF[H$HB>0 & H$HF>=0])/mean(H$HB[H$HB>0 & H$HF>=0]))
            term1H <- (mean(H$HF)/mean(H$HB))**2; term2H <- ifelse(mean(H$HF)==0,0,var(H$HF)/mean(H$HF)**2); term3H <- var(H$HB)/mean(H$HB)**2
            term4H <- ifelse(mean(H$HF)==0,0,-2*cor(H$HB,H$HF)*sqrt(var(H$HF))*sqrt(var(H$HB))/(mean(H$HB)*mean(H$HF)))
            VARH <-  term1H*(term2H+term3H+term4H); varH <- VARH / length(H$HB)
            aH <- ((1-ERRH)**2)/varH; bH <- varH/(1-ERRH)
            ULH <- 1-qgamma(0.025,shape = aH, scale = bH)
            LLH <- 1-qgamma(0.975,shape = aH, scale = bH)
               
            if(input$STHdrug == 1 | input$STHdrug == 2) { 
            err <- paste0('The egg reduction rate (95 percent confidence intervals) of the intervention against roundworms equalled ',round(100*ERRR,1),' percent (',round(100*LLR,1), '; ',round(100*ULR,1), '). For whipworms, the egg reduction rate equalled ',round(100*ERRT,1),' percent (',round(100*LLT,1),'; ', round(100*ULT,1),'). For hookworms, the egg reduction rate equalled ',round(100*ERRH,1),' percent (',round(100*LLH,1),'; ', round(100*ULH,1),'). The figures below classify the egg reduction rate estimates according to the WHO thresholds (WHO, 2013). Any value in the green zone indicates that the efficacy of the drug is satisfactory, any value in the grey zone indicates that the drug is doubtful and any value in the red zone indicates that the drug is reduced. ')
            } else{err <- paste0('The egg reduction rate (95 percent confidence intervals) of the intervention against roundworms equalled ',round(100*ERRR,1),' percent (',round(100*LLR,1), ';',round(100*ULR,1), '). For whipworms, the egg reduction rate equalled ',round(100*ERRT,1),' percent (',round(100*LLT,1),'; ', round(100*ULT,1),'). For hookworms, the egg reduction rate equalled ',round(100*ERRH,1),' percent (',round(100*LLH,1),'; ', round(100*ULH,1),'). The figures below illustrate the uncertainty around the egg reduction rate estimates.')}
              } else{ 
            if(mean(data$Rb)>-2 & mean(data$Tb)>-2 & mean(data$Rf)>-2 & mean(data$Tf)>-2)
            {
              data$RB <-  data[,input$Rbas]  
              data$TB <-  data[,input$Tbas]
              data$RF <-  data[,input$Rfol]  
              data$TF <-  data[,input$Tfol] 
              R <- subset(data, RB> 0 & RF >= 0)
              Tr <- subset(data, TB> 0 & TF >= 0)
             
              ERRR <- (1- mean(R$RF)/mean(R$RB))
              term1R <- (mean(R$RF)/mean(R$RB))**2; term2R <- ifelse(mean(R$RF)==0,0,var(R$RF)/mean(R$RF)**2); term3R <- var(R$RB)/mean(R$RB)**2
              term4R <- ifelse(mean(R$RF)==0,0,-2*cor(R$RB,R$RF)*sqrt(var(R$RF))*sqrt(var(R$RB))/(mean(R$RB)*mean(R$RF)))
              VARR <-  term1R*(term2R+term3R+term4R); varR <- VARR / length(R$RB)
              aR <- ((1-ERRR)**2)/varR; bR <- varR/(1-ERRR)
              ULR <- 1-qgamma(0.025,shape = aR, scale = bR)
              LLR <- 1-qgamma(0.975,shape = aR, scale = bR)
              
              ERRT <- (1- mean(Tr$TF)/mean(Tr$TB))
              term1T <- (mean(Tr$TF)/mean(Tr$TB))**2; term2T <- ifelse(mean(Tr$TF)==0,0,var(Tr$TF)/mean(Tr$TF)**2); term3T <- var(Tr$TB)/mean(Tr$TB)**2
              term4T <- ifelse(mean(Tr$TF)==0,0,-2*cor(Tr$TB,Tr$TF)*sqrt(var(Tr$TF))*sqrt(var(Tr$TB))/(mean(Tr$TB)*mean(Tr$TF)))
              VART <-  term1T*(term2T+term3T+term4T); varT <- VART / length(Tr$TB)
              aT <- ((1-ERRT)**2)/varT; bT <- varT/(1-ERRT)
              ULT <- 1-qgamma(0.025,shape = aT, scale = bT)
              LLT <- 1-qgamma(0.975,shape = aT, scale = bT)
              if(input$STHdrug == 1 | input$STHdrug == 2) { 
               err <- paste0('The egg reduction rate (95 percent confidence intervals) of the intervention against roundworms equalled ',round(100*ERRR,1),' percent (',round(100*LLR,1), ';',round(100*ULR,1),'). For whipworms, the egg reduction rate equalled ',round(100*ERRT,1),' percent (',round(100*LLT,1),'; ', round(100*ULT,1),'). The figures below classify the egg reduction rate estimates according to the WHO thresholds (WHO, 2013). Any value in the green zone indicates that the efficacy of the drug is satisfactory, any value in the grey zone indicates that the drug is doubtful and any value in the red zone indicates that the drug is reduced. ')
              } else {err <- paste0('The egg reduction rate (95 percent confidence intervals) of the intervention against roundworms equalled ',round(100*ERRR,1),' percent (',round(100*LLR,1), '; ',round(100*ULR,1), '). For whipworms, the egg reduction rate equalled',round(100*ERRT,1),' percent (',round(100*LLT,1),'; ', round(100*ULT,1),'). The figures below illustrate the uncertainty around the egg reduction rate estimates.') }
               } else {
              if(mean(data$Rb)>-2 & mean(data$Hb)>-2 & mean(data$Rf)>-2 & mean(data$Hf)>-2)
              {
                data$RB <-  data[,input$Rbas]  
                data$HB <-  data[,input$Hbas] 
                data$RF <-  data[,input$Rfol]  
                data$HF <-  data[,input$Hfol] 
                R <- subset(data, RB> 0 & RF >= 0)
                H <- subset(data, HB> 0 & HF >= 0)
                
                ERRR <- (1- mean(R$RF)/mean(R$RB))
                term1R <- (mean(R$RF)/mean(R$RB))**2; term2R <- ifelse(mean(R$RF)==0,0,var(R$RF)/mean(R$RF)**2); term3R <- var(R$RB)/mean(R$RB)**2
                term4R <- ifelse(mean(R$RF)==0,0,-2*cor(R$RB,R$RF)*sqrt(var(R$RF))*sqrt(var(R$RB))/(mean(R$RB)*mean(R$RF)))
                VARR <-  term1R*(term2R+term3R+term4R); varR <- VARR / length(R$RB)
                aR <- ((1-ERRR)**2)/varR; bR <- varR/(1-ERRR)
                ULR <- 1-qgamma(0.025,shape = aR, scale = bR)
                LLR <- 1-qgamma(0.975,shape = aR, scale = bR)
                
                ERRH <- (1- mean(H$HF[H$HB>0 & H$HF>=0])/mean(H$HB[H$HB>0 & H$HF>=0]))
                term1H <- (mean(H$HF)/mean(H$HB))**2; term2H <- ifelse(mean(H$HF)==0,0,var(H$HF)/mean(H$HF)**2); term3H <- var(H$HB)/mean(H$HB)**2
                term4H <- ifelse(mean(H$HF)==0,0,-2*cor(H$HB,H$HF)*sqrt(var(H$HF))*sqrt(var(H$HB))/(mean(H$HB)*mean(H$HF)))
                VARH <-  term1H*(term2H+term3H+term4H); varH <- VARH / length(H$HB)
                aH <- ((1-ERRH)**2)/varH; bH <- varH/(1-ERRH)
                ULH <- 1-qgamma(0.025,shape = aH, scale = bH)
                LLH <- 1-qgamma(0.975,shape = aH, scale = bH)   
                if(input$STHdrug == 1 | input$STHdrug == 2){ 
                err <- paste0('The egg reduction rate (95 percent confidence intervals) of the intervention against roundworms equalled ',round(100*ERRR,1),' percent (',round(100*LLR,1), '; ',round(100*ULR,1), '). For hookworms, the egg reduction rate equalled ',round(100*ERRH,1),' percent (',round(100*LLH,1),'; ', round(100*ULH,1),').The figures below classify the egg reduction rate estimates according to the WHO thresholds (WHO, 2013). Any value in the green zone indicates that the efficacy of the drug is satisfactory, any value in the grey zone indicates that the drug is doubtful and any value in the red zone indicates that the drug is reduced.')
              } else { err <- paste0('The egg reduction rate (95 percent confidence intervals) of the intervention against roundworms equalled ',round(100*ERRR,1),' percent (',round(100*LLR,1), '; ',round(100*ULR,1), '). For hookworms, the egg reduction rate equalled ',round(100*ERRH,1),' percent (',round(100*LLH,1),'; ', round(100*ULH,1),'). The figures below illustrate the uncertainty around the egg reduction rate estimates.')}
               } else {
                if(mean(data$Tb)>-2 & mean(data$Hb)>-2 & mean(data$Tf)>-2 & mean(data$Hf)>-2)
                {
                  data$TB <-  data[,input$Tbas]
                  data$HB <-  data[,input$Hbas] 
                  data$TF <-  data[,input$Tfol] 
                  data$HF <-  data[,input$Hfol] 
                  Tr <- subset(data, TB> 0 & TF >= 0)
                  H <- subset(data, HB> 0 & HF >= 0)
                  
                  ERRT <- (1- mean(Tr$TF)/mean(Tr$TB))
                  term1T <- (mean(Tr$TF)/mean(Tr$TB))**2; term2T <- ifelse(mean(Tr$TF)==0,0,var(Tr$TF)/mean(Tr$TF)**2); term3T <- var(Tr$TB)/mean(Tr$TB)**2
                  term4T <- ifelse(mean(Tr$TF)==0,0,-2*cor(Tr$TB,Tr$TF)*sqrt(var(Tr$TF))*sqrt(var(Tr$TB))/(mean(Tr$TB)*mean(Tr$TF)))
                  VART <-  term1T*(term2T+term3T+term4T); varT <- VART / length(Tr$TB)
                  aT <- ((1-ERRT)**2)/varT; bT <- varT/(1-ERRT)
                  ULT <- 1-qgamma(0.025,shape = aT, scale = bT)
                  LLT <- 1-qgamma(0.975,shape = aT, scale = bT)
                  
                  ERRH <- (1- mean(H$HF[H$HB>0 & H$HF>=0])/mean(H$HB[H$HB>0 & H$HF>=0]))
                  term1H <- (mean(H$HF)/mean(H$HB))**2; term2H <- ifelse(mean(H$HF)==0,0,var(H$HF)/mean(H$HF)**2); term3H <- var(H$HB)/mean(H$HB)**2
                  term4H <- ifelse(mean(H$HF)==0,0,-2*cor(H$HB,H$HF)*sqrt(var(H$HF))*sqrt(var(H$HB))/(mean(H$HB)*mean(H$HF)))
                  VARH <-  term1H*(term2H+term3H+term4H); varH <- VARH / length(H$HB)
                  aH <- ((1-ERRH)**2)/varH; bH <- varH/(1-ERRH)
                  ULH <- 1-qgamma(0.025,shape = aH, scale = bH)
                  LLH <- 1-qgamma(0.975,shape = aH, scale = bH)
                  if(input$STHdrug == 1 | input$STHdrug == 2){
                  err <- paste0('The egg reduction rate (95 percent confidence intervals) of the interventionwhipworms equalled ',round(100*ERRT,1),' percent (',round(100*LLT,1),'; ', round(100*ULT,1),'). For hookworms, the egg reduction rate equalled ',round(100*ERRH,1),' percent (',round(100*LLH,1),'; ', round(100*ULH,1),').The figures below classify the egg reduction rate estimates according to the WHO thresholds (WHO, 2013). Any value in the green zone indicates that the efficacy of the drug is satisfactory, any value in the grey zone indicates that the drug is doubtful and any value in the red zone indicates that the drug is reduced. ')
                  } else {err <- paste0('The egg reduction rate (95 percent confidence intervals) of the interventionwhipworms equalled ',round(100*ERRT,1),' percent (',round(100*LLT,1),'; ', round(100*ULT,1),'). For hookworms, the egg reduction rate equalled ',round(100*ERRH,1),' percent (',round(100*LLH,1),'; ', round(100*ULH,1),'). The figures below illustrate the uncertainty around the egg reduction rate estimates.')}
                  } else {
                  if(mean(data$Rb)>-2 & mean(data$Rf)>-2)
                  {
                    data$RB <-  data[,input$Rbas]  
                    data$RF <-  data[,input$Rfol]  
                    R <- subset(data, RB> 0 & RF >= 0)
                    
                    ERRR <- (1- mean(R$RF)/mean(R$RB))
                    term1R <- (mean(R$RF)/mean(R$RB))**2; term2R <- ifelse(mean(R$RF)==0,0,var(R$RF)/mean(R$RF)**2); term3R <- var(R$RB)/mean(R$RB)**2
                    term4R <- ifelse(mean(R$RF)==0,0,-2*cor(R$RB,R$RF)*sqrt(var(R$RF))*sqrt(var(R$RB))/(mean(R$RB)*mean(R$RF)))
                    VARR <-  term1R*(term2R+term3R+term4R); varR <- VARR / length(R$RB)
                    aR <- ((1-ERRR)**2)/varR; bR <- varR/(1-ERRR)
                    ULR <- 1-qgamma(0.025,shape = aR, scale = bR)
                    LLR <- 1-qgamma(0.975,shape = aR, scale = bR)
                    
                    if(input$STHdrug == 1 | input$STHdrug == 2){
                    err <- paste0('The egg reduction rate (95 percent confidence intervals) of the intervention against roundworms equalled ',round(100*ERRR,1),' percent (',round(100*LLR,1), '; ',round(100*ULR,1), '). The figure below classify the egg reduction rate estimates according to the WHO thresholds (WHO, 2013). Any value in the green zone indicates that the efficacy of the drug is satisfactory, any value in the grey zone indicates that the drug is doubtful and any value in the red zone indicates that the drug is reduced. ')
                    } else {err <- paste0('The egg reduction rate (95 percent confidence intervals) of the intervention against roundworms equalled ',round(100*ERRR,1),' percent (',round(100*LLR,1), '; ',round(100*ULR,1), '). The figure below illustrates the uncertainty around the egg reduction rate estimate.')} 
                      } else {
                    if(mean(data$Tb)>-2 & mean(data$Tf)>-2)
                    {
                      data$TB <-  data[,input$Tbas]
                      data$TF <-  data[,input$Tfol] 
                      Tr <- subset(data, TB> 0 & TF >= 0)
                      
                      ERRT <- (1- mean(Tr$TF)/mean(Tr$TB))
                      term1T <- (mean(Tr$TF)/mean(Tr$TB))**2; term2T <- ifelse(mean(Tr$TF)==0,0,var(Tr$TF)/mean(Tr$TF)**2); term3T <- var(Tr$TB)/mean(Tr$TB)**2
                      term4T <- ifelse(mean(Tr$TF)==0,0,-2*cor(Tr$TB,Tr$TF)*sqrt(var(Tr$TF))*sqrt(var(Tr$TB))/(mean(Tr$TB)*mean(Tr$TF)))
                      VART <-  term1T*(term2T+term3T+term4T); varT <- VART / length(Tr$TB)
                      aT <- ((1-ERRT)**2)/varT; bT <- varT/(1-ERRT)
                      ULT <- 1-qgamma(0.025,shape = aT, scale = bT)
                      LLT <- 1-qgamma(0.975,shape = aT, scale = bT)
                      if(input$STHdrug == 1 | input$STHdrug == 2){
                      err <- paste0('The egg reduction rate (95 percent confidence intervals) of the intervention against whipworms equalled ',round(100*ERRT,1),' percent (',round(100*LLT,1),'; ', round(100*ULT,1),'). The figure below classify the egg reduction rate estimates according to the WHO thresholds (WHO, 2013). Any value in the green zone indicates that the efficacy of the drug is satisfactory, any value in the grey zone indicates that the drug is doubtful and any value in the red zone indicates that the drug is reduced.')
                      } else { 
                        err <- paste0('The egg reduction rate (95 percent confidence intervals) of the intervention against whipworms equalled ',round(100*ERRT,1),' percent (',round(100*LLT,1),'; ', round(100*ULT,1),'). The figure below illustrates the uncertainty around the egg reduction rate estimate.')}
                        } else {
                        if(mean(data$Hb)>-2 & mean(data$Hf)>-2)
                        {
                          data$HB <-  data[,input$Hbas] 
                          data$HF <-  data[,input$Hfol] 
                          H <- subset(data, HB> 0 & HF >= 0)
                          
                          ERRH <- (1- mean(H$HF[H$HB>0 & H$HF>=0])/mean(H$HB[H$HB>0 & H$HF>=0]))
                          term1H <- (mean(H$HF)/mean(H$HB))**2; term2H <- ifelse(mean(H$HF)==0,0,var(H$HF)/mean(H$HF)**2); term3H <- var(H$HB)/mean(H$HB)**2
                          term4H <- ifelse(mean(H$HF)==0,0,-2*cor(H$HB,H$HF)*sqrt(var(H$HF))*sqrt(var(H$HB))/(mean(H$HB)*mean(H$HF)))
                          VARH <-  term1H*(term2H+term3H+term4H); varH <- VARH / length(H$HB)
                          aH <- ((1-ERRH)**2)/varH; bH <- varH/(1-ERRH)
                          ULH <- 1-qgamma(0.025,shape = aH, scale = bH)
                          LLH <- 1-qgamma(0.975,shape = aH, scale = bH)  
                          if(input$STHdrug == 1 | input$STHdrug == 2){ 
                          err <- paste0('The egg reduction rate (95 percent confidence intervals) of the intervention agains hookworms equalled ',round(100*ERRH,1),' percent (',round(100*LLH,1),'; ', round(100*ULH,1),'). The figure below classify the egg reduction rate estimates according to the WHO thresholds (WHO, 2013). Any value in the green zone indicates that the efficacy of the drug is satisfactory, any value in the grey zone indicates that the drug is doubtful and any value in the red zone indicates that the drug is reduced.')
                          } else {
                           err <- paste0('The egg reduction rate (95 percent confidence intervals) of the intervention agains hookworms equalled ',round(100*ERRH,1),' percent (',round(100*LLH,1),'; ', round(100*ULH,1),'). The figure below illustrates the uncertainty around the egg reduction rate estimate.')
                            
                            }                            
                
                          
                          } else {err <- paste0('Data was not provided.')}
                    }
                  }
                }  
              }   
            }
          } 
          }
        }
    }
  } 
@
\Sexpr{err}.

<<echo=FALSE>>=
    inFile <- input$file1
    if (is.null(inFile))
    {invisible(paste0(''))
      } else
      # number of cases infected with Schistosomiasis
    {if (input$NTD=='1')
    {data <- read.xlsx(inFile$datapath,1) 
    n <- length(data[,1])
    data$sh <- ifelse(input$Shbas=='Not recorded',rep(-2,n), ifelse(data[,input$Shbas]>0,1,0))
    data$shF <- ifelse(input$Shfol=='Not recorded',rep(-2,n), ifelse(data[,input$Shfol]>=0,1,0))
    
    # S mansoni
    data$sm <- ifelse(input$Smbas=='Not recorded',rep(-2,n), ifelse(data[,input$Smbas]>0,1,0))
    data$smF <- ifelse(input$Smfol=='Not recorded',rep(-2,n), ifelse(data[,input$Smfol]>=0,1,0))
    
    # S japonicum
    data$sj <- ifelse(input$Sjbas=='Not recorded',rep(-2,n), ifelse(data[,input$Sjbas]>0,1,0))
    data$sjF <- ifelse(input$Sjfol=='Not recorded',rep(-2,n), ifelse(data[,input$Sjfol]>=0,1,0))
  
      data$inf <- mean(ifelse(data$sh > -2 | data$sm > -2 | data$sj > -2, 1, 0))
    if(mean(data$inf)==0) {}
    else 
    {
      if(mean(data$sh)>-2 & mean(data$sm)>-2 & mean(data$smF)>-2 & mean(data$shF)> - 2){
        data$shB <-  data[,input$Shbas]  
        data$smB <-  data[,input$Smbas] 
        data$shF <-  data[,input$Shfol]  
        data$smF <-  data[,input$Smfol] 
        sh <- subset(data, shB > 0 &shF >=0)
        sm <- subset(data, smB > 0 & smF >=0)
        ERRSH <- (1- mean(sh$shF)/mean(sh$shB))
        term1SH <- (mean(sh$shF)/mean(sh$shB))**2; term2SH <- ifelse(mean(sh$shF)==0,0,var(sh$shF)/mean(sh$shF)**2); term3SH <- var(sh$shB)/mean(sh$shB)**2
        term4SH <- ifelse(mean(sh$shF)==0,0,-2*cor(sh$shB,sh$shF)*sqrt(var(sh$shF))*sqrt(var(sh$shB))/(mean(sh$shB)*mean(sh$shF)))
        VARSH <-  term1SH*(term2SH+term3SH+term4SH); varSH <- VARSH / length(sh$shB)
        aSH <- ((1-ERRSH)**2)/varSH; bSH <- varSH/(1-ERRSH)
        ULSH <- 1-qgamma(0.025,shape = aSH, scale = bSH)
        LLSH <- 1-qgamma(0.975,shape = aSH, scale = bSH)
        
        ERRSM <- (1- mean(sm$smF)/mean(sm$smB))
        term1SM <- (mean(sm$smF)/mean(sm$smB))**2; term2SM <- ifelse(mean(sm$smF)==0,0,var(sm$smF)/mean(sm$smF)**2); term3SM <- var(sm$smB)/mean(sm$smB)**2
        term4SM <- ifelse(mean(sm$smF)==0,0,-2*cor(sm$smB,sm$smF)*sqrt(var(sm$smF))*sqrt(var(sm$smB))/(mean(sm$smB)*mean(sm$smF)))
        VARSM <-  term1SM*(term2SM+term3SM+term4SM); varSM <- VARSM / length(sm$smB)
        aSM <- ((1-ERRSM)**2)/varSM; bSM <- varSM/(1-ERRSM)
        ULSM <- 1-qgamma(0.025,shape = aSM, scale = bSM)
        LLSM <- 1-qgamma(0.975,shape = aSM, scale = bSM)
      
      if(input$Sdrug==1) { 
        
      par(mfrow=c(1,2))
      SH <- rgamma(10000,shape = aSH, scale = bSH)
      plot(100*(1-sort(SH)), dgamma(sort(SH),  shape = aSH , scale = bSH), ylab='Density',xlab='Egg reduction rate (%)',xlim=c(max(100*LLSH-10,0),min(100*ULSH+10,100)),type='n')
      lines(100*(1-sort(SH)), dgamma(sort(SH), shape = aSH , scale = bSH), col = 1 , lty = 1)
      t <- seq(0,0.10,0.0001)
      t2 <- seq(0.1,0.2,0.0001)
      t3 <- seq(0.2,1,0.0001)
      polygon(c(100*(1-sort(t)),rev(100*(1-sort(t)))),c((dgamma(sort(t), shape = aSH , scale = bSH)),rev(rep(0,length(dgamma(sort(t), shape = aSH , scale = bSH))))),col="green", border=NA)
      polygon(c(100*(1-sort(t2)),rev(100*(1-sort(t2)))),c((dgamma(sort(t2), shape = aSH , scale = bSH)),rev(rep(0,length(dgamma(sort(t2), shape = aSH , scale = bSH))))),col="grey", border=NA)
      polygon(c(100*(1-sort(t3)),rev(100*(1-sort(t3)))),c((dgamma(sort(t3), shape = aSH , scale = bSH)),rev(rep(0,length(dgamma(sort(t3), shape = aSH , scale = bSH))))),col="red", border=NA)
      
      SM <- rgamma(10000,shape = aSM, scale = bSM)
      plot(100*(1-sort(SM)), dgamma(sort(SM),  shape = aSM , scale = bSM),ylab='Density',xlab='Egg reduction rate (%)',c(max(100*LLSM-10,0),min(100*ULSM+10,100)), type='n')
      lines(100*(1-sort(SM)), dgamma(sort(SM), shape = aSM , scale = bSM), col = 1 , lty = 1)
      polygon(c(100*(1-sort(t)),rev(100*(1-sort(t)))),c((dgamma(sort(t), shape = aSM , scale = bSM)),rev(rep(0,length(dgamma(sort(t), shape = aSM , scale = bSM))))),col="green", border=NA)
      polygon(c(100*(1-sort(t2)),rev(100*(1-sort(t2)))),c((dgamma(sort(t2), shape = aSM , scale = bSM)),rev(rep(0,length(dgamma(sort(t2), shape = aSM , scale = bSM))))),col="grey", border=NA)
      polygon(c(100*(1-sort(t3)),rev(100*(1-sort(t3)))),c((dgamma(sort(t3), shape = aSM , scale = bSM)),rev(rep(0,length(dgamma(sort(t3), shape = aSM , scale = bSM))))),col="red", border=NA)
      } else { 
        par(mfrow=c(1,2))
        SH <- rgamma(10000,shape = aSH, scale = bSH)
        plot(100*(1-sort(SH)), dgamma(sort(SH),  shape = aSH , scale = bSH), ylab='Density',xlab='Egg reduction rate (%)',xlim=c(max(100*LLSH-10,0),min(100*ULSH+10,100)),type='n')
        lines(100*(1-sort(SH)), dgamma(sort(SH), shape = aSH , scale = bSH), col = 1 , lty = 1)
        t <- seq(0,1-ULSH,0.0001)
        t2 <- seq(1-ULSH,1-LLSH,0.0001)
        t3 <- seq(1-LLSH,1,0.0001)
        polygon(c(100*(1-sort(t)),rev(100*(1-sort(t)))),c((dgamma(sort(t), shape = aSH , scale = bSH)),rev(rep(0,length(dgamma(sort(t), shape = aSH , scale = bSH))))),col="grey", border=NA)
        polygon(c(100*(1-sort(t2)),rev(100*(1-sort(t2)))),c((dgamma(sort(t2), shape = aSH , scale = bSH)),rev(rep(0,length(dgamma(sort(t2), shape = aSH , scale = bSH))))),col="white", border=NA)
        polygon(c(100*(1-sort(t3)),rev(100*(1-sort(t3)))),c((dgamma(sort(t3), shape = aSH , scale = bSH)),rev(rep(0,length(dgamma(sort(t3), shape = aSH , scale = bSH))))),col="grey", border=NA)
  
        SM <- rgamma(10000,shape = aSM, scale = bSM)
        plot(100*(1-sort(SM)), dgamma(sort(SM),  shape = aSM , scale = bSM),ylab='Density',xlab='Egg reduction rate (%)',c(max(100*LLSM-10,0),min(100*ULSM+10,100)), type='n')
        lines(100*(1-sort(SM)), dgamma(sort(SM), shape = aSM , scale = bSM), col = 1 , lty = 1)
        t <- seq(0,1-ULSM,0.0001)
        t2 <- seq(1-ULSM,1-LLSM,0.0001)
        t3 <- seq(1-LLSM,1,0.0001)
        polygon(c(100*(1-sort(t)),rev(100*(1-sort(t)))),c((dgamma(sort(t), shape = aSM , scale = bSM)),rev(rep(0,length(dgamma(sort(t), shape = aSM , scale = bSM))))),col="grey", border=NA)
        polygon(c(100*(1-sort(t2)),rev(100*(1-sort(t2)))),c((dgamma(sort(t2), shape = aSM , scale = bSM)),rev(rep(0,length(dgamma(sort(t2), shape = aSM , scale = bSM))))),col="white", border=NA)
        polygon(c(100*(1-sort(t3)),rev(100*(1-sort(t3)))),c((dgamma(sort(t3), shape = aSM , scale = bSM)),rev(rep(0,length(dgamma(sort(t3), shape = aSM , scale = bSM))))),col="grey", border=NA)
        }
      
      } else {
        if(mean(data$sh)>-2 & mean(data$shF)> - 2){
          data$shB <-  data[,input$Shbas]  
          data$shF <-  data[,input$Shfol]  
          
          sh <- subset(data, shB >0 &  shF >=0)
          ERRSH <- (1- mean(sh$shF)/mean(sh$shB))
          term1SH <- (mean(sh$shF)/mean(sh$shB))**2; term2SH <- ifelse(mean(sh$shF)==0,0,var(sh$shF)/mean(sh$shF)**2); term3SH <- var(sh$shB)/mean(sh$shB)**2
          term4SH <- ifelse(mean(sh$shF)==0,0,-2*cor(sh$shB,sh$shF)*sqrt(var(sh$shF))*sqrt(var(sh$shB))/(mean(sh$shB)*mean(sh$shF)))
          VARSH <-  term1SH*(term2SH+term3SH+term4SH); varSH <- VARSH / length(sh$shB)
          aSH <- ((1-ERRSH)**2)/varSH; bSH <- varSH/(1-ERRSH)
          ULSH <- 1-qgamma(0.025,shape = aSH, scale = bSH)
          LLSH <- 1-qgamma(0.975,shape = aSH, scale = bSH)
          
          if(input$Sdrug == 1) {           
          par(mfrow=c(1,1))
          SH <- rgamma(10000,shape = aSH, scale = bSH)
          plot(100*(1-sort(SH)), dgamma(sort(SH),  shape = aSH , scale = bSH), ylab='Density',xlab='Egg reduction rate (%)',xlim=c(max(100*LLSH-10,0),min(100*ULSH+10,100)),type='n')
          lines(100*(1-sort(SH)), dgamma(sort(SH), shape = aSH , scale = bSH), col = 1 , lty = 1)
          t <- seq(0,0.10,0.0001)
          t2 <- seq(0.1,0.2,0.0001)
          t3 <- seq(0.2,1,0.0001)
          polygon(c(100*(1-sort(t)),rev(100*(1-sort(t)))),c((dgamma(sort(t), shape = aSH , scale = bSH)),rev(rep(0,length(dgamma(sort(t), shape = aSH , scale = bSH))))),col="green", border=NA)
          polygon(c(100*(1-sort(t2)),rev(100*(1-sort(t2)))),c((dgamma(sort(t2), shape = aSH , scale = bSH)),rev(rep(0,length(dgamma(sort(t2), shape = aSH , scale = bSH))))),col="grey", border=NA)
          polygon(c(100*(1-sort(t3)),rev(100*(1-sort(t3)))),c((dgamma(sort(t3), shape = aSH , scale = bSH)),rev(rep(0,length(dgamma(sort(t3), shape = aSH , scale = bSH))))),col="red", border=NA)
          } else { 
            par(mfrow=c(1,1))
            SH <- rgamma(10000,shape = aSH, scale = bSH)
            plot(100*(1-sort(SH)), dgamma(sort(SH),  shape = aSH , scale = bSH), ylab='Density',xlab='Egg reduction rate (%)',xlim=c(max(100*LLSH-10,0),min(100*ULSH+10,100)),type='n')
            lines(100*(1-sort(SH)), dgamma(sort(SH), shape = aSH , scale = bSH), col = 1 , lty = 1)
            t <- seq(0,1-ULSH,0.0001)
            t2 <- seq(1-ULSH,1-LLSH,0.0001)
            t3 <- seq(1-LLSH,1,0.0001)
            polygon(c(100*(1-sort(t)),rev(100*(1-sort(t)))),c((dgamma(sort(t), shape = aSH , scale = bSH)),rev(rep(0,length(dgamma(sort(t), shape = aSH , scale = bSH))))),col="grey", border=NA)
            polygon(c(100*(1-sort(t2)),rev(100*(1-sort(t2)))),c((dgamma(sort(t2), shape = aSH , scale = bSH)),rev(rep(0,length(dgamma(sort(t2), shape = aSH , scale = bSH))))),col="white", border=NA)
            polygon(c(100*(1-sort(t3)),rev(100*(1-sort(t3)))),c((dgamma(sort(t3), shape = aSH , scale = bSH)),rev(rep(0,length(dgamma(sort(t3), shape = aSH , scale = bSH))))),col="grey", border=NA)
            
            }
          
          } else {
          if(mean(data$sm)>-2 & mean(data$smF)> - 2){
            data$smB <-  data[,input$Smbas] 
            data$smF <-  data[,input$Smfol] 
            sm <- subset(data, smB >0 &  smF >=0)
      
            ERRSM <- (1- mean(sm$smF)/mean(sm$smB))
            term1SM <- (mean(sm$smF)/mean(sm$smB))**2; term2SM <- ifelse(mean(sm$smF)==0,0,var(sm$smF)/mean(sm$smF)**2); term3SM <- var(sm$smB)/mean(sm$smB)**2
            term4SM <- ifelse(mean(sm$smF)==0,0,-2*cor(sm$smB,sm$smF)*sqrt(var(sm$smF))*sqrt(var(sm$smB))/(mean(sm$smB)*mean(sm$smF)))
            VARSM <-  term1SM*(term2SM+term3SM+term4SM); varSM <- VARSM / length(sm$smB)
            aSM <- ((1-ERRSM)**2)/varSM; bSM <- varSM/(1-ERRSM)
            ULSM <- 1-qgamma(0.025,shape = aSM, scale = bSM)
            LLSM <- 1-qgamma(0.975,shape = aSM, scale = bSM)
            
            if(input$Sdrug == 1) { 
            par(mfrow=c(1,1))
            SM <- rgamma(10000,shape = aSM, scale = bSM)
            plot(100*(1-sort(SM)), dgamma(sort(SM),  shape = aSM , scale = bSM), ylab='Density',xlab='Egg reduction rate (%)',xlim=c(max(100*LLSM-10,0),min(100*ULSM+10,100)),type='n')
            lines(100*(1-sort(SM)), dgamma(sort(SM), shape = aSM , scale = bSM), col = 1 , lty = 1)
            t <- seq(0,0.10,0.0001)
            t2 <- seq(0.1,0.2,0.0001)
            t3 <- seq(0.2,1,0.0001)
            polygon(c(100*(1-sort(t)),rev(100*(1-sort(t)))),c((dgamma(sort(t), shape = aSM , scale = bSM)),rev(rep(0,length(dgamma(sort(t), shape = aSM , scale = bSM))))),col="green", border=NA)
            polygon(c(100*(1-sort(t2)),rev(100*(1-sort(t2)))),c((dgamma(sort(t2), shape = aSM , scale = bSM)),rev(rep(0,length(dgamma(sort(t2), shape = aSM , scale = bSM))))),col="grey", border=NA)
            polygon(c(100*(1-sort(t3)),rev(100*(1-sort(t3)))),c((dgamma(sort(t3), shape = aSM , scale = bSM)),rev(rep(0,length(dgamma(sort(t3), shape = aSM , scale = bSM))))),col="red", border=NA)
            } else {
              par(mfrow=c(1,1))
              SM <- rgamma(10000,shape = aSM, scale = bSM)
              plot(100*(1-sort(SM)), dgamma(sort(SM),  shape = aSM , scale = bSM),ylab='Density',xlab='Egg reduction rate (%)',c(max(100*LLSM-10,0),min(100*ULSM+10,100)), type='n')
              lines(100*(1-sort(SM)), dgamma(sort(SM), shape = aSM , scale = bSM), col = 1 , lty = 1)
              t <- seq(0,1-ULSM,0.0001)
              t2 <- seq(1-ULSM,1-LLSM,0.0001)
              t3 <- seq(1-LLSM,1,0.0001)
              polygon(c(100*(1-sort(t)),rev(100*(1-sort(t)))),c((dgamma(sort(t), shape = aSM , scale = bSM)),rev(rep(0,length(dgamma(sort(t), shape = aSM , scale = bSM))))),col="green", border=NA)
              polygon(c(100*(1-sort(t2)),rev(100*(1-sort(t2)))),c((dgamma(sort(t2), shape = aSM , scale = bSM)),rev(rep(0,length(dgamma(sort(t2), shape = aSM , scale = bSM))))),col="grey", border=NA)
              polygon(c(100*(1-sort(t3)),rev(100*(1-sort(t3)))),c((dgamma(sort(t3), shape = aSM , scale = bSM)),rev(rep(0,length(dgamma(sort(t3), shape = aSM , scale = bSM))))),col="red", border=NA)
              
              
            }
            
            } else {
            if(mean(data$sj)>-2 & mean(data$sjF)> - 2){
              data$sjB <-  data[,input$Sjbas] 
              data$sjF <-  data[,input$Sjfol] 
              sj <- subset(data, sjB >0 &  sjF >=0)
              ERRSJ <- (1- mean(sj$sjF)/mean(sj$sjB))
              term1SJ <- (mean(sj$sjF)/mean(sj$sjB))**2; term2SJ <- ifelse(mean(sj$sjF)==0,0,var(sj$sjF)/mean(sj$sjF)**2); term3SJ <- var(sj$sjB)/mean(sj$sjB)**2              
              term4SJ <- ifelse(mean(sj$sjF)==0,0,-2*cor(sj$sjB,sj$sjF)*sqrt(var(sj$sjF))*sqrt(var(sj$sjB))/(mean(sj$sjB)*mean(sj$sjF)))
              VARSJ <-  term1SJ*(term2SJ+term3SJ+term4SJ); varSJ <- VARSJ / length(sj$sjB)
              aSJ <- ((1-ERRSJ)**2)/varSJ; bSJ <- varSJ/(1-ERRSJ)
              ULSJ <- 1-qgamma(0.025,shape = aSJ, scale = bSJ)
              LLSJ <- 1-qgamma(0.975,shape = aSJ, scale = bSJ)
              
              if(input$Sdrug == 1) {
              par(mfrow=c(1,1))
              SJ <- rgamma(10000,shape = aSJ, scale = bSJ)
              plot(100*(1-sort(SJ)), dgamma(sort(SJ),  shape = aSJ , scale = bSJ), ylab='Density',xlab='Egg reduction rate (%)',xlim=c(max(100*LLSJ-10,0),min(100*ULSJ+10,100)),type='n')
              lines(100*(1-sort(SJ)), dgamma(sort(SJ), shape = aSJ , scale = bSJ), col = 1 , lty = 1)
              t <- seq(0,0.10,0.0001)
              t2 <- seq(0.1,0.2,0.0001)
              t3 <- seq(0.2,1,0.0001)
              polygon(c(100*(1-sort(t)),rev(100*(1-sort(t)))),c((dgamma(sort(t), shape = aSJ , scale = bSJ)),rev(rep(0,length(dgamma(sort(t), shape = aSJ , scale = bSJ))))),col="green", border=NA)
              polygon(c(100*(1-sort(t2)),rev(100*(1-sort(t2)))),c((dgamma(sort(t2), shape = aSJ , scale = bSJ)),rev(rep(0,length(dgamma(sort(t2), shape = aSJ , scale = bSJ))))),col="grey", border=NA)
              polygon(c(100*(1-sort(t3)),rev(100*(1-sort(t3)))),c((dgamma(sort(t3), shape = aSJ , scale = bSJ)),rev(rep(0,length(dgamma(sort(t3), shape = aSJ , scale = bSJ))))),col="red", border=NA)
              } else  {  
              SJ <- rgamma(10000,shape = aSJ, scale = bSJ)
              plot(100*(1-sort(SJ)), dgamma(sort(SJ),  shape = aSJ , scale = bSJ), ylab='Density',xlab='Egg reduction rate (%)',xlim=c(max(100*LLSJ-10,0),min(100*ULSJ+10,100)),type='n')
              lines(100*(1-sort(SJ)), dgamma(sort(SJ), shape = aSJ , scale = bSJ), col = 1 , lty = 1)
              t <- seq(0,1-ULSJ,0.0001)
              t2 <- seq(1-ULSJ,1-LLSJ,0.0001)
              t3 <- seq(1-LLSJ,1,0.0001)
              polygon(c(100*(1-sort(t)),rev(100*(1-sort(t)))),c((dgamma(sort(t), shape = aSJ , scale = bSJ)),rev(rep(0,length(dgamma(sort(t), shape = aSJ , scale = bSJ))))),col="grey", border=NA)
              polygon(c(100*(1-sort(t2)),rev(100*(1-sort(t2)))),c((dgamma(sort(t2), shape = aSJ , scale = bSJ)),rev(rep(0,length(dgamma(sort(t2), shape = aSJ , scale = bSJ))))),col="white", border=NA)
              polygon(c(100*(1-sort(t3)),rev(100*(1-sort(t3)))),c((dgamma(sort(t3), shape = aSJ , scale = bSJ)),rev(rep(0,length(dgamma(sort(t3), shape = aSJ , scale = bSJ))))),col="grey", border=NA)
            }
          }
       }
      }
      }
    }
    } else  {if (input$NTD=='2'){
        data <- read.xlsx(inFile$datapath,1)
        n <- length(data[,1])
        # roundworms
        data$Rb <- ifelse(input$Rbas=='Not recorded',rep(-2,n), ifelse(data[,input$Rbas]>0,1,0))
        data$Rf <- ifelse(input$Rfol=='Not recorded',rep(-2,n), ifelse(data[,input$Rfol]>=0,1,0))
        
        # whipworms
        data$Tb <- ifelse(input$Tbas=='Not recorded',rep(-2,n), ifelse(data[,input$Tbas]>0,1,0))
        data$Tf <- ifelse(input$Tfol=='Not recorded',rep(-2,n), ifelse(data[,input$Tfol]>=0,1,0))
        
        # hookworms
        data$Hb <- ifelse(input$Hbas=='Not recorded',rep(-2,n), ifelse(data[,input$Hbas]>0,1,0))
        data$Hf <- ifelse(input$Hfol=='Not recorded',rep(-2,n), ifelse(data[,input$Hfol]>=0,1,0))
        
        data$inf <- ifelse(data$Rb > -2 | data$Tb > -2 | data$Hb > -2, 1, 0)}
        if(mean(data$Rb)>-2 & mean(data$Tb)>-2 & mean(data$Hb)>-2 & mean(data$Rf)>-2 & mean(data$Tf)>-2 & mean(data$Hf)>-2)
        {
          data$RB <-  data[,input$Rbas]  
          data$TB <-  data[,input$Tbas]
          data$HB <-  data[,input$Hbas] 
          data$RF <-  data[,input$Rfol]  
          data$TF <-  data[,input$Tfol] 
          data$HF <-  data[,input$Hfol] 
          R <- subset(data, RB> 0 & RF >= 0)
          Tr <- subset(data, TB> 0 & TF >= 0)
          H <- subset(data, HB> 0 & HF >= 0)
          
          ERRR <- (1- mean(R$RF)/mean(R$RB))
          term1R <- (mean(R$RF)/mean(R$RB))**2; term2R <- ifelse(mean(R$RF)==0,0,var(R$RF)/mean(R$RF)**2); term3R <- var(R$RB)/mean(R$RB)**2
          term4R <- ifelse(mean(R$RF)==0,0,-2*cor(R$RB,R$RF)*sqrt(var(R$RF))*sqrt(var(R$RB))/(mean(R$RB)*mean(R$RF)))
          VARR <-  term1R*(term2R+term3R+term4R); varR <- VARR / length(R$RB)
          aR <- ((1-ERRR)**2)/varR; bR <- varR/(1-ERRR)
          ULR <- 1-qgamma(0.025,shape = aR, scale = bR)
          LLR <- 1-qgamma(0.975,shape = aR, scale = bR)
          
          ERRT <- (1- mean(Tr$TF)/mean(Tr$TB))
          term1T <- (mean(Tr$TF)/mean(Tr$TB))**2; term2T <- ifelse(mean(Tr$TF)==0,0,var(Tr$TF)/mean(Tr$TF)**2); term3T <- var(Tr$TB)/mean(Tr$TB)**2
          term4T <- ifelse(mean(Tr$TF)==0,0,-2*cor(Tr$TB,Tr$TF)*sqrt(var(Tr$TF))*sqrt(var(Tr$TB))/(mean(Tr$TB)*mean(Tr$TF)))
          VART <-  term1T*(term2T+term3T+term4T); varT <- VART / length(Tr$TB)
          aT <- ((1-ERRT)**2)/varT; bT <- varT/(1-ERRT)
          ULT <- 1-qgamma(0.025,shape = aT, scale = bT)
          LLT <- 1-qgamma(0.975,shape = aT, scale = bT)
          
          ERRH <- (1- mean(H$HF[H$HB>0 & H$HF>=0])/mean(H$HB[H$HB>0 & H$HF>=0]))
          term1H <- (mean(H$HF)/mean(H$HB))**2; term2H <- ifelse(mean(H$HF)==0,0,var(H$HF)/mean(H$HF)**2); term3H <- var(H$HB)/mean(H$HB)**2
          term4H <- ifelse(mean(H$HF)==0,0,-2*cor(H$HB,H$HF)*sqrt(var(H$HF))*sqrt(var(H$HB))/(mean(H$HB)*mean(H$HF)))
          VARH <-  term1H*(term2H+term3H+term4H); varH <- VARH / length(H$HB)
          aH <- ((1-ERRH)**2)/varH; bH <- varH/(1-ERRH)
          ULH <- 1-qgamma(0.025,shape = aH, scale = bH)
          LLH <- 1-qgamma(0.975,shape = aH, scale = bH)
         
          if(input$STHdrug == 1)
          { 
          par(mfrow=c(1,3))
          R <- rgamma(10000,shape = aR, scale = bR)
          plot(100*(1-sort(R)), dgamma(sort(R),  shape = aR , scale = bR), main='Roundworms',ylab='Density',xlab='Egg reduction rate (%)',xlim=c(max(100*LLR-10,0),min(100*ULR+10,100)),type='n')
          lines(100*(1-sort(R)), dgamma(sort(R), shape = aR , scale = bR), col = 1 , lty = 1)
          t <- seq(0,0.05,0.0001)
          t2 <- seq(0.05,0.15,0.0001)
          t3 <- seq(0.15,1,0.0001)
          polygon(c(100*(1-sort(t)),rev(100*(1-sort(t)))),c((dgamma(sort(t), shape = aR , scale = bR)),rev(rep(0,length(dgamma(sort(t), shape = aR , scale = bR))))),col="green", border=NA)
          polygon(c(100*(1-sort(t2)),rev(100*(1-sort(t2)))),c((dgamma(sort(t2), shape = aR , scale = bR)),rev(rep(0,length(dgamma(sort(t2), shape = aR , scale = bR))))),col="grey", border=NA)
          polygon(c(100*(1-sort(t3)),rev(100*(1-sort(t3)))),c((dgamma(sort(t3), shape = aR , scale = bR)),rev(rep(0,length(dgamma(sort(t3), shape = aR , scale = bR))))),col="red", border=NA)
          
          T <- rgamma(10000,shape = aT, scale = bT)
          plot(100*(1-sort(T)), dgamma(sort(T),  shape = aT , scale = bT), main = 'Whipworms',ylab='Density',xlab='Egg reduction rate (%)',xlim=c(max(100*LLT-10,0),min(100*ULT+10,100)),type='n')
          lines(100*(1-sort(T)), dgamma(sort(T), shape = aT , scale = bT), col = 1 , lty = 1)
          t <- seq(0,0.5,0.0001)
          t2 <- seq(0.5,0.6,0.0001)
          t3 <- seq(0.6,1,0.0001)
          polygon(c(100*(1-sort(t)),rev(100*(1-sort(t)))),c((dgamma(sort(t), shape = aT , scale = bT)),rev(rep(0,length(dgamma(sort(t), shape = aT , scale = bT))))),col="green", border=NA)
          polygon(c(100*(1-sort(t2)),rev(100*(1-sort(t2)))),c((dgamma(sort(t2), shape = aT , scale = bT)),rev(rep(0,length(dgamma(sort(t2), shape = aT , scale = bT))))),col="grey", border=NA)
          polygon(c(100*(1-sort(t3)),rev(100*(1-sort(t3)))),c((dgamma(sort(t3), shape = aT , scale = bT)),rev(rep(0,length(dgamma(sort(t3), shape = aT , scale = bT))))),col="red", border=NA)
          
          H <- rgamma(10000,shape = aH, scale = bH)
          plot(100*(1-sort(H)), dgamma(sort(H),  shape = aH , scale = bH), main = 'Hookworms',ylab='Density',xlab='Egg reduction rate (%)',xlim=c(max(100*LLH-10,0),min(100*ULH+10,100)),type='n')
          lines(100*(1-sort(H)), dgamma(sort(H), shape = aH , scale = bH), col = 1 , lty = 1)
          t <- seq(0,0.1,0.0001)
          t2 <- seq(0.1,0.2,0.0001)
          t3 <- seq(0.2,1,0.0001)
          polygon(c(100*(1-sort(t)),rev(100*(1-sort(t)))),c((dgamma(sort(t), shape = aH , scale = bH)),rev(rep(0,length(dgamma(sort(t), shape = aH , scale = bH))))),col="green", border=NA)
          polygon(c(100*(1-sort(t2)),rev(100*(1-sort(t2)))),c((dgamma(sort(t2), shape = aH , scale = bH)),rev(rep(0,length(dgamma(sort(t2), shape = aH , scale = bH))))),col="grey", border=NA)
          polygon(c(100*(1-sort(t3)),rev(100*(1-sort(t3)))),c((dgamma(sort(t3), shape = aH , scale = bH)),rev(rep(0,length(dgamma(sort(t3), shape = aH , scale = bH))))),col="red", border=NA)
          
          } else {
          
          if(input$STHdrug == 2)
          { 
            par(mfrow=c(1,3))
            R <- rgamma(10000,shape = aR, scale = bR)
            plot(100*(1-sort(R)), dgamma(sort(R),  shape = aR , scale = bR), main='Roundworms',ylab='Density',xlab='Egg reduction rate (%)',xlim=c(max(100*LLR-10,0),min(100*ULR+10,100)),type='n')
            lines(100*(1-sort(R)), dgamma(sort(R), shape = aR , scale = bR), col = 1 , lty = 1)
            t <- seq(0,0.05,0.0001)
            t2 <- seq(0.05,0.15,0.0001)
            t3 <- seq(0.15,1,0.0001)
            polygon(c(100*(1-sort(t)),rev(100*(1-sort(t)))),c((dgamma(sort(t), shape = aR , scale = bR)),rev(rep(0,length(dgamma(sort(t), shape = aR , scale = bR))))),col="green", border=NA)
            polygon(c(100*(1-sort(t2)),rev(100*(1-sort(t2)))),c((dgamma(sort(t2), shape = aR , scale = bR)),rev(rep(0,length(dgamma(sort(t2), shape = aR , scale = bR))))),col="grey", border=NA)
            polygon(c(100*(1-sort(t3)),rev(100*(1-sort(t3)))),c((dgamma(sort(t3), shape = aR , scale = bR)),rev(rep(0,length(dgamma(sort(t3), shape = aR , scale = bR))))),col="red", border=NA)
            
            T <- rgamma(10000,shape = aT, scale = bT)
            plot(100*(1-sort(T)), dgamma(sort(T),  shape = aT , scale = bT), main = 'Whipworms',ylab='Density',xlab='Egg reduction rate (%)',xlim=c(max(100*LLT-10,0),min(100*ULT+10,100)),type='n')
            lines(100*(1-sort(T)), dgamma(sort(T), shape = aT , scale = bT), col = 1 , lty = 1)
            t <- seq(0,0.5,0.0001)
            t2 <- seq(0.5,0.6,0.0001)
            t3 <- seq(0.6,1,0.0001)
            polygon(c(100*(1-sort(t)),rev(100*(1-sort(t)))),c((dgamma(sort(t), shape = aT , scale = bT)),rev(rep(0,length(dgamma(sort(t), shape = aT , scale = bT))))),col="green", border=NA)
            polygon(c(100*(1-sort(t2)),rev(100*(1-sort(t2)))),c((dgamma(sort(t2), shape = aT , scale = bT)),rev(rep(0,length(dgamma(sort(t2), shape = aT , scale = bT))))),col="grey", border=NA)
            polygon(c(100*(1-sort(t3)),rev(100*(1-sort(t3)))),c((dgamma(sort(t3), shape = aT , scale = bT)),rev(rep(0,length(dgamma(sort(t3), shape = aT , scale = bT))))),col="red", border=NA)
          
          H <- rgamma(10000,shape = aH, scale = bH)
          plot(100*(1-sort(H)), dgamma(sort(H),  shape = aH , scale = bH), main = 'Hookworms',ylab='Density',xlab='Egg reduction rate (%)',xlim=c(max(100*LLH-10,0),min(100*ULH+10,100)),type='n')
          lines(100*(1-sort(H)), dgamma(sort(H), shape = aH , scale = bH), col = 1 , lty = 1)
          t <- seq(0,0.3,0.0001)
          t2 <- seq(0.3,0.4,0.0001)
          t3 <- seq(0.4,1,0.0001)
          polygon(c(100*(1-sort(t)),rev(100*(1-sort(t)))),c((dgamma(sort(t), shape = aH , scale = bH)),rev(rep(0,length(dgamma(sort(t), shape = aH , scale = bH))))),col="green", border=NA)
          polygon(c(100*(1-sort(t2)),rev(100*(1-sort(t2)))),c((dgamma(sort(t2), shape = aH , scale = bH)),rev(rep(0,length(dgamma(sort(t2), shape = aH , scale = bH))))),col="grey", border=NA)
          polygon(c(100*(1-sort(t3)),rev(100*(1-sort(t3)))),c((dgamma(sort(t3), shape = aH , scale = bH)),rev(rep(0,length(dgamma(sort(t3), shape = aH , scale = bH))))),col="red", border=NA)
          
          } else {
            par(mfrow=c(1,3))
            R <- rgamma(10000,shape = aR, scale = bR)
            plot(100*(1-sort(R)), dgamma(sort(R),  shape = aR , scale = bR), main='Roundworms',ylab='Density',xlab='Egg reduction rate (%)',xlim=c(max(100*LLR-10,0),min(100*ULR+10,100)),type='n')
            lines(100*(1-sort(R)), dgamma(sort(R), shape = aR , scale = bR), col = 1 , lty = 1)
            t <- seq(0,1-ULR,0.0001)
            t2 <- seq(1-ULR,1-LLR,0.0001)
            t3 <- seq(1-LLR,1,0.0001)
            polygon(c(100*(1-sort(t)),rev(100*(1-sort(t)))),c((dgamma(sort(t), shape = aR , scale = bR)),rev(rep(0,length(dgamma(sort(t), shape = aR , scale = bR))))),col="grey", border=NA)
            polygon(c(100*(1-sort(t2)),rev(100*(1-sort(t2)))),c((dgamma(sort(t2), shape = aR , scale = bR)),rev(rep(0,length(dgamma(sort(t2), shape = aR , scale = bR))))),col="white", border=NA)
            polygon(c(100*(1-sort(t3)),rev(100*(1-sort(t3)))),c((dgamma(sort(t3), shape = aR , scale = bR)),rev(rep(0,length(dgamma(sort(t3), shape = aR , scale = bR))))),col="grey", border=NA)
            
            T <- rgamma(10000,shape = aT, scale = bT)
            plot(100*(1-sort(T)), dgamma(sort(T),  shape = aT , scale = bT), main = 'Whipworms',ylab='Density',xlab='Egg reduction rate (%)',xlim=c(max(100*LLT-10,0),min(100*ULT+10,100)),type='n')
            lines(100*(1-sort(T)), dgamma(sort(T), shape = aT , scale = bT), col = 1 , lty = 1)
            t <- seq(0,1-ULT,0.0001)
            t2 <- seq(1-ULT,1-LLT,0.0001)
            t3 <- seq(1-LLT,1,0.0001)
            polygon(c(100*(1-sort(t)),rev(100*(1-sort(t)))),c((dgamma(sort(t), shape = aT , scale = bT)),rev(rep(0,length(dgamma(sort(t), shape = aT , scale = bT))))),col="grey", border=NA)
            polygon(c(100*(1-sort(t2)),rev(100*(1-sort(t2)))),c((dgamma(sort(t2), shape = aT , scale = bT)),rev(rep(0,length(dgamma(sort(t2), shape = aT , scale = bT))))),col="white", border=NA)
            polygon(c(100*(1-sort(t3)),rev(100*(1-sort(t3)))),c((dgamma(sort(t3), shape = aT , scale = bT)),rev(rep(0,length(dgamma(sort(t3), shape = aT , scale = bT))))),col="grey", border=NA)

            H <- rgamma(10000,shape = aH, scale = bH)
            plot(100*(1-sort(H)), dgamma(sort(H),  shape = aH , scale = bH), main = 'Hookworms',ylab='Density',xlab='Egg reduction rate (%)',xlim=c(max(100*LLH-10,0),min(100*ULH+10,100)),type='n')
            lines(100*(1-sort(H)), dgamma(sort(H), shape = aH , scale = bH), col = 1 , lty = 1)
            t <- seq(0,1-ULH,0.0001)
            t2 <- seq(1-ULH,1-LLH,0.0001)
            t3 <- seq(1-LLH,1,0.0001)
            polygon(c(100*(1-sort(t)),rev(100*(1-sort(t)))),c((dgamma(sort(t), shape = aH , scale = bH)),rev(rep(0,length(dgamma(sort(t), shape = aH , scale = bH))))),col="grey", border=NA)
            polygon(c(100*(1-sort(t2)),rev(100*(1-sort(t2)))),c((dgamma(sort(t2), shape = aH , scale = bH)),rev(rep(0,length(dgamma(sort(t2), shape = aH , scale = bH))))),col="white", border=NA)
            polygon(c(100*(1-sort(t3)),rev(100*(1-sort(t3)))),c((dgamma(sort(t3), shape = aH , scale = bH)),rev(rep(0,length(dgamma(sort(t3), shape = aH , scale = bH))))),col="grey", border=NA)
          
        }
          }
            
        } else { 
          if(mean(data$Rb)>-2 & mean(data$Tb)>-2 & mean(data$Rf)>-2 & mean(data$Tf)>-2)
          {
            data$RB <-  data[,input$Rbas]  
            data$TB <-  data[,input$Tbas]
            data$RF <-  data[,input$Rfol]  
            data$TF <-  data[,input$Tfol] 
            R <- subset(data, RB> 0 & RF >= 0)
            Tr <- subset(data, TB> 0 & TF >= 0)
            
            ERRR <- (1- mean(R$RF)/mean(R$RB))
            term1R <- (mean(R$RF)/mean(R$RB))**2; term2R <- ifelse(mean(R$RF)==0,0,var(R$RF)/mean(R$RF)**2); term3R <- var(R$RB)/mean(R$RB)**2
            term4R <- ifelse(mean(R$RF)==0,0,-2*cor(R$RB,R$RF)*sqrt(var(R$RF))*sqrt(var(R$RB))/(mean(R$RB)*mean(R$RF)))
            VARR <-  term1R*(term2R+term3R+term4R); varR <- VARR / length(R$RB)
            aR <- ((1-ERRR)**2)/varR; bR <- varR/(1-ERRR)
            ULR <- 1-qgamma(0.025,shape = aR, scale = bR)
            LLR <- 1-qgamma(0.975,shape = aR, scale = bR)
            
            ERRT <- (1- mean(Tr$TF)/mean(Tr$TB))
            term1T <- (mean(Tr$TF)/mean(Tr$TB))**2; term2T <- ifelse(mean(Tr$TF)==0,0,var(Tr$TF)/mean(Tr$TF)**2); term3T <- var(Tr$TB)/mean(Tr$TB)**2
            term4T <- ifelse(mean(Tr$TF)==0,0,-2*cor(Tr$TB,Tr$TF)*sqrt(var(Tr$TF))*sqrt(var(Tr$TB))/(mean(Tr$TB)*mean(Tr$TF)))
            VART <-  term1T*(term2T+term3T+term4T); varT <- VART / length(Tr$TB)
            aT <- ((1-ERRT)**2)/varT; bT <- varT/(1-ERRT)
            ULT <- 1-qgamma(0.025,shape = aT, scale = bT)
            LLT <- 1-qgamma(0.975,shape = aT, scale = bT)
            
            if(input$STHdrug == 1 | input$STHdrug == 2)
            {
            par(mfrow=c(1,2))
            R <- rgamma(10000,shape = aR, scale = bR)
            plot(100*(1-sort(R)), dgamma(sort(R),  shape = aR , scale = bR), main='Roundworms',ylab='Density',xlab='Egg reduction rate (%)',xlim=c(max(100*LLR-10,0),min(100*ULR+10,100)),type='n')
            lines(100*(1-sort(R)), dgamma(sort(R), shape = aR , scale = bR), col = 1 , lty = 1)
            t <- seq(0,0.05,0.0001)
            t2 <- seq(0.05,0.15,0.0001)
            t3 <- seq(0.15,1,0.0001)
            polygon(c(100*(1-sort(t)),rev(100*(1-sort(t)))),c((dgamma(sort(t), shape = aR , scale = bR)),rev(rep(0,length(dgamma(sort(t), shape = aR , scale = bR))))),col="green", border=NA)
            polygon(c(100*(1-sort(t2)),rev(100*(1-sort(t2)))),c((dgamma(sort(t2), shape = aR , scale = bR)),rev(rep(0,length(dgamma(sort(t2), shape = aR , scale = bR))))),col="grey", border=NA)
            polygon(c(100*(1-sort(t3)),rev(100*(1-sort(t3)))),c((dgamma(sort(t3), shape = aR , scale = bR)),rev(rep(0,length(dgamma(sort(t3), shape = aR , scale = bR))))),col="red", border=NA)
            
            T <- rgamma(10000,shape = aT, scale = bT)
            plot(100*(1-sort(T)), dgamma(sort(T),  shape = aT , scale = bT), main = 'Whipworms',ylab='Density',xlab='Egg reduction rate (%)',xlim=c(max(100*LLT-10,0),min(100*ULT+10,100)),type='n')
            lines(100*(1-sort(T)), dgamma(sort(T), shape = aT , scale = bT), col = 1 , lty = 1)
            t <- seq(0,0.5,0.0001)
            t2 <- seq(0.5,0.6,0.0001)
            t3 <- seq(0.6,1,0.0001)
            polygon(c(100*(1-sort(t)),rev(100*(1-sort(t)))),c((dgamma(sort(t), shape = aT , scale = bT)),rev(rep(0,length(dgamma(sort(t), shape = aT , scale = bT))))),col="green", border=NA)
            polygon(c(100*(1-sort(t2)),rev(100*(1-sort(t2)))),c((dgamma(sort(t2), shape = aT , scale = bT)),rev(rep(0,length(dgamma(sort(t2), shape = aT , scale = bT))))),col="grey", border=NA)
            polygon(c(100*(1-sort(t3)),rev(100*(1-sort(t3)))),c((dgamma(sort(t3), shape = aT , scale = bT)),rev(rep(0,length(dgamma(sort(t3), shape = aT , scale = bT))))),col="red", border=NA)
            } else {
              par(mfrow=c(1,2))
              R <- rgamma(10000,shape = aR, scale = bR)
              plot(100*(1-sort(R)), dgamma(sort(R),  shape = aR , scale = bR), main='Roundworms',ylab='Density',xlab='Egg reduction rate (%)',xlim=c(max(100*LLR-10,0),min(100*ULR+10,100)),type='n')
              lines(100*(1-sort(R)), dgamma(sort(R), shape = aR , scale = bR), col = 1 , lty = 1)
              t <- seq(0,1-ULR,0.0001)
              t2 <- seq(1-ULR,1-LLR,0.0001)
              t3 <- seq(1-LLR,1,0.0001)
              polygon(c(100*(1-sort(t)),rev(100*(1-sort(t)))),c((dgamma(sort(t), shape = aR , scale = bR)),rev(rep(0,length(dgamma(sort(t), shape = aR , scale = bR))))),col="grey", border=NA)
              polygon(c(100*(1-sort(t2)),rev(100*(1-sort(t2)))),c((dgamma(sort(t2), shape = aR , scale = bR)),rev(rep(0,length(dgamma(sort(t2), shape = aR , scale = bR))))),col="white", border=NA)
              polygon(c(100*(1-sort(t3)),rev(100*(1-sort(t3)))),c((dgamma(sort(t3), shape = aR , scale = bR)),rev(rep(0,length(dgamma(sort(t3), shape = aR , scale = bR))))),col="grey", border=NA)
              
              T <- rgamma(10000,shape = aT, scale = bT)
              plot(100*(1-sort(T)), dgamma(sort(T),  shape = aT , scale = bT), main = 'Whipworms',ylab='Density',xlab='Egg reduction rate (%)',xlim=c(max(100*LLT-10,0),min(100*ULT+10,100)),type='n')
              lines(100*(1-sort(T)), dgamma(sort(T), shape = aT , scale = bT), col = 1 , lty = 1)
              t <- seq(0,1-ULT,0.0001)
              t2 <- seq(1-ULT,1-LLT,0.0001)
              t3 <- seq(1-LLT,1,0.0001)
              polygon(c(100*(1-sort(t)),rev(100*(1-sort(t)))),c((dgamma(sort(t), shape = aT , scale = bT)),rev(rep(0,length(dgamma(sort(t), shape = aT , scale = bT))))),col="grey", border=NA)
              polygon(c(100*(1-sort(t2)),rev(100*(1-sort(t2)))),c((dgamma(sort(t2), shape = aT , scale = bT)),rev(rep(0,length(dgamma(sort(t2), shape = aT , scale = bT))))),col="white", border=NA)
              polygon(c(100*(1-sort(t3)),rev(100*(1-sort(t3)))),c((dgamma(sort(t3), shape = aT , scale = bT)),rev(rep(0,length(dgamma(sort(t3), shape = aT , scale = bT))))),col="grey", border=NA)
              
            }
            
            } else{  
            if(mean(data$Rb)>-2 & mean(data$Hb)>-2 & mean(data$Rf)>-2 & mean(data$Hf)>-2)
            {
              data$RB <-  data[,input$Rbas]  
              data$HB <-  data[,input$Hbas] 
              data$RF <-  data[,input$Rfol]  
              data$HF <-  data[,input$Hfol] 
              R <- subset(data, RB> 0 & RF >= 0)
              H <- subset(data, HB> 0 & HF >= 0)
              
              ERRR <- (1- mean(R$RF)/mean(R$RB))
              term1R <- (mean(R$RF)/mean(R$RB))**2; term2R <- ifelse(mean(R$RF)==0,0,var(R$RF)/mean(R$RF)**2); term3R <- var(R$RB)/mean(R$RB)**2
              term4R <- ifelse(mean(R$RF)==0,0,-2*cor(R$RB,R$RF)*sqrt(var(R$RF))*sqrt(var(R$RB))/(mean(R$RB)*mean(R$RF)))
              VARR <-  term1R*(term2R+term3R+term4R); varR <- VARR / length(R$RB)
              aR <- ((1-ERRR)**2)/varR; bR <- varR/(1-ERRR)
              ULR <- 1-qgamma(0.025,shape = aR, scale = bR)
              LLR <- 1-qgamma(0.975,shape = aR, scale = bR)
              
              ERRH <- (1- mean(H$HF[H$HB>0 & H$HF>=0])/mean(H$HB[H$HB>0 & H$HF>=0]))
              term1H <- (mean(H$HF)/mean(H$HB))**2; term2H <- ifelse(mean(H$HF)==0,0,var(H$HF)/mean(H$HF)**2); term3H <- var(H$HB)/mean(H$HB)**2
              term4H <- ifelse(mean(H$HF)==0,0,-2*cor(H$HB,H$HF)*sqrt(var(H$HF))*sqrt(var(H$HB))/(mean(H$HB)*mean(H$HF)))
              VARH <-  term1H*(term2H+term3H+term4H); varH <- VARH / length(H$HB)
              aH <- ((1-ERRH)**2)/varH; bH <- varH/(1-ERRH)
              ULH <- 1-qgamma(0.025,shape = aH, scale = bH)
              LLH <- 1-qgamma(0.975,shape = aH, scale = bH)
              
             if (input$STHdrug==1){  
              par(mfrow=c(1,2))
              R <- rgamma(10000,shape = aR, scale = bR)
              plot(100*(1-sort(R)), dgamma(sort(R),  shape = aR , scale = bR), main='Roundworms',ylab='Density',xlab='Egg reduction rate (%)',xlim=c(max(100*LLR-10,0),min(100*ULR+10,100)),type='n')
              lines(100*(1-sort(R)), dgamma(sort(R), shape = aR , scale = bR), col = 1 , lty = 1)
              t <- seq(0,0.05,0.0001)
              t2 <- seq(0.05,0.15,0.0001)
              t3 <- seq(0.15,1,0.0001)
              polygon(c(100*(1-sort(t)),rev(100*(1-sort(t)))),c((dgamma(sort(t), shape = aR , scale = bR)),rev(rep(0,length(dgamma(sort(t), shape = aR , scale = bR))))),col="green", border=NA)
              polygon(c(100*(1-sort(t2)),rev(100*(1-sort(t2)))),c((dgamma(sort(t2), shape = aR , scale = bR)),rev(rep(0,length(dgamma(sort(t2), shape = aR , scale = bR))))),col="grey", border=NA)
              polygon(c(100*(1-sort(t3)),rev(100*(1-sort(t3)))),c((dgamma(sort(t3), shape = aR , scale = bR)),rev(rep(0,length(dgamma(sort(t3), shape = aR , scale = bR))))),col="red", border=NA)
              
                H <- rgamma(10000,shape = aH, scale = bH)
                plot(100*(1-sort(H)), dgamma(sort(H),  shape = aH , scale = bH), main = 'Hookworms',ylab='Density',xlab='Egg reduction rate (%)',xlim=c(max(100*LLH-10,0),min(100*ULH+10,100)),type='n')
                lines(100*(1-sort(H)), dgamma(sort(H), shape = aH , scale = bH), col = 1 , lty = 1)
                t <- seq(0,0.1,0.0001)
                t2 <- seq(0.1,0.2,0.0001)
                t3 <- seq(0.2,1,0.0001)
                polygon(c(100*(1-sort(t)),rev(100*(1-sort(t)))),c((dgamma(sort(t), shape = aH , scale = bH)),rev(rep(0,length(dgamma(sort(t), shape = aH , scale = bH))))),col="green", border=NA)
                polygon(c(100*(1-sort(t2)),rev(100*(1-sort(t2)))),c((dgamma(sort(t2), shape = aH , scale = bH)),rev(rep(0,length(dgamma(sort(t2), shape = aH , scale = bH))))),col="grey", border=NA)
                polygon(c(100*(1-sort(t3)),rev(100*(1-sort(t3)))),c((dgamma(sort(t3), shape = aH , scale = bH)),rev(rep(0,length(dgamma(sort(t3), shape = aH , scale = bH))))),col="red", border=NA)
              
              } else {
              if(input$STHdrug == 2)
              {
                par(mfrow=c(1,2))
                R <- rgamma(10000,shape = aR, scale = bR)
                plot(100*(1-sort(R)), dgamma(sort(R),  shape = aR , scale = bR), main='Roundworms',ylab='Density',xlab='Egg reduction rate (%)',xlim=c(max(100*LLR-10,0),min(100*ULR+10,100)),type='n')
                lines(100*(1-sort(R)), dgamma(sort(R), shape = aR , scale = bR), col = 1 , lty = 1)
                t <- seq(0,0.05,0.0001)
                t2 <- seq(0.05,0.15,0.0001)
                t3 <- seq(0.15,1,0.0001)
                polygon(c(100*(1-sort(t)),rev(100*(1-sort(t)))),c((dgamma(sort(t), shape = aR , scale = bR)),rev(rep(0,length(dgamma(sort(t), shape = aR , scale = bR))))),col="green", border=NA)
                polygon(c(100*(1-sort(t2)),rev(100*(1-sort(t2)))),c((dgamma(sort(t2), shape = aR , scale = bR)),rev(rep(0,length(dgamma(sort(t2), shape = aR , scale = bR))))),col="grey", border=NA)
                polygon(c(100*(1-sort(t3)),rev(100*(1-sort(t3)))),c((dgamma(sort(t3), shape = aR , scale = bR)),rev(rep(0,length(dgamma(sort(t3), shape = aR , scale = bR))))),col="red", border=NA)
                
                
              H <- rgamma(10000,shape = aH, scale = bH)
              plot(100*(1-sort(H)), dgamma(sort(H),  shape = aH , scale = bH), main = 'Hookworms',ylab='Density',xlab='Egg reduction rate (%)',xlim=c(max(100*LLH-10,0),min(100*ULH+10,100)),type='n')
              lines(100*(1-sort(H)), dgamma(sort(H), shape = aH , scale = bH), col = 1 , lty = 1)
              t <- seq(0,0.3,0.0001)
              t2 <- seq(0.3,0.4,0.0001)
              t3 <- seq(0.4,1,0.0001)
              polygon(c(100*(1-sort(t)),rev(100*(1-sort(t)))),c((dgamma(sort(t), shape = aH , scale = bH)),rev(rep(0,length(dgamma(sort(t), shape = aH , scale = bH))))),col="green", border=NA)
              polygon(c(100*(1-sort(t2)),rev(100*(1-sort(t2)))),c((dgamma(sort(t2), shape = aH , scale = bH)),rev(rep(0,length(dgamma(sort(t2), shape = aH , scale = bH))))),col="grey", border=NA)
              polygon(c(100*(1-sort(t3)),rev(100*(1-sort(t3)))),c((dgamma(sort(t3), shape = aH , scale = bH)),rev(rep(0,length(dgamma(sort(t3), shape = aH , scale = bH))))),col="red", border=NA)
              } else {
                par(mfrow=c(1,2))
                R <- rgamma(10000,shape = aR, scale = bR)
                plot(100*(1-sort(R)), dgamma(sort(R),  shape = aR , scale = bR), main='Roundworms',ylab='Density',xlab='Egg reduction rate (%)',xlim=c(max(100*LLR-10,0),min(100*ULR+10,100)),type='n')
                lines(100*(1-sort(R)), dgamma(sort(R), shape = aR , scale = bR), col = 1 , lty = 1)
                t <- seq(0,1-ULR,0.0001)
                t2 <- seq(1-ULR,1-LLR,0.0001)
                t3 <- seq(1-LLR,1,0.0001)
                polygon(c(100*(1-sort(t)),rev(100*(1-sort(t)))),c((dgamma(sort(t), shape = aR , scale = bR)),rev(rep(0,length(dgamma(sort(t), shape = aR , scale = bR))))),col="grey", border=NA)
                polygon(c(100*(1-sort(t2)),rev(100*(1-sort(t2)))),c((dgamma(sort(t2), shape = aR , scale = bR)),rev(rep(0,length(dgamma(sort(t2), shape = aR , scale = bR))))),col="white", border=NA)
                polygon(c(100*(1-sort(t3)),rev(100*(1-sort(t3)))),c((dgamma(sort(t3), shape = aR , scale = bR)),rev(rep(0,length(dgamma(sort(t3), shape = aR , scale = bR))))),col="grey", border=NA)
      
                H <- rgamma(10000,shape = aH, scale = bH)
                plot(100*(1-sort(H)), dgamma(sort(H),  shape = aH , scale = bH), main = 'Hookworms',ylab='Density',xlab='Egg reduction rate (%)',xlim=c(max(100*LLH-10,0),min(100*ULH+10,100)),type='n')
                lines(100*(1-sort(H)), dgamma(sort(H), shape = aH , scale = bH), col = 1 , lty = 1)
                t <- seq(0,1-ULH,0.0001)
                t2 <- seq(1-ULH,1-LLH,0.0001)
                t3 <- seq(1-LLH,1,0.0001)
                polygon(c(100*(1-sort(t)),rev(100*(1-sort(t)))),c((dgamma(sort(t), shape = aH , scale = bH)),rev(rep(0,length(dgamma(sort(t), shape = aH , scale = bH))))),col="grey", border=NA)
                polygon(c(100*(1-sort(t2)),rev(100*(1-sort(t2)))),c((dgamma(sort(t2), shape = aH , scale = bH)),rev(rep(0,length(dgamma(sort(t2), shape = aH , scale = bH))))),col="white", border=NA)
                polygon(c(100*(1-sort(t3)),rev(100*(1-sort(t3)))),c((dgamma(sort(t3), shape = aH , scale = bH)),rev(rep(0,length(dgamma(sort(t3), shape = aH , scale = bH))))),col="grey", border=NA)
              }
                
              }   
            }  else{  
              if(mean(data$Tb)>-2 & mean(data$Hb)>-2 & mean(data$Tf)>-2 & mean(data$Hf)>-2)
              {
                data$TB <-  data[,input$Tbas]
                data$HB <-  data[,input$Hbas] 
                data$TF <-  data[,input$Tfol] 
                data$HF <-  data[,input$Hfol] 
                Tr <- subset(data, TB> 0 & TF >= 0)
                H <- subset(data, HB> 0 & HF >= 0)
                
                ERRT <- (1- mean(Tr$TF)/mean(Tr$TB))
                term1T <- (mean(Tr$TF)/mean(Tr$TB))**2; term2T <- ifelse(mean(Tr$TF)==0,0,var(Tr$TF)/mean(Tr$TF)**2); term3T <- var(Tr$TB)/mean(Tr$TB)**2
                term4T <- ifelse(mean(Tr$TF)==0,0,-2*cor(Tr$TB,Tr$TF)*sqrt(var(Tr$TF))*sqrt(var(Tr$TB))/(mean(Tr$TB)*mean(Tr$TF)))
                VART <-  term1T*(term2T+term3T+term4T); varT <- VART / length(Tr$TB)
                aT <- ((1-ERRT)**2)/varT; bT <- varT/(1-ERRT)
                ULT <- 1-qgamma(0.025,shape = aT, scale = bT)
                LLT <- 1-qgamma(0.975,shape = aT, scale = bT)
                
                ERRH <- (1- mean(H$HF[H$HB>0 & H$HF>=0])/mean(H$HB[H$HB>0 & H$HF>=0]))
                term1H <- (mean(H$HF)/mean(H$HB))**2; term2H <- ifelse(mean(H$HF)==0,0,var(H$HF)/mean(H$HF)**2); term3H <- var(H$HB)/mean(H$HB)**2
                term4H <- ifelse(mean(H$HF)==0,0,-2*cor(H$HB,H$HF)*sqrt(var(H$HF))*sqrt(var(H$HB))/(mean(H$HB)*mean(H$HF)))
                VARH <-  term1H*(term2H+term3H+term4H); varH <- VARH / length(H$HB)
                aH <- ((1-ERRH)**2)/varH; bH <- varH/(1-ERRH)
                ULH <- 1-qgamma(0.025,shape = aH, scale = bH)
                LLH <- 1-qgamma(0.975,shape = aH, scale = bH)
                
                if(input$STHdrug == 1)
                {
                par(mfrow=c(1,2))
                T <- rgamma(10000,shape = aT, scale = bT)
                plot(100*(1-sort(T)), dgamma(sort(T),  shape = aT , scale = bT), main = 'Whipworms',ylab='Density',xlab='Egg reduction rate (%)',xlim=c(max(100*LLT-10,0),min(100*ULT+10,100)),type='n')
                lines(100*(1-sort(T)), dgamma(sort(T), shape = aT , scale = bT), col = 1 , lty = 1)
                t <- seq(0,0.5,0.0001)
                t2 <- seq(0.5,0.6,0.0001)
                t3 <- seq(0.6,1,0.0001)
                polygon(c(100*(1-sort(t)),rev(100*(1-sort(t)))),c((dgamma(sort(t), shape = aT , scale = bT)),rev(rep(0,length(dgamma(sort(t), shape = aT , scale = bT))))),col="green", border=NA)
                polygon(c(100*(1-sort(t2)),rev(100*(1-sort(t2)))),c((dgamma(sort(t2), shape = aT , scale = bT)),rev(rep(0,length(dgamma(sort(t2), shape = aT , scale = bT))))),col="grey", border=NA)
                polygon(c(100*(1-sort(t3)),rev(100*(1-sort(t3)))),c((dgamma(sort(t3), shape = aT , scale = bT)),rev(rep(0,length(dgamma(sort(t3), shape = aT , scale = bT))))),col="red", border=NA)
               
                 H <- rgamma(10000,shape = aH, scale = bH)
                plot(100*(1-sort(H)), dgamma(sort(H),  shape = aH , scale = bH), main = 'Hookworms',ylab='Density',xlab='Egg reduction rate (%)',xlim=c(max(100*LLH-10,0),min(100*ULH+10,100)),type='n')
                lines(100*(1-sort(H)), dgamma(sort(H), shape = aH , scale = bH), col = 1 , lty = 1)
                t <- seq(0,0.1,0.0001)
                t2 <- seq(0.1,0.2,0.0001)
                t3 <- seq(0.2,1,0.0001)
                polygon(c(100*(1-sort(t)),rev(100*(1-sort(t)))),c((dgamma(sort(t), shape = aH , scale = bH)),rev(rep(0,length(dgamma(sort(t), shape = aH , scale = bH))))),col="green", border=NA)
                polygon(c(100*(1-sort(t2)),rev(100*(1-sort(t2)))),c((dgamma(sort(t2), shape = aH , scale = bH)),rev(rep(0,length(dgamma(sort(t2), shape = aH , scale = bH))))),col="grey", border=NA)
                polygon(c(100*(1-sort(t3)),rev(100*(1-sort(t3)))),c((dgamma(sort(t3), shape = aH , scale = bH)),rev(rep(0,length(dgamma(sort(t3), shape = aH , scale = bH))))),col="red", border=NA)
                
                } else {
                if (input$STHdrug==2){ 
                  par(mfrow=c(1,2))
                  T <- rgamma(10000,shape = aT, scale = bT)
                  plot(100*(1-sort(T)), dgamma(sort(T),  shape = aT , scale = bT), main = 'Whipworms',ylab='Density',xlab='Egg reduction rate (%)',xlim=c(max(100*LLT-10,0),min(100*ULT+10,100)),type='n')
                  lines(100*(1-sort(T)), dgamma(sort(T), shape = aT , scale = bT), col = 1 , lty = 1)
                  t <- seq(0,0.5,0.0001)
                  t2 <- seq(0.5,0.6,0.0001)
                  t3 <- seq(0.6,1,0.0001)
                  polygon(c(100*(1-sort(t)),rev(100*(1-sort(t)))),c((dgamma(sort(t), shape = aT , scale = bT)),rev(rep(0,length(dgamma(sort(t), shape = aT , scale = bT))))),col="green", border=NA)
                  polygon(c(100*(1-sort(t2)),rev(100*(1-sort(t2)))),c((dgamma(sort(t2), shape = aT , scale = bT)),rev(rep(0,length(dgamma(sort(t2), shape = aT , scale = bT))))),col="grey", border=NA)
                  polygon(c(100*(1-sort(t3)),rev(100*(1-sort(t3)))),c((dgamma(sort(t3), shape = aT , scale = bT)),rev(rep(0,length(dgamma(sort(t3), shape = aT , scale = bT))))),col="red", border=NA)
                  
                  H <- rgamma(10000,shape = aH, scale = bH)
                  plot(100*(1-sort(H)), dgamma(sort(H),  shape = aH , scale = bH), main = 'Hookworms',ylab='Density',xlab='Egg reduction rate (%)',xlim=c(max(100*LLH-10,0),min(100*ULH+10,100)),type='n')
                  lines(100*(1-sort(H)), dgamma(sort(H), shape = aH , scale = bH), col = 1 , lty = 1)
                  t <- seq(0,0.3,0.0001)
                  t2 <- seq(0.3,0.4,0.0001)
                  t3 <- seq(0.4,1,0.0001)
                  polygon(c(100*(1-sort(t)),rev(100*(1-sort(t)))),c((dgamma(sort(t), shape = aH , scale = bH)),rev(rep(0,length(dgamma(sort(t), shape = aH , scale = bH))))),col="green", border=NA)
                  polygon(c(100*(1-sort(t2)),rev(100*(1-sort(t2)))),c((dgamma(sort(t2), shape = aH , scale = bH)),rev(rep(0,length(dgamma(sort(t2), shape = aH , scale = bH))))),col="grey", border=NA)
                  polygon(c(100*(1-sort(t3)),rev(100*(1-sort(t3)))),c((dgamma(sort(t3), shape = aH , scale = bH)),rev(rep(0,length(dgamma(sort(t3), shape = aH , scale = bH))))),col="red", border=NA)
                } else {           
                par(mfrow=c(1,2))
                T <- rgamma(10000,shape = aT, scale = bT)
                plot(100*(1-sort(T)), dgamma(sort(T),  shape = aT , scale = bT), main = 'Whipworms',ylab='Density',xlab='Egg reduction rate (%)',xlim=c(max(100*LLT-10,0),min(100*ULT+10,100)),type='n')
                lines(100*(1-sort(T)), dgamma(sort(T), shape = aT , scale = bT), col = 1 , lty = 1)
                t <- seq(0,1-ULT,0.0001)
                t2 <- seq(1-ULT,1-LLT,0.0001)
                t3 <- seq(1-LLT,1,0.0001)
                polygon(c(100*(1-sort(t)),rev(100*(1-sort(t)))),c((dgamma(sort(t), shape = aT , scale = bT)),rev(rep(0,length(dgamma(sort(t), shape = aT , scale = bT))))),col="grey", border=NA)
                polygon(c(100*(1-sort(t2)),rev(100*(1-sort(t2)))),c((dgamma(sort(t2), shape = aT , scale = bT)),rev(rep(0,length(dgamma(sort(t2), shape = aT , scale = bT))))),col="white", border=NA)
                polygon(c(100*(1-sort(t3)),rev(100*(1-sort(t3)))),c((dgamma(sort(t3), shape = aT , scale = bT)),rev(rep(0,length(dgamma(sort(t3), shape = aT , scale = bT))))),col="grey", border=NA)
                
                H <- rgamma(10000,shape = aH, scale = bH)
                plot(100*(1-sort(H)), dgamma(sort(H),  shape = aH , scale = bH), main = 'Hookworms',ylab='Density',xlab='Egg reduction rate (%)',xlim=c(max(100*LLH-10,0),min(100*ULH+10,100)),type='n')
                lines(100*(1-sort(H)), dgamma(sort(H), shape = aH , scale = bH), col = 1 , lty = 1)
                t <- seq(0,1-ULH,0.0001)
                t2 <- seq(1-ULH,1-LLH,0.0001)
                t3 <- seq(1-LLH,1,0.0001)
                polygon(c(100*(1-sort(t)),rev(100*(1-sort(t)))),c((dgamma(sort(t), shape = aH , scale = bH)),rev(rep(0,length(dgamma(sort(t), shape = aH , scale = bH))))),col="grey", border=NA)
                polygon(c(100*(1-sort(t2)),rev(100*(1-sort(t2)))),c((dgamma(sort(t2), shape = aH , scale = bH)),rev(rep(0,length(dgamma(sort(t2), shape = aH , scale = bH))))),col="white", border=NA)
                polygon(c(100*(1-sort(t3)),rev(100*(1-sort(t3)))),c((dgamma(sort(t3), shape = aH , scale = bH)),rev(rep(0,length(dgamma(sort(t3), shape = aH , scale = bH))))),col="grey", border=NA)
                }
                }  
              } else {  
                if(mean(data$Rb)>-2 & mean(data$Rf)>-2)
                {
                  data$RB <-  data[,input$Rbas]  
                  data$RF <-  data[,input$Rfol]  
                  R <- subset(data, RB> 0 & RF >= 0)
                  
                  ERRR <- (1- mean(R$RF)/mean(R$RB))
                  term1R <- (mean(R$RF)/mean(R$RB))**2; term2R <- ifelse(mean(R$RF)==0,0,var(R$RF)/mean(R$RF)**2); term3R <- var(R$RB)/mean(R$RB)**2
                  term4R <- ifelse(mean(R$RF)==0,0,-2*cor(R$RB,R$RF)*sqrt(var(R$RF))*sqrt(var(R$RB))/(mean(R$RB)*mean(R$RF)))
                  VARR <-  term1R*(term2R+term3R+term4R); varR <- VARR / length(R$RB)
                  aR <- ((1-ERRR)**2)/varR; bR <- varR/(1-ERRR)
                  ULR <- 1-qgamma(0.025,shape = aR, scale = bR)
                  LLR <- 1-qgamma(0.975,shape = aR, scale = bR)
                  
                  if(input$STHdrug == 1 | input$STHdrug ==2){
                  par(mfrow=c(1,1))
                  R <- rgamma(10000,shape = aR, scale = bR)
                  plot(100*(1-sort(R)), dgamma(sort(R),  shape = aR , scale = bR), main='Roundworms',ylab='Density',xlab='Egg reduction rate (%)',xlim=c(max(100*LLR-10,0),min(100*ULR+10,100)),type='n')
                  lines(100*(1-sort(R)), dgamma(sort(R), shape = aR , scale = bR), col = 1 , lty = 1)
                  t <- seq(0,0.05,0.0001)
                  t2 <- seq(0.05,0.15,0.0001)
                  t3 <- seq(0.15,1,0.0001)
                  polygon(c(100*(1-sort(t)),rev(100*(1-sort(t)))),c((dgamma(sort(t), shape = aR , scale = bR)),rev(rep(0,length(dgamma(sort(t), shape = aR , scale = bR))))),col="green", border=NA)
                  polygon(c(100*(1-sort(t2)),rev(100*(1-sort(t2)))),c((dgamma(sort(t2), shape = aR , scale = bR)),rev(rep(0,length(dgamma(sort(t2), shape = aR , scale = bR))))),col="grey", border=NA)
                  polygon(c(100*(1-sort(t3)),rev(100*(1-sort(t3)))),c((dgamma(sort(t3), shape = aR , scale = bR)),rev(rep(0,length(dgamma(sort(t3), shape = aR , scale = bR))))),col="red", border=NA)
                  }
                  else {
                    par(mfrow=c(1,1))
                    R <- rgamma(10000,shape = aR, scale = bR)
                    plot(100*(1-sort(R)), dgamma(sort(R),  shape = aR , scale = bR), main='Roundworms',ylab='Density',xlab='Egg reduction rate (%)',xlim=c(max(100*LLR-10,0),min(100*ULR+10,100)),type='n')
                    lines(100*(1-sort(R)), dgamma(sort(R), shape = aR , scale = bR), col = 1 , lty = 1)
                    t <- seq(0,1-ULR,0.0001)
                    t2 <- seq(1-ULR,1-LLR,0.0001)
                    t3 <- seq(1-LLR,1,0.0001)
                    polygon(c(100*(1-sort(t)),rev(100*(1-sort(t)))),c((dgamma(sort(t), shape = aR , scale = bR)),rev(rep(0,length(dgamma(sort(t), shape = aR , scale = bR))))),col="grey", border=NA)
                    polygon(c(100*(1-sort(t2)),rev(100*(1-sort(t2)))),c((dgamma(sort(t2), shape = aR , scale = bR)),rev(rep(0,length(dgamma(sort(t2), shape = aR , scale = bR))))),col="white", border=NA)
                    polygon(c(100*(1-sort(t3)),rev(100*(1-sort(t3)))),c((dgamma(sort(t3), shape = aR , scale = bR)),rev(rep(0,length(dgamma(sort(t3), shape = aR , scale = bR))))),col="grey", border=NA)
                  }
                  
                  } else{  
                    if(mean(data$Tb)>-2 & mean(data$Tf)>-2)
                    {
                      data$TB <-  data[,input$Tbas]
                      data$TF <-  data[,input$Tfol] 
                      Tr <- subset(data, TB> 0 & TF >= 0)
                      
                      ERRT <- (1- mean(Tr$TF)/mean(Tr$TB))
                      term1T <- (mean(Tr$TF)/mean(Tr$TB))**2; term2T <- ifelse(mean(Tr$TF)==0,0,var(Tr$TF)/mean(Tr$TF)**2); term3T <- var(Tr$TB)/mean(Tr$TB)**2
                      term4T <- ifelse(mean(Tr$TF)==0,0,-2*cor(Tr$TB,Tr$TF)*sqrt(var(Tr$TF))*sqrt(var(Tr$TB))/(mean(Tr$TB)*mean(Tr$TF)))
                      VART <-  term1T*(term2T+term3T+term4T); varT <- VART / length(Tr$TB)
                      aT <- ((1-ERRT)**2)/varT; bT <- varT/(1-ERRT)
                      ULT <- 1-qgamma(0.025,shape = aT, scale = bT)
                      LLT <- 1-qgamma(0.975,shape = aT, scale = bT)
                      
                      if(input$STHdrug == 1 | input$STHdrug ==2){
                      par(mfrow=c(1,1))
                      T <- rgamma(10000,shape = aT, scale = bT)
                      plot(100*(1-sort(T)), dgamma(sort(T),  shape = aT , scale = bT), main = 'Whipworms',ylab='Density',xlab='Egg reduction rate (%)',xlim=c(max(100*LLT-10,0),min(100*ULT+10,100)),type='n')
                      lines(100*(1-sort(T)), dgamma(sort(T), shape = aT , scale = bT), col = 1 , lty = 1)
                      t <- seq(0,0.5,0.0001)
                      t2 <- seq(0.5,0.6,0.0001)
                      t3 <- seq(0.6,1,0.0001)
                      polygon(c(100*(1-sort(t)),rev(100*(1-sort(t)))),c((dgamma(sort(t), shape = aT , scale = bT)),rev(rep(0,length(dgamma(sort(t), shape = aT , scale = bT))))),col="green", border=NA)
                      polygon(c(100*(1-sort(t2)),rev(100*(1-sort(t2)))),c((dgamma(sort(t2), shape = aT , scale = bT)),rev(rep(0,length(dgamma(sort(t2), shape = aT , scale = bT))))),col="grey", border=NA)
                      polygon(c(100*(1-sort(t3)),rev(100*(1-sort(t3)))),c((dgamma(sort(t3), shape = aT , scale = bT)),rev(rep(0,length(dgamma(sort(t3), shape = aT , scale = bT))))),col="red", border=NA)
                      } else {
                      par(mfrow=c(1,1)) 
                        T <- rgamma(10000,shape = aT, scale = bT)
                        plot(100*(1-sort(T)), dgamma(sort(T),  shape = aT , scale = bT), main = 'Whipworms',ylab='Density',xlab='Egg reduction rate (%)',xlim=c(max(100*LLT-10,0),min(100*ULT+10,100)),type='n')
                        lines(100*(1-sort(T)), dgamma(sort(T), shape = aT , scale = bT), col = 1 , lty = 1)
                        t <- seq(0,1-ULT,0.0001)
                        t2 <- seq(1-ULT,1-LLT,0.0001)
                        t3 <- seq(1-LLT,1,0.0001)
                        polygon(c(100*(1-sort(t)),rev(100*(1-sort(t)))),c((dgamma(sort(t), shape = aT , scale = bT)),rev(rep(0,length(dgamma(sort(t), shape = aT , scale = bT))))),col="grey", border=NA)
                        polygon(c(100*(1-sort(t2)),rev(100*(1-sort(t2)))),c((dgamma(sort(t2), shape = aT , scale = bT)),rev(rep(0,length(dgamma(sort(t2), shape = aT , scale = bT))))),col="white", border=NA)
                        polygon(c(100*(1-sort(t3)),rev(100*(1-sort(t3)))),c((dgamma(sort(t3), shape = aT , scale = bT)),rev(rep(0,length(dgamma(sort(t3), shape = aT , scale = bT))))),col="grey", border=NA)
                        
                      }
                      
                      } else {  
                    if(mean(data$Hb)>-2 & mean(data$Hf)>-2)
                    {
                      data$HB <-  data[,input$Hbas] 
                      data$HF <-  data[,input$Hfol] 
                      H <- subset(data, HB> 0 & HF >= 0)
                      
                      ERRH <- (1- mean(H$HF[H$HB>0 & H$HF>=0])/mean(H$HB[H$HB>0 & H$HF>=0]))
                      term1H <- (mean(H$HF)/mean(H$HB))**2; term2H <- ifelse(mean(H$HF)==0,0,var(H$HF)/mean(H$HF)**2); term3H <- var(H$HB)/mean(H$HB)**2
                      term4H <- ifelse(mean(H$HF)==0,0,-2*cor(H$HB,H$HF)*sqrt(var(H$HF))*sqrt(var(H$HB))/(mean(H$HB)*mean(H$HF)))
                      VARH <-  term1H*(term2H+term3H+term4H); varH <- VARH / length(H$HB)
                      aH <- ((1-ERRH)**2)/varH; bH <- varH/(1-ERRH)
                      ULH <- 1-qgamma(0.025,shape = aH, scale = bH)
                      LLH <- 1-qgamma(0.975,shape = aH, scale = bH)
                      
                      par(mfrow=c(1,1))
                      if (input$STHdrug==1){ 
                        H <- rgamma(10000,shape = aH, scale = bH)
                        plot(100*(1-sort(H)), dgamma(sort(H),  shape = aH , scale = bH), main = 'Hookworms',ylab='Density',xlab='Egg reduction rate (%)',xlim=c(max(100*LLH-10,0),min(100*ULH+10,100)),type='n')
                        lines(100*(1-sort(H)), dgamma(sort(H), shape = aH , scale = bH), col = 1 , lty = 1)
                        t <- seq(0,0.1,0.0001)
                        t2 <- seq(0.1,0.2,0.0001)
                        t3 <- seq(0.2,1,0.0001)
                        polygon(c(100*(1-sort(t)),rev(100*(1-sort(t)))),c((dgamma(sort(t), shape = aH , scale = bH)),rev(rep(0,length(dgamma(sort(t), shape = aH , scale = bH))))),col="green", border=NA)
                        polygon(c(100*(1-sort(t2)),rev(100*(1-sort(t2)))),c((dgamma(sort(t2), shape = aH , scale = bH)),rev(rep(0,length(dgamma(sort(t2), shape = aH , scale = bH))))),col="grey", border=NA)
                        polygon(c(100*(1-sort(t3)),rev(100*(1-sort(t3)))),c((dgamma(sort(t3), shape = aH , scale = bH)),rev(rep(0,length(dgamma(sort(t3), shape = aH , scale = bH))))),col="red", border=NA)
                      } else {
                      if(input$STHdrug == 2){
                      H <- rgamma(10000,shape = aH, scale = bH)
                      plot(100*(1-sort(H)), dgamma(sort(H),  shape = aH , scale = bH), main = 'Hookworms',ylab='Density',xlab='Egg reduction rate (%)',xlim=c(max(100*LLH-10,0),min(100*ULH+10,100)),type='n')
                      lines(100*(1-sort(H)), dgamma(sort(H), shape = aH , scale = bH), col = 1 , lty = 1)
                      t <- seq(0,0.3,0.0001)
                      t2 <- seq(0.3,0.4,0.0001)
                      t3 <- seq(0.4,1,0.0001)
                      polygon(c(100*(1-sort(t)),rev(100*(1-sort(t)))),c((dgamma(sort(t), shape = aH , scale = bH)),rev(rep(0,length(dgamma(sort(t), shape = aH , scale = bH))))),col="green", border=NA)
                      polygon(c(100*(1-sort(t2)),rev(100*(1-sort(t2)))),c((dgamma(sort(t2), shape = aH , scale = bH)),rev(rep(0,length(dgamma(sort(t2), shape = aH , scale = bH))))),col="grey", border=NA)
                      polygon(c(100*(1-sort(t3)),rev(100*(1-sort(t3)))),c((dgamma(sort(t3), shape = aH , scale = bH)),rev(rep(0,length(dgamma(sort(t3), shape = aH , scale = bH))))),col="red", border=NA)
                      } else { 
                        H <- rgamma(10000,shape = aH, scale = bH)
                    plot(100*(1-sort(H)), dgamma(sort(H),  shape = aH , scale = bH), main = 'Hookworms',ylab='Density',xlab='Egg reduction rate (%)',xlim=c(max(100*LLH-10,0),min(100*ULH+10,100)),type='n')
                    lines(100*(1-sort(H)), dgamma(sort(H), shape = aH , scale = bH), col = 1 , lty = 1)
                    t <- seq(0,1-ULH,0.0001)
                    t2 <- seq(1-ULH,1-LLH,0.0001)
                    t3 <- seq(1-LLH,1,0.0001)
                    polygon(c(100*(1-sort(t)),rev(100*(1-sort(t)))),c((dgamma(sort(t), shape = aH , scale = bH)),rev(rep(0,length(dgamma(sort(t), shape = aH , scale = bH))))),col="grey", border=NA)
                    polygon(c(100*(1-sort(t2)),rev(100*(1-sort(t2)))),c((dgamma(sort(t2), shape = aH , scale = bH)),rev(rep(0,length(dgamma(sort(t2), shape = aH , scale = bH))))),col="white", border=NA)
                    polygon(c(100*(1-sort(t3)),rev(100*(1-sort(t3)))),c((dgamma(sort(t3), shape = aH , scale = bH)),rev(rep(0,length(dgamma(sort(t3), shape = aH , scale = bH))))),col="grey", border=NA)
                      }
                      } 
                    }
                  }
                }
                
                
              }
              
              
            }
            
          }
        }   
        
      }   
      
    }
@


\section{Conclusions}
<<echo = FALSE>>=
    inFile <- input$file1
    if (is.null(inFile))
    {concl <- paste0('Data was not provided.')
      } else
      # Schistosomiasis
    {if (input$NTD=='1')
    {data <- read.xlsx(inFile$datapath,1)
    data$n <- 1
    n <- length(data[,1])
    # S haematobium
    data$sh <- ifelse(input$Shbas=='Not recorded',rep(-2,n), ifelse(data[,input$Shbas]>0,1,0))
    data$shF <- ifelse(input$Shfol=='Not recorded',rep(-2,n), ifelse(data[,input$Shfol]>=0,1,0))
    
    # S mansoni
    data$sm <- ifelse(input$Smbas=='Not recorded',rep(-2,n), ifelse(data[,input$Smbas]>0,1,0))
    data$smF <- ifelse(input$Smfol=='Not recorded',rep(-2,n), ifelse(data[,input$Smfol]>=0,1,0))
    
    # S japonicum
    data$sj <- ifelse(input$Sjbas=='Not recorded',rep(-2,n), ifelse(data[,input$Sjbas]>0,1,0))
    data$sjF <- ifelse(input$Sjfol=='Not recorded',rep(-2,n), ifelse(data[,input$Sjfol]>=0,1,0))
    data$inf <- mean(ifelse(data$sh > -2 | data$sm > -2 | data$sj > -2, 1, 0))
    
    if(mean(data$inf)==0) {paste('Please provide egg count data.')}
    else {
      if(mean(data$sh)>-2 & mean(data$sm)>-2 & mean(data$shF)>-2 & mean(data$smF)>-2)
      {
        data$shB <-  data[,input$Shbas]  
        data$smB <-  data[,input$Smbas] 
        data$shF <-  data[,input$Shfol]  
        data$smF <-  data[,input$Smfol] 
        sh <- subset(data, shB >0 &  shF >=0)
        sm <- subset(data, smB >0 &  smF >=0)
        ERRSH <- 100*(1- mean(sh$shF)/mean(sh$shB))
        #term1SH <- (mean(sh$shF)/mean(sh$shB))**2; term2SH <- ifelse(mean(sh$shF)==0,0,var(sh$shF)/mean(sh$shF)**2); term3SH <- var(sh$shB)/mean(sh$shB)**2
        #term4SH <- ifelse(mean(sh$shF)==0,0,-2*cor(sh$shB,sh$shF)*sqrt(var(sh$shF))*sqrt(var(sh$shB))/(mean(sh$shB)*mean(sh$shF)))
        #VARSH <-  term1SH*(term2SH+term3SH+term4SH); varSH <- VARSH / length(sh$shB)
        #aSH <- ((1-ERRSH)**2)/varSH; bSH <- varSH/(1-ERRSH)
        #ULSH <- 1-qgamma(0.025,shape = aSH, scale = bSH)
        #LLSH <- 1-qgamma(0.975,shape = aSH, scale = bSH)
        
        ERRSM <- 100*(1- mean(sm$smF)/mean(sm$smB))
        #term1SM <- (mean(sm$smF)/mean(sm$smB))**2; term2SM <- ifelse(mean(sm$smF)==0,0,var(sm$smF)/mean(sm$smF)**2); term3SM <- var(sm$smB)/mean(sm$smB)**2
        #term4SM <- ifelse(mean(sm$smF)==0,0,-2*cor(sm$smB,sm$smF)*sqrt(var(sm$smF))*sqrt(var(sm$smB))/(mean(sm$smB)*mean(sm$smF)))
        #VARSM <-  term1SM*(term2SM+term3SM+term4SM); varSM <- VARSM / length(sm$smB)
        #aSM <- ((1-ERRSM)**2)/varSM; bSM <- varSM/(1-ERRSM)
        #ULSM <- 1-qgamma(0.025,shape = aSM, scale = bSM)
        #LLSM <- 1-qgamma(0.975,shape = aSM, scale = bSM)
        if(input$Sdrug == 1){
        shstar <- ifelse(ERRSM>=90, 1, ifelse(ERRSM<80, 3,2))
        smstar <- ifelse(ERRSM>=90, 1, ifelse(ERRSM<80, 3,2))
        if (shstar == 1 & smstar == 2){
        concl <- paste0('The efficacy of the administered drug is satisfactory against both S. haematobium and S. mansoni infections.')
        } else {
          if (shstar == 2 & smstar ==1){
concl <- paste0('The efficacy of the administered drug is satisfactory against S. mansoni infections, but is below the expected efficacy of 90 percent for S. haematobium infections. Please contact World Health Organization (wormcontrol@who.int or Dr. A. Montresor (montresora@who.int)) and its collaborating centre for the monitoring of anthelminthic drug efficacy for soil-transmitted helminthiasis (Dr. B. Levecke: bruno.levecke@ugent.be) to discuss further actions.')
            
          } else {
            if (shstar == 1 & smstar == 2)
            {concl <- paste0('The efficacy of the administered drug is satisfactory against S. mansoni infections, but is below the expected efficacy of 90 percent for S. haematobium infections. Please contact World Health Organization (wormcontrol@who.int or Dr. A. Montresor (montresora@who.int)) and its collaborating centre for the monitoring of anthelminthic drug efficacy for soil-transmitted helminthiasis (Dr. B. Levecke: bruno.levecke@ugent.be) to discuss further actions.')
              
            } else {
              concl <- paste0('The efficacy of the administered drug is below the expected efficacy of 90 percent for both S. mansoni and S. haematobium infections. Please contact World Health Organization (wormcontrol@who.int or Dr. A. Montresor (montresora@who.int)) and its collaborating centre for the monitoring of anthelminthic drug efficacy for soil-transmitted helminthiasis (Dr. B. Levecke: bruno.levecke@ugent.be) to discuss further actions.') 
              }
            }
            }
        
        } else { concl <- paste0('Currently, a expected efficacy has only been defined for a single oral dose of praziquantel (40 mg per kg). Consequently, no conclusions can be drawn on the egg reduction rate observed for this drug or drug regimen.')}
      } else {
        if(mean(data$sh)>-2 & mean(data$shF)>-2){
          data$shB <-  data[,input$Shbas]  
          data$shF <-  data[,input$Shfol]  
          sh <- subset(data, shB >0 &  shF >=0)
          ERRSH <- 100*(1- mean(sh$shF)/mean(sh$shB))
          #term1SH <- (mean(sh$shF)/mean(sh$shB))**2; term2SH <- ifelse(mean(sh$shF)==0,0,var(sh$shF)/mean(sh$shF)**2); term3SH <- var(sh$shB)/mean(sh$shB)**2
          #term4SH <- ifelse(mean(sh$shF)==0,0,-2*cor(sh$shB,sh$shF)*sqrt(var(sh$shF))*sqrt(var(sh$shB))/(mean(sh$shB)*mean(sh$shF)))
          #VARSH <-  term1SH*(term2SH+term3SH+term4SH); varSH <- VARSH / length(sh$shB)
          #aSH <- ((1-ERRSH)**2)/varSH; bSH <- varSH/(1-ERRSH)
          #ULSH <- 1-qgamma(0.025,shape = aSH, scale = bSH)
          #LLSH <- 1-qgamma(0.975,shape = aSH, scale = bSH)
          if(input$Sdrug == 1) {
          shstar <- ifelse(ERRSH>=90, 1, ifelse(ERRSH<80, 3,2))
          if (shstar == 1){
            concl <- paste0('The efficacy of the administered drug is satisfactory against both S. haematobium infections.')
          } else {
            concl <- paste0('The efficacy of the administered drug is below the expected drug efficacy of 90 percent for S. haematobium infections. Please contact World Health Organization (wormcontrol@who.int or Dr. A. Montresor (montresora@who.int)) and its collaborating centre for the monitoring of anthelminthic drug efficacy for soil-transmitted helminthiasis (Dr. B. Levecke: bruno.levecke@ugent.be) to discuss further actions.')
              
          }
          } else {conlc <- paste0('Currently, a expected efficacy has only been defined for a single oral dose of praziquantel (40 mg per kg). Consequently, no conclusions can be drawn on the egg reduction rate observed for this drug or drug regimen.')}
          } else {
          if(mean(data$sm)>-2 & mean(data$smF)>-2){
            data$smB <-  data[,input$Smbas] 
            data$smF <-  data[,input$Smfol] 
            sm <- subset(data, smB >0 &  smF >=0)
            
            ERRSM <- 100*(1- mean(sm$smF)/mean(sm$smB))
            # term1SM <- (mean(sm$smF)/mean(sm$smB))**2; term2SM <- ifelse(mean(sm$smF)==0,0,var(sm$smF)/mean(sm$smF)**2); term3SM <- var(sm$smB)/mean(sm$smB)**2
            #  term4SM <- ifelse(mean(sm$smF)==0,0,-2*cor(sm$smB,sm$smF)*sqrt(var(sm$smF))*sqrt(var(sm$smB))/(mean(sm$smB)*mean(sm$smF)))
            # VARSM <-  term1SM*(term2SM+term3SM+term4SM); varSM <- VARSM / length(sm$smB)
            # aSM <- ((1-ERRSM)**2)/varSM; bSM <- varSM/(1-ERRSM)
            # ULSM <- 1-qgamma(0.025,shape = aSM, scale = bSM)
            # LLSM <- 1-qgamma(0.975,shape = aSM, scale = bSM)
            
            if(input$Sdrug == 1) { 
            smstar <- ifelse(ERRSM>=90, 1, ifelse(ERRSM<80, 3,2))
            if (smstar == 1){
              paste('The efficacy of the administered drug is satisfactory against both S. mansoni infections.')
            } else {
              concl <- paste0('The efficacy of the administered drug is below the expected drug efficacy of 90 percent for S. mansoni infections. Please contact World Health Organization (wormcontrol@who.int or Dr. A. Montresor (montresora@who.int)) and its collaborating centre for the monitoring of anthelminthic drug efficacy for soil-transmitted helminthiasis (Dr. B. Levecke: bruno.levecke@ugent.be) to discuss further actions.')
              
            } 
            } else {concl <- paste0('Currently, a expected efficacy has only been defined for a single oral dose of praziquantel (40 mg per kg). 
                                      Consequently, no conclusions can be drawn on the egg reduction rate observed for this drug or drug regimen.')}
          } else {
            if(mean(data$sj)>-2 & mean(data$sjF>-2)){
              data$sjB <-  data[,input$Sjbas] 
              data$sjF <-  data[,input$Sjfol] 
              sj <- subset(data, sjB >0 &  sjF >=0)
              ERRSJ <- 100*(1- mean(sj$sjF)/mean(sj$sjB))
              #term1SJ <- (mean(sj$sjF)/mean(sj$sjB))**2; term2SJ <- ifelse(mean(sj$sjF)==0,0,var(sj$sjF)/mean(sj$sjF)**2); term3SJ <- var(sj$sjB)/mean(sj$sjB)**2              
              #term4SJ <- ifelse(mean(sj$sjF)==0,0,-2*cor(sj$sjB,sj$sjF)*sqrt(var(sj$sjF))*sqrt(var(sj$sjB))/(mean(sj$sjB)*mean(sj$sjF)))
              #VARSJ <-  term1SJ*(term2SJ+term3SJ+term4SJ); varSJ <- VARSJ / length(sj$sjB)
              #aSJ <- ((1-ERRSJ)**2)/varSJ; bSJ <- varSJ/(1-ERRSJ)
              #ULSJ <- 1-qgamma(0.025,shape = aSJ, scale = bSJ)
              #LLSJ <- 1-qgamma(0.975,shape = aSJ, scale = bSJ)
              if(input$Sdrug == 1) { 
              sjstar <- ifelse(ERRSJ>=90, 1, ifelse(ERRSJ<80, 3,2))
              if (sjstar == 1){
                concl <- paste0('The efficacy of the administered drug is satisfactory against both S. japonicum infections.')
              } else {
                concl <- paste0('The efficacy of the administered drug is below the expected efficacy of 90% for S. japonicum infections. Please contact World Health Organization (wormcontrol@who.int or Dr. A. Montresor (montresora@who.int)) and its collaborating centre for the monitoring of anthelminthic drug efficacy for soil-transmitted helminthiasis (Dr. B. Levecke: bruno.levecke@ugent.be) to discuss further actions.')
                
              } 
              } else {concl <- paste0('Currently, a expected efficacy has only been defined for a single oral dose of praziquantel (40 mg per kg). Consequently, no conclusions can be drawn on the egg reduction rate observed for this drug or drug regimen.')}
            } else {concl <- paste0('Data was not provided.')}  
          }   
          }
        } 
    }
      }
      else {
        # Soil-transmitted helminthiasis
        if (input$NTD=='2')
        {
          data <- read.xlsx(inFile$datapath,1)
          n <- length(data[,1])
          # roundworms
          data$Rb <- ifelse(input$Rbas=='Not recorded',rep(-2,n), ifelse(data[,input$Rbas]>0,1,0))
          data$Rf <- ifelse(input$Rfol=='Not recorded',rep(-2,n), ifelse(data[,input$Rfol]>=0,1,0))
          
          # whipworms
          data$Tb <- ifelse(input$Tbas=='Not recorded',rep(-2,n), ifelse(data[,input$Tbas]>0,1,0))
          data$Tf <- ifelse(input$Tfol=='Not recorded',rep(-2,n), ifelse(data[,input$Tfol]>=0,1,0))
          
          # hookworms
          data$Hb <- ifelse(input$Hbas=='Not recorded',rep(-2,n), ifelse(data[,input$Hbas]>0,1,0))
          data$Hf <- ifelse(input$Hfol=='Not recorded',rep(-2,n), ifelse(data[,input$Hfol]>=0,1,0))
          
          data$inf <- ifelse(data$Rb > -2 | data$Tb > -2 | data$Hb > -2, 1, 0)
          
          if(mean(data$inf)==0) {paste('Data was not provided.')}
          else {
            if(mean(data$Rb)>-2 & mean(data$Tb)>-2 & mean(data$Hb)>-2 & mean(data$Rf)>-2 & mean(data$Tf)>-2 & mean(data$Hf)>-2)
            {
              data$RB <-  data[,input$Rbas]  
              data$TB <-  data[,input$Tbas]
              data$HB <-  data[,input$Hbas] 
              data$RF <-  data[,input$Rfol]  
              data$TF <-  data[,input$Tfol] 
              data$HF <-  data[,input$Hfol] 
              R <- subset(data, RB> 0 & RF >= 0)
              Tr <- subset(data, TB> 0 & TF >= 0)
              H <- subset(data, HB> 0 & HF >= 0)
              
              ERRR <- 100*(1- mean(R$RF)/mean(R$RB))
              #term1R <- (mean(R$RF)/mean(R$RB))**2; term2R <- ifelse(mean(R$RF)==0,0,var(R$RF)/mean(R$RF)**2); term3R <- var(R$RB)/mean(R$RB)**2
              #term4R <- ifelse(mean(R$RF)==0,0,-2*cor(R$RB,R$RF)*sqrt(var(R$RF))*sqrt(var(R$RB))/(mean(R$RB)*mean(R$RF)))
              #VARR <-  term1R*(term2R+term3R+term4R); varR <- VARR / length(R$RB)
              #aR <- ((1-ERRR)**2)/varR; bR <- varR/(1-ERRR)
              #ULR <- 1-qgamma(0.025,shape = aR, scale = bR)
              #LLR <- 1-qgamma(0.975,shape = aR, scale = bR)
              
              ERRT <- 100*(1- mean(Tr$TF)/mean(Tr$TB))
              #term1T <- (mean(Tr$TF)/mean(Tr$TB))**2; term2T <- ifelse(mean(Tr$TF)==0,0,var(Tr$TF)/mean(Tr$TF)**2); term3T <- var(Tr$TB)/mean(Tr$TB)**2
              #term4T <- ifelse(mean(Tr$TF)==0,0,-2*cor(Tr$TB,Tr$TF)*sqrt(var(Tr$TF))*sqrt(var(Tr$TB))/(mean(Tr$TB)*mean(Tr$TF)))
              #VART <-  term1T*(term2T+term3T+term4T); varT <- VART / length(Tr$TB)
              #aT <- ((1-ERRT)**2)/varT; bT <- varT/(1-ERRT)
              #ULT <- 1-qgamma(0.025,shape = aT, scale = bT)
              #LLT <- 1-qgamma(0.975,shape = aT, scale = bT)
              
              ERRH <- 100*(1- mean(H$HF[H$HB>0 & H$HF>=0])/mean(H$HB[H$HB>0 & H$HF>=0]))
              #term1H <- (mean(H$HF)/mean(H$HB))**2; term2H <- ifelse(mean(H$HF)==0,0,var(H$HF)/mean(H$HF)**2); term3H <- var(H$HB)/mean(H$HB)**2
              #term4H <- ifelse(mean(H$HF)==0,0,-2*cor(H$HB,H$HF)*sqrt(var(H$HF))*sqrt(var(H$HB))/(mean(H$HB)*mean(H$HF)))
              #VARH <-  term1H*(term2H+term3H+term4H); varH <- VARH / length(H$HB)
              #aH <- ((1-ERRH)**2)/varH; bH <- varH/(1-ERRH)
              #ULH <- 1-qgamma(0.025,shape = aH, scale = bH)
              #LLH <- 1-qgamma(0.975,shape = aH, scale = bH)
              
              if(input$STHdrug == 1) { 
                rstar<-ifelse(ERRR >=95,1,2)
                tstar<-ifelse(ERRT >=50,1,2)
                hstar<-ifelse(ERRH >=90,1,2)
                if(rstar == 1 & tstar == 2 & hstar == 2){
                  concl <- paste0('The efficacy of the administered drug is satisfactory against roundworms, but is below the expected efficacy for both whipworm (less than 50 percent) and hookworm infections (90%). Please contact World Health Organization (wormcontrol@who.int or Dr. A. Montresor (montresora@who.int)) and its collaborating centre for the monitoring of anthelminthic drug efficacy for soil-transmitted helminthiasis (Dr. B. Levecke: bruno.levecke@ugent.be) to discuss further actions.')
                }  else  { 
                  if(rstar == 2 & tstar == 1 & hstar == 2){
                    concl <- paste0('The efficacy of the administered drug is satisfactory against whipworms, but is below the expected efficacy for both roundworm (less than 95 percent) and hookworm infections (less than 90 percent). Please contact World Health Organization (wormcontrol@who.int or Dr. A. Montresor (montresora@who.int)) and its collaborating centre for the monitoring of anthelminthic drug efficacy for soil-transmitted helminthiasis (Dr. B. Levecke: bruno.levecke@ugent.be) to discuss further actions.')
                  } else {  
                    if(rstar == 2 & tstar == 2 & hstar == 1){
                      concl <- paste0('The efficacy of the administered drug is satisfactory against hookorms, but is below the expeceted efficacy for both roundworm (less than 95 percent) and whipworm infections (less than 50 percent). Please contact World Health Organization (wormcontrol@who.int or Dr. A. Montresor (montresora@who.int)) and its collaborating centre for the monitoring of anthelminthic drug efficacy for soil-transmitted helminthiasis (Dr. B. Levecke: bruno.levecke@ugent.be) to discuss further actions.')
                    } else { 
                      if(rstar == 2 & tstar == 2 & hstar == 2){
                        concl <- paste0('The efficacy of the administered drug is below the expected efficacy for rounworm (less than 95 percent), whipworm (less than 50 percent) and hookworm infections (less than 90 percent). Please contact World Health Organization (wormcontrol@who.int or Dr. A. Montresor (montresora@who.int)) and its collaborating centre for the monitoring of anthelminthic drug efficacy for soil-transmitted helminthiasis (Dr. B. Levecke: bruno.levecke@ugent.be) to discuss further actions.')
                        
                      } else  { 
                          if(rstar == 1 & tstar == 1 & hstar == 2){
                            concl <- paste0('The efficacy of the administered drug is satisfactory against both round- and whipworm infections, but is below the expected efficcacy for hookorm infections (less than 90 percent). Please contact World Health Organization (wormcontrol@who.int or Dr. A. Montresor (montresora@who.int)) and its collaborating centre for the monitoring of anthelminthic drug efficacy for soil-transmitted helminthiasis (Dr. B. Levecke: bruno.levecke@ugent.be) to discuss further actions.')
                        } else  { 
                          if(rstar == 1 & tstar == 2 & hstar == 1){
                            concl <- paste0('The efficacy of the administered drug is satisfactory against both round- and hookworm infections, but is below the expected efficacy for whipworm infections (less than 50 percent). Please contact World Health Organization (wormcontrol@who.int or Dr. A. Montresor (montresora@who.int)) and its collaborating centre for the monitoring of anthelminthic drug efficacy for soil-transmitted helminthiasis (Dr. B. Levecke: bruno.levecke@ugent.be) to discuss further actions.')
                          } else { 
                            if(rstar == 2 & tstar == 1 & hstar == 1){
                              concl <- paste0('The efficacy of the administered drug is satisfactory against both whip- and hookworm infections, but is below the expected efficacy for roundworm infections (less than 95 percent). Please contact World Health Organization (wormcontrol@who.int or Dr. A. Montresor (montresora@who.int)) and its collaborating centre for the monitoring of anthelminthic drug efficacy for soil-transmitted helminthiasis (Dr. B. Levecke: bruno.levecke@ugent.be) to discuss further actions.')
                            } else { 
                              concl <- paste0('The efficacy of the administered drug is satisfactory against round-, whip- and hookworm infections.')
                            
                            }
                        
                          }
                              
                          
                        }
                        }
                      }
                    } 
                }             
                
                
                } else {
                  if(input$STHdrug == 2){
                    rstar<-ifelse(ERRR >=95,1,2)
                    tstar<-ifelse(ERRT >=50,1,2)
                    hstar<-ifelse(ERRH >=70,1,2)
                    if(rstar == 1 & tstar == 2 & hstar == 2){
                      concl <- paste0('The efficacy of the administered drug is satisfactory against roundworms, but is below the expected efficacy for both whipworm (less than 50 percent) and hookworm infections (less than 70 percent). Please contact World Health Organization (wormcontrol@who.int or Dr. A. Montresor (montresora@who.int)) and its collaborating centre for the monitoring of anthelminthic drug efficacy for soil-transmitted helminthiasis (Dr. B. Levecke: bruno.levecke@ugent.be) to discuss further actions.')
                    }  else  { 
                      if(rstar == 2 & tstar == 1 & hstar == 2){
                        concl <- paste0('The efficacy of the administered drug is satisfactory against whipworms, but is below the expected efficacy for both roundworm (less than 95 percent) and hookworm infections (less than 70 percent). Please contact World Health Organization (wormcontrol@who.int or Dr. A. Montresor (montresora@who.int)) and its collaborating centre for the monitoring of anthelminthic drug efficacy for soil-transmitted helminthiasis (Dr. B. Levecke: bruno.levecke@ugent.be) to discuss further actions.')
                      } else {  
                        if(rstar == 2 & tstar == 2 & hstar == 1){
                          concl <- paste0('The efficacy of the administered drug is satisfactory against hookorms, but is below the expeceted efficacy for both roundworm (less than 95 percent) and whipworm infections (less than 50 percent). Please contact World Health Organization (wormcontrol@who.int or Dr. A. Montresor (montresora@who.int)) and its collaborating centre for the monitoring of anthelminthic drug efficacy for soil-transmitted helminthiasis (Dr. B. Levecke: bruno.levecke@ugent.be) to discuss further actions.')
                        } else { 
                          if(rstar == 2 & tstar == 2 & hstar == 2){
                            concl <- paste0('The efficacy of the administered drug is below the expected efficacy for rounworm (less than 95 percent), whipworm (less than 50 percent) and hookworm infections (less than 70 percent). Please contact World Health Organization (wormcontrol@who.int or Dr. A. Montresor (montresora@who.int)) and its collaborating centre for the monitoring of anthelminthic drug efficacy for soil-transmitted helminthiasis (Dr. B. Levecke: bruno.levecke@ugent.be) to discuss further actions.')
                            
                          } else  { 
                            if(rstar == 1 & tstar == 1 & hstar == 2){
                              concl <- paste0('The efficacy of the administered drug is satisfactory against both round- and whipworm infections, but is below the expected efficcacy for hookorm infections (less than 70 percent). Please contact World Health Organization (wormcontrol@who.int or Dr. A. Montresor (montresora@who.int)) and its collaborating centre for the monitoring of anthelminthic drug efficacy for soil-transmitted helminthiasis (Dr. B. Levecke: bruno.levecke@ugent.be) to discuss further actions.')
                            } else  { 
                              if(rstar == 1 & tstar == 2 & hstar == 1){
                                concl <- paste0('The efficacy of the administered drug is satisfactory against both round- and hookworm infections, but is below the expected efficacy for whipworm infections (less than 50 percent). Please contact World Health Organization (wormcontrol@who.int or Dr. A. Montresor (montresora@who.int)) and its collaborating centre for the monitoring of anthelminthic drug efficacy for soil-transmitted helminthiasis (Dr. B. Levecke: bruno.levecke@ugent.be) to discuss further actions.')
                              } else { 
                                if(rstar == 2 & tstar == 1 & hstar == 1){
                                  concl <- paste0('The efficacy of the administered drug is satisfactory against both whip- and hookworm infections, but is below the expected efficacy for roundworm infections (less than 95 percent). Please contact World Health Organization (wormcontrol@who.int or Dr. A. Montresor (montresora@who.int)) and its collaborating centre for the monitoring of anthelminthic drug efficacy for soil-transmitted helminthiasis (Dr. B. Levecke: bruno.levecke@ugent.be) to discuss further actions.')
                                } else { 
                                  conlc <- paste0('The efficacy of the administered drug is satisfactory against round-, whip- and hookworm infections.')
                                  
                                }
                                
                              }
                              
                              
                          }
                          }
                        }
                      } 
                }  
                     
                   ## new drug 
                  } else {concl <- paste0('Currently, the expected efficacy has only been determined for a single oral dose of albendazole (400 mg) and mebendazole (500 mg). Consequently, no conclusions can be drawn on the egg reduction rate observed for this drug or drug regimen.')}
                  
                }
              # end
              }
            else{ 
              if(mean(data$Rb)>-2 & mean(data$Tb)>-2 & mean(data$Rf)>-2 & mean(data$Tf)>-2)
              {
                data$RB <-  data[,input$Rbas]  
                data$TB <-  data[,input$Tbas]
                data$RF <-  data[,input$Rfol]  
                data$TF <-  data[,input$Tfol] 
                R <- subset(data, RB> 0 & RF >= 0)
                Tr <- subset(data, TB> 0 & TF >= 0)
                
                ERRR <- 100*(1- mean(R$RF)/mean(R$RB))
                #term1R <- (mean(R$RF)/mean(R$RB))**2; term2R <- ifelse(mean(R$RF)==0,0,var(R$RF)/mean(R$RF)**2); term3R <- var(R$RB)/mean(R$RB)**2
                #term4R <- ifelse(mean(R$RF)==0,0,-2*cor(R$RB,R$RF)*sqrt(var(R$RF))*sqrt(var(R$RB))/(mean(R$RB)*mean(R$RF)))
                #VARR <-  term1R*(term2R+term3R+term4R); varR <- VARR / length(R$RB)
                #aR <- ((1-ERRR)**2)/varR; bR <- varR/(1-ERRR)
                #ULR <- 1-qgamma(0.025,shape = aR, scale = bR)
                #LLR <- 1-qgamma(0.975,shape = aR, scale = bR)
                
                ERRT <- 100*(1- mean(Tr$TF)/mean(Tr$TB))
                #term1T <- (mean(Tr$TF)/mean(Tr$TB))**2; term2T <- ifelse(mean(Tr$TF)==0,0,var(Tr$TF)/mean(Tr$TF)**2); term3T <- var(Tr$TB)/mean(Tr$TB)**2
                #term4T <- ifelse(mean(Tr$TF)==0,0,-2*cor(Tr$TB,Tr$TF)*sqrt(var(Tr$TF))*sqrt(var(Tr$TB))/(mean(Tr$TB)*mean(Tr$TF)))
                #VART <-  term1T*(term2T+term3T+term4T); varT <- VART / length(Tr$TB)
                #aT <- ((1-ERRT)**2)/varT; bT <- varT/(1-ERRT)
                #ULT <- 1-qgamma(0.025,shape = aT, scale = bT)
                #LLT <- 1-qgamma(0.975,shape = aT, scale = bT)
                
                if(input$STHdrug == 1 | input$STHdrug ==2)
                { 
                rstar <-ifelse(ERRR >= 95,1,2)
                tstar <- ifelse(ERRT >=50,1,2)
                
                if(rstar == 1 & tstar == 1){
                concl <- paste0('The efficacy of the administered drug is satisfactory for both round- and whipworm infections.')
                } else {
                if(rstar == 1 & tstar == 2) {
                  concl <- paste0('The efficacy of the administered drug is satisfactory against roundworm infections, but is below the expected efficacy for wipwworm infections (less than 50 percent). Please contact World Health Organization (wormcontrol@who.int or Dr. A. Montresor (montresora@who.int)) and its collaborating centre for the monitoring of anthelminthic drug efficacy for soil-transmitted helminthiasis (Dr. B. Levecke: bruno.levecke@ugent.be) to discuss further actions.')
                  
                } else  {
                  if(rstar == 2 & tstar == 1) {
                    concl <- paste0('The efficacy of the administered drug is satisfactory against whipworms infections, but is below the expected efficacy for roundworm infections (less than 95 percent). Please contact World Health Organization (wormcontrol@who.int or Dr. A. Montresor (montresora@who.int)) and its collaborating centre for the monitoring of anthelminthic drug efficacy for soil-transmitted helminthiasis (Dr. B. Levecke: bruno.levecke@ugent.be) to discuss further actions.')
                    
                  } else  {
                    if(rstar == 2 & tstar == 2) {
                     concl <- paste0('The efficacy of the administered drug is below the expected efficacy for both roundworm (less than 95 percent) and whipworms infections (less than 50 percent). Please contact World Health Organization (wormcontrol@who.int or Dr. A. Montresor (montresora@who.int)) and its collaborating centre for the monitoring of anthelminthic drug efficacy for soil-transmitted helminthiasis (Dr. B. Levecke: bruno.levecke@ugent.be) to discuss further actions.')
                      
                    }
                  }
                }
                }
                } else {concl <- paste0('Currently, the expected efficacy has only been determined for a single oral dose of albendazole (400 mg) and mebendazole (500 mg). Consequently, no conclusions can be drawn on the egg reduction rate observed for this drug or drug regimen.')
                }
                } else{
                if(mean(data$Rb)>-2 & mean(data$Hb)>-2 & mean(data$Rf)>-2 & mean(data$Hf)>-2)
                {
                  data$RB <-  data[,input$Rbas]  
                  data$HB <-  data[,input$Hbas] 
                  data$RF <-  data[,input$Rfol]  
                  data$HF <-  data[,input$Hfol] 
                  R <- subset(data, RB> 0 & RF >= 0)
                  H <- subset(data, HB> 0 & HF >= 0)
                  
                  ERRR <- 100*(1- mean(R$RF)/mean(R$RB))
                  #term1R <- (mean(R$RF)/mean(R$RB))**2; term2R <- ifelse(mean(R$RF)==0,0,var(R$RF)/mean(R$RF)**2); term3R <- var(R$RB)/mean(R$RB)**2
                  #term4R <- ifelse(mean(R$RF)==0,0,-2*cor(R$RB,R$RF)*sqrt(var(R$RF))*sqrt(var(R$RB))/(mean(R$RB)*mean(R$RF)))
                  #VARR <-  term1R*(term2R+term3R+term4R); varR <- VARR / length(R$RB)
                  #aR <- ((1-ERRR)**2)/varR; bR <- varR/(1-ERRR)
                  #ULR <- 1-qgamma(0.025,shape = aR, scale = bR)
                  #LLR <- 1-qgamma(0.975,shape = aR, scale = bR)
                  
                  ERRH <- 100*(1- mean(H$HF[H$HB>0 & H$HF>=0])/mean(H$HB[H$HB>0 & H$HF>=0]))
                  #term1H <- (mean(H$HF)/mean(H$HB))**2; term2H <- ifelse(mean(H$HF)==0,0,var(H$HF)/mean(H$HF)**2); term3H <- var(H$HB)/mean(H$HB)**2
                  #term4H <- ifelse(mean(H$HF)==0,0,-2*cor(H$HB,H$HF)*sqrt(var(H$HF))*sqrt(var(H$HB))/(mean(H$HB)*mean(H$HF)))
                  #VARH <-  term1H*(term2H+term3H+term4H); varH <- VARH / length(H$HB)
                  #aH <- ((1-ERRH)**2)/varH; bH <- varH/(1-ERRH)
                  #ULH <- 1-qgamma(0.025,shape = aH, scale = bH)
                  #LLH <- 1-qgamma(0.975,shape = aH, scale = bH)   
                  
                  if(input$STHdrug == 1) { 
                    rstar<-ifelse(ERRR >=95,1,2)
                    hstar<-ifelse(ERRH >=90,1,2)
                    if(rstar == 1 & hstar == 2){
                      concl <- paste0('The efficacy of the administered drug is satisfactory against roundworm infections, but is below the expected efficacy hookworm infections (less than 90 percent). Please contact World Health Organization (wormcontrol@who.int or Dr. A. Montresor (montresora@who.int)) and its collaborating centre for the monitoring of anthelminthic drug efficacy for soil-transmitted helminthiasis (Dr. B. Levecke: bruno.levecke@ugent.be) to discuss further actions.')
                    }  else  { 
                      if(rstar == 2 & hstar == 1){
                        concl <- paste0('The efficacy of the administered drug is satisfactory against hookworm infections, but is below the expected efficacy for roundworm infection (less than 95 percent). Please contact World Health Organization (wormcontrol@who.int or Dr. A. Montresor (montresora@who.int)) and its collaborating centre for the monitoring of anthelminthic drug efficacy for soil-transmitted helminthiasis (Dr. B. Levecke: bruno.levecke@ugent.be) to discuss further actions.')
                      } else {  
                        if(rstar == 2 & hstar == 2){
                          concl <- paste0('The efficacy of the administered drug is below the expected efficacy for both roundworm (less than 95 percent) and hookworm infections (less than 90 percent). Please contact World Health Organization (wormcontrol@who.int or Dr. A. Montresor (montresora@who.int)) and its collaborating centre for the monitoring of anthelminthic drug efficacy for soil-transmitted helminthiasis (Dr. B. Levecke: bruno.levecke@ugent.be) to discuss further actions.')
                        } else { 
                          if(rstar == 1 & hstar == 1){
                            concl <- paste0('The efficacy of the administered drug is satisfactory for both roundworm and hookworm infections.')
                                }
                                
                              }
                          }
                          }
                        
                } else {
                  if(input$STHdrug == 2){
                    rstar<-ifelse(ERRR >=95,1,2)
                    hstar<-ifelse(ERRH >=70,1,2)
                    if(rstar == 1 & hstar == 2){
                      concl <- paste0('The efficacy of the administered drug is satisfactory against roundworm infections, but is below the expected efficacy hookworm infections (less than 70 percent). Please contact World Health Organization (wormcontrol@who.int or Dr. A. Montresor (montresora@who.int)) and its collaborating centre for the monitoring of anthelminthic drug efficacy for soil-transmitted helminthiasis (Dr. B. Levecke: bruno.levecke@ugent.be) to discuss further actions.')
                    }  else  { 
                      if(rstar == 2 & hstar == 1){
                        concl <- paste0('The efficacy of the administered drug is satisfactory against hookworm infections, but is below the expected efficacy for roundworm infection (less than 95 percent). Please contact World Health Organization (wormcontrol@who.int or Dr. A. Montresor (montresora@who.int)) and its collaborating centre for the monitoring of anthelminthic drug efficacy for soil-transmitted helminthiasis (Dr. B. Levecke: bruno.levecke@ugent.be) to discuss further actions.')
                      } else {  
                        if(rstar == 2 & hstar == 2){
                          concl <- paste0('The efficacy of the administered drug is below the expected efficacy for both roundworm (less than 95 percent) and hookworm infections (less than 70 percent). Please contact World Health Organization (wormcontrol@who.int or Dr. A. Montresor (montresora@who.int)) and its collaborating centre for the monitoring of anthelminthic drug efficacy for soil-transmitted helminthiasis (Dr. B. Levecke: bruno.levecke@ugent.be) to discuss further actions.')
                        } else { 
                          if(rstar == 1 & hstar == 1){
                            concl <- paste0('The efficacy of the administered drug is satisfactory for both roundworm and hookworm infections.')
                          }
                          
                        }
                    }
                  }
                    
                    ## new drug 
                  } else {concl <- paste0('Currently, the expected efficacy has only been determined for a single oral dose of albendazole (400 mg) and mebendazole (500 mg). Consequently, no conclusions can be drawn on the egg reduction rate observed for this drug or drug regimen.')}
                  
                    } 
                  
                  } else{
                  if(mean(data$Tb)>-2 & mean(data$Hb)>-2 & mean(data$Tf)>-2 & mean(data$Hf)>-2)
                  {
                    data$TB <-  data[,input$Tbas]
                    data$HB <-  data[,input$Hbas] 
                    data$TF <-  data[,input$Tfol] 
                    data$HF <-  data[,input$Hfol] 
                    Tr <- subset(data, TB> 0 & TF >= 0)
                    H <- subset(data, HB> 0 & HF >= 0)
                    
                    ERRT <- 100*(1- mean(Tr$TF)/mean(Tr$TB))
                    #term1T <- (mean(Tr$TF)/mean(Tr$TB))**2; term2T <- ifelse(mean(Tr$TF)==0,0,var(Tr$TF)/mean(Tr$TF)**2); term3T <- var(Tr$TB)/mean(Tr$TB)**2
                    #term4T <- ifelse(mean(Tr$TF)==0,0,-2*cor(Tr$TB,Tr$TF)*sqrt(var(Tr$TF))*sqrt(var(Tr$TB))/(mean(Tr$TB)*mean(Tr$TF)))
                    #VART <-  term1T*(term2T+term3T+term4T); varT <- VART / length(Tr$TB)
                    #aT <- ((1-ERRT)**2)/varT; bT <- varT/(1-ERRT)
                    #ULT <- 1-qgamma(0.025,shape = aT, scale = bT)
                    #LLT <- 1-qgamma(0.975,shape = aT, scale = bT)
                    
                    ERRH <- 100*(1- mean(H$HF[H$HB>0 & H$HF>=0])/mean(H$HB[H$HB>0 & H$HF>=0]))
                    #term1H <- (mean(H$HF)/mean(H$HB))**2; term2H <- ifelse(mean(H$HF)==0,0,var(H$HF)/mean(H$HF)**2); term3H <- var(H$HB)/mean(H$HB)**2
                    #term4H <- ifelse(mean(H$HF)==0,0,-2*cor(H$HB,H$HF)*sqrt(var(H$HF))*sqrt(var(H$HB))/(mean(H$HB)*mean(H$HF)))
                    #VARH <-  term1H*(term2H+term3H+term4H); varH <- VARH / length(H$HB)
                    #aH <- ((1-ERRH)**2)/varH; bH <- varH/(1-ERRH)
                    #ULH <- 1-qgamma(0.025,shape = aH, scale = bH)
                    #LLH <- 1-qgamma(0.975,shape = aH, scale = bH)
                    
                    
                    if(input$STHdrug == 1) { 
                      tstar<-ifelse(ERRT >=50,1,2)
                      hstar<-ifelse(ERRH >=90,1,2)
                      if(tstar == 1 & hstar == 2){
                        concl <- paste0('The efficacy of the administered drug is satisfactory against whipworm infections, but is below the expected efficacy hookworm infections (less than 90 percent). Please contact World Health Organization (wormcontrol@who.int or Dr. A. Montresor (montresora@who.int)) and its collaborating centre for the monitoring of anthelminthic drug efficacy for soil-transmitted helminthiasis (Dr. B. Levecke: bruno.levecke@ugent.be) to discuss further actions.')
                      }  else  { 
                        if(tstar == 2 & hstar == 1){
                          concl <- paste0('The efficacy of the administered drug is satisfactory against hookworm infections, but is below the expected efficacy for whipworm infection (less than 50 percent). Please contact World Health Organization (wormcontrol@who.int or Dr. A. Montresor (montresora@who.int)) and its collaborating centre for the monitoring of anthelminthic drug efficacy for soil-transmitted helminthiasis (Dr. B. Levecke: bruno.levecke@ugent.be) to discuss further actions.')
                        } else {  
                          if(tstar == 2 & hstar == 2){
                            concl <- paste0('The efficacy of the administered drug is below the expected efficacy for both whipwworm (less than 50 percent) and hookworm infections (less than 90 percent). Please contact World Health Organization (wormcontrol@who.int or Dr. A. Montresor (montresora@who.int)) and its collaborating centre for the monitoring of anthelminthic drug efficacy for soil-transmitted helminthiasis (Dr. B. Levecke: bruno.levecke@ugent.be) to discuss further actions.')
                          } else { 
                            if(tstar == 1 & hstar == 1){
                              concl <- paste0('The efficacy of the administered drug is satisfactory for both whipworm and hookworm infections.')
                            }
                            
                          }
                      }
                    }
                      
                      } else {
                        if(input$STHdrug == 2){
                          tstar<-ifelse(ERRR >=50,1,2)
                          hstar<-ifelse(ERRH >=70,1,2)
                          if(tstar == 1 & hstar == 2){
                            concl <- paste0('The efficacy of the administered drug is satisfactory against whipworm infections, but is below the expected efficacy hookworm infections (less than 70 percent). Please contact World Health Organization (wormcontrol@who.int or Dr. A. Montresor (montresora@who.int)) and its collaborating centre for the monitoring of anthelminthic drug efficacy for soil-transmitted helminthiasis (Dr. B. Levecke: bruno.levecke@ugent.be) to discuss further actions.')
                          }  else  { 
                            if(tstar == 2 & hstar == 1){
                              concl <- paste0('The efficacy of the administered drug is satisfactory against hookworm infections, but is below the expected efficacy for whipworm infection (less than 50 percent). Please contact World Health Organization (wormcontrol@who.int or Dr. A. Montresor (montresora@who.int)) and its collaborating centre for the monitoring of anthelminthic drug efficacy for soil-transmitted helminthiasis (Dr. B. Levecke: bruno.levecke@ugent.be) to discuss further actions.')
                            } else {  
                              if(tstar == 2 & hstar == 2){
                                concl <- paste0('The efficacy of the administered drug is below the expected efficacy for both whipworm (less than 50 percent) and hookworm infections (less than 70 percent). Please contact World Health Organization (wormcontrol@who.int or Dr. A. Montresor (montresora@who.int)) and its collaborating centre for the monitoring of anthelminthic drug efficacy for soil-transmitted helminthiasis (Dr. B. Levecke: bruno.levecke@ugent.be) to discuss further actions.')
                              } else { 
                                if(tstar == 1 & hstar == 1){
                                  concl <- paste0('The efficacy of the administered drug is satisfactory for both whipworm and hookworm infections.')
                                }
                                
                              }
                          }
                        }
                          
                          ## new drug 
                        } else {concl <- paste0('Currently, the expected efficacy has only been determined for a single oral dose of albendazole (400 mg) and mebendazole (500 mg). Consequently, no conclusions can be drawn on the egg reduction rate observed for this drug or drug regimen.')}
                        
                      } 
                  
                    
                    } else{
                    if(mean(data$Rb)>-2 & mean(data$Rf)>-2)
                    {
                      data$RB <-  data[,input$Rbas]  
                      data$RF <-  data[,input$Rfol]  
                      R <- subset(data, RB> 0 & RF >= 0)
                      
                      ERRR <- 100*(1- mean(R$RF)/mean(R$RB))
                      #term1R <- (mean(R$RF)/mean(R$RB))**2; term2R <- ifelse(mean(R$RF)==0,0,var(R$RF)/mean(R$RF)**2); term3R <- var(R$RB)/mean(R$RB)**2
                      #term4R <- ifelse(mean(R$RF)==0,0,-2*cor(R$RB,R$RF)*sqrt(var(R$RF))*sqrt(var(R$RB))/(mean(R$RB)*mean(R$RF)))
                      #VARR <-  term1R*(term2R+term3R+term4R); varR <- VARR / length(R$RB)
                      #aR <- ((1-ERRR)**2)/varR; bR <- varR/(1-ERRR)
                      #ULR <- 1-qgamma(0.025,shape = aR, scale = bR)
                      #LLR <- 1-qgamma(0.975,shape = aR, scale = bR)
                      
                      if(input$STHdrug == 1 | input$STHdrug == 2)
                      {
                      rstar <- ifelse(ERRR>=95,1,2)
                      if(rstar == 1) {
                      paste('The efficacy of the administered drug is satisfactory.')  
                      } else {
                        concl <- paste0('The efficacy of the administered drug is below the expected efficacy for roundworm infections (less than 95 percent). Please contact World Health Organization (wormcontrol@who.int or Dr. A. Montresor (montresora@who.int)) and its collaborating centre for the monitoring of anthelminthic drug efficacy for soil-transmitted helminthiasis (Dr. B. Levecke: bruno.levecke@ugent.be) to discuss further actions.')
                      }
                      } else {concl <- paste0('Currently, the expected efficacy has only been determined for a single oral dose of albendazole (400 mg) and mebendazole (500 mg). Consequently, no conclusions can be drawn on the egg reduction rate observed for this drug or drug regimen.')}
                      
                      } else {
                      if(mean(data$Tb)>-2 & mean(data$Tf)>-2)
                      {
                        data$TB <-  data[,input$Tbas]
                        data$TF <-  data[,input$Tfol] 
                        Tr <- subset(data, TB> 0 & TF >= 0)
                        
                        ERRT <- 100*(1- mean(Tr$TF)/mean(Tr$TB))
                        #term1T <- (mean(Tr$TF)/mean(Tr$TB))**2; term2T <- ifelse(mean(Tr$TF)==0,0,var(Tr$TF)/mean(Tr$TF)**2); term3T <- var(Tr$TB)/mean(Tr$TB)**2
                        #term4T <- ifelse(mean(Tr$TF)==0,0,-2*cor(Tr$TB,Tr$TF)*sqrt(var(Tr$TF))*sqrt(var(Tr$TB))/(mean(Tr$TB)*mean(Tr$TF)))
                        #VART <-  term1T*(term2T+term3T+term4T); varT <- VART / length(Tr$TB)
                        #aT <- ((1-ERRT)**2)/varT; bT <- varT/(1-ERRT)
                        #ULT <- 1-qgamma(0.025,shape = aT, scale = bT)
                        #LLT <- 1-qgamma(0.975,shape = aT, scale = bT)
                        
                        if(input$STHdrug == 1 | input$STHdrug == 2)
                        { 
                        tstar <- ifelse(ERRR>=50,1,2)
                        if(tstar == 1) {
                          concl <- paste0('The efficacy of the administered drug is satisfactory for whipworm infections.')  
                        } else {
                          concl <- paste0('The efficacy of the administered drug is below the expected efficacy for whipworm infections (less than 50 percent). Please contact World Health Organization (wormcontrol@who.int or Dr. A. Montresor (montresora@who.int)) and its collaborating centre for the monitoring of anthelminthic drug efficacy for soil-transmitted helminthiasis (Dr. B. Levecke: bruno.levecke@ugent.be) to discuss further actions.')
                        }
                        } else {concl <- paste0('Currently, the expected efficacy is only determined for a single oral dose of albendazole (400 mg) and mebendazole (500 mg). Consequently, no conclusions can be drawn on the  egg reduction rate observed for this drug or drug regimen.')}
                        
                        } else{
                        if(mean(data$Hb)>-2 & mean(data$Hf)>-2)
                        {
                          data$HB <-  data[,input$Hbas] 
                          data$HF <-  data[,input$Hfol] 
                          H <- subset(data, HB> 0 & HF >= 0)
                          
                          ERRH <- 100*(1- mean(H$HF[H$HB>0 & H$HF>=0])/mean(H$HB[H$HB>0 & H$HF>=0]))
                          #term1H <- (mean(H$HF)/mean(H$HB))**2; term2H <- ifelse(mean(H$HF)==0,0,var(H$HF)/mean(H$HF)**2); term3H <- var(H$HB)/mean(H$HB)**2
                          #term4H <- ifelse(mean(H$HF)==0,0,-2*cor(H$HB,H$HF)*sqrt(var(H$HF))*sqrt(var(H$HB))/(mean(H$HB)*mean(H$HF)))
                          #VARH <-  term1H*(term2H+term3H+term4H); varH <- VARH / length(H$HB)
                          #aH <- ((1-ERRH)**2)/varH; bH <- varH/(1-ERRH)
                          #ULH <- 1-qgamma(0.025,shape = aH, scale = bH)
                          #LLH <- 1-qgamma(0.975,shape = aH, scale = bH)  
                          
                          if(input$STHdrug == 1) { 
                            hstar<-ifelse(ERRH >=90,1,2)
                            if(hstar == 2){
                              concl <- paste0('The efficacy of the administered drug is below the expected efficacy hookworm infections (less than 90 percent). Please contact World Health Organization (wormcontrol@who.int or Dr. A. Montresor (montresora@who.int)) and its collaborating centre for the monitoring of anthelminthic drug efficacy for soil-transmitted helminthiasis (Dr. B. Levecke: bruno.levecke@ugent.be) to discuss further actions.')
                            }  else  { 
                              if(hstar == 1){
                                concl <- paste0('The efficacy of the administered drug is satisfactory against hookworm infections.')
                                        } 
                                    }
                            } else {
                              if(STHdrug == 2){
                                hstar<-ifelse(ERRH >=70,1,2)
                                if(hstar == 2){
                                  concl <- paste0('The efficacy of the administered drug is below the expected efficacy hookworm infections (less than 70 percent). Please contact World Health Organization (wormcontrol@who.int or Dr. A. Montresor (montresora@who.int)) and its collaborating centre for the monitoring of anthelminthic drug efficacy for soil-transmitted helminthiasis (Dr. B. Levecke: bruno.levecke@ugent.be) to discuss further actions.')
                                }  else  { 
                                  if(hstar == 1){
                                    concl <- paste0('The efficacy of the administered drug is satisfactory against hookworm infections.')
                                  }    
                                }
                              
                                
                                ## new drug 
                              } else {concl <- paste('Currently, the expected efficacy has only been determined for a single oral dose of albendazole (400 mg) and mebendazole (500 mg). Consequenlty, no conclusions can be drawn on the egg reduction rate observed for this drug or drug regimen.')}
                              
                            } 
                          
                          }
                        
                        else{concl <- paste0('Data was not provided.')}
                        }
                      }
                  }  
                    }   
                }
              } 
          }
  }
        }
} 

@
\Sexpr{concl}

\end{document}

